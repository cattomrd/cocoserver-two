{% extends "base.html" %}

{% block title %}
    {% if playlist %}
        Lista: {{ playlist.title }}
    {% else %}
        Nueva Lista de Reproducci√≥n
    {% endif %}
{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="/static/css/playlist_detail.css">
<style>
/* Estilos espec√≠ficos para playlist detail */
.truncate-text {
    overflow: hidden;
    text-overflow: ellipsis;
    display: -webkit-box;
    -webkit-line-clamp: 2;
    line-clamp: 2;
    -webkit-box-orient: vertical;
}

.cursor-pointer { cursor: pointer; }
.cursor-grab { cursor: grab; }
.user-select-none { user-select: none; }

/* Estilos para los paneles principales */
.main-panel {
    background-color: #ffffff;
    border: 1px solid #dee2e6;
    border-radius: 0.5rem;
    box-shadow: 0 0.125rem 0.25rem rgba(0, 0, 0, 0.075);
    overflow: hidden;
    margin-bottom: 1.5rem;
}

.panel-header {
    padding: 1rem;
    border-bottom: 1px solid rgba(0, 0, 0, 0.1);
}

.panel-body {
    padding: 1.5rem;
    background-color: #ffffff;
}

/* Elementos de video */
.playlist-video-item {
    background-color: #032833c7;
    border: 1px solid #000307;
    border-radius: 0.5rem;
    padding: 0.75rem;
    margin-bottom: 0.75rem;
    transition: all 0.2s ease;
}

.playlist-video-item:hover {
    border-color: #0d6efd;
    box-shadow: 0 0.125rem 0.25rem rgba(0, 0, 0, 0.075);
}

.video-handle {
    cursor: move;
    padding: 0.5rem;
    color: #6c757d;
}

.video-handle:hover {
    color: #0d6efd;
}

.video-position {
    display: inline-block;
    width: 2rem;
    height: 2rem;
    line-height: 2rem;
    text-align: center;
    background-color: #e9ecef;
    border-radius: 50%;
    font-weight: bold;
}

/* Biblioteca de videos */
#availableVideosList {
    max-height: 450px;
    overflow-y: auto;
    padding-right: 5px;
}

.available-video-item {
    background-color: #032833c7;
    border: 1px solid #000307;
    border-radius: 0.5rem;
    padding: 0.75rem;
    margin-bottom: 0.5rem;
    transition: all 0.2s ease;
}

.available-video-item:hover {
    background-color: #241264;
}

/* Tarjetas de estad√≠sticas */
.stat-card {
    background: white;
    padding: 1.5rem;
    border-radius: 0.5rem;
    text-align: center;
    box-shadow: 0 0.125rem 0.25rem rgba(0, 0, 0, 0.075);
    transition: all 0.15s ease-in-out;
    border: 1px solid rgba(0, 0, 0, 0.1);
}

.stat-card:hover {
    transform: translateY(-2px);
    box-shadow: 0 0.5rem 1rem rgba(0, 0, 0, 0.15);
}

.stat-value {
    font-size: 2.5rem;
    font-weight: 700;
    color: #0d6efd;
    margin-bottom: 0.5rem;
}

.stat-label {
    color: #6c757d;
    font-size: 0.9rem;
    font-weight: 500;
    text-transform: uppercase;
    letter-spacing: 0.5px;
}

/* Soporte para modo edici√≥n */
.edit-mode .edit-action {
    display: inline-flex !important;
}

.edit-mode .playlist-form-control {
    background-color: #fff;
}

/* Indicador de cambios sin guardar */
.unsaved-changes {
    border-left: 4px solid #ffc107 !important;
    background-color: #fff3cd !important;
}

/* Efecto de pulsaci√≥n para bot√≥n guardar */
.btn-pulse {
    animation: pulse 2s infinite;
}

@keyframes pulse {
    0% { transform: scale(1); }
    50% { transform: scale(1.05); }
    100% { transform: scale(1); }
}

@keyframes spin {
    0% { transform: rotate(0deg); }
    100% { transform: rotate(360deg); }
}

/* Spinner personalizado para badges */
.loading-spinner {
    display: inline-block;
    width: 12px;
    height: 12px;
    border: 2px solid #ffffff;
    border-top: 2px solid transparent;
    border-radius: 50%;
    animation: spin 1s linear infinite;
}

/* Scrollbars personalizados */
::-webkit-scrollbar {
    width: 8px;
    height: 8px;
}

::-webkit-scrollbar-track {
    background: #f1f1f1;
    border-radius: 4px;
}

::-webkit-scrollbar-thumb {
    background: #c1c1c1;
    border-radius: 4px;
}

::-webkit-scrollbar-thumb:hover {
    background: #a8a8a8;
}

/* Mejoras para reproductor de video */
.video-preview-container {
    position: relative;
    width: 100%;
    background-color: #000;
    border-radius: 8px;
    overflow: hidden;
}

#previewVideoPlayer {
    width: 100%;
    max-height: 70vh;
    border-radius: 8px;
}

/* ESTILOS CORREGIDOS PARA EL MODAL DE ASIGNACI√ìN */
#assignDeviceModal .table-responsive {
    border: 1px solid #dee2e6;
    border-radius: 0.375rem;
}

#assignDeviceModal .table thead th {
    background-color: #f8f9fa !important;
    border-bottom: 2px solid #dee2e6;
    font-weight: 600;
    color: #495057;
    position: sticky;
    top: 0;
    z-index: 10;
}

#assignDeviceModal .table tbody tr {
    transition: all 0.15s ease-in-out;
}

#assignDeviceModal .table tbody tr:hover {
    background-color: rgba(13, 110, 253, 0.05);
}

#assignDeviceModal .table-active {
    background-color: rgba(13, 110, 253, 0.1) !important;
}

#assignDeviceModal .pending-changes {
    background-color: rgba(255, 193, 7, 0.1) !important;
    border-left: 4px solid #ffc107;
}

#assignDeviceModal .form-check-input {
    width: 1.2em;
    height: 1.2em;
}

#assignDeviceModal .form-check-input:checked {
    background-color: #0d6efd;
    border-color: #0d6efd;
}

#assignDeviceModal .badge {
    font-size: 0.75rem;
    padding: 0.4em 0.8em;
}

#assignDeviceModal .spinner-border-sm {
    width: 1rem;
    height: 1rem;
}

/* Responsive para el modal */
@media (max-width: 768px) {
    #assignDeviceModal .modal-dialog {
        max-width: 95%;
        margin: 1rem auto;
    }
    
    #assignDeviceModal .table-responsive {
        max-height: 300px;
    }
    
    #assignDeviceModal .btn-group {
        display: flex;
        flex-wrap: wrap;
    }
    
    #assignDeviceModal .btn-group .btn {
        flex: 1;
        margin-bottom: 0.25rem;
    }
}
</style>
{% endblock %}

{% block content %}
<!-- Datos de playlist para JavaScript -->
{% if playlist %}
<script type="application/json" id="playlist-data">
{
    "id": {{ playlist.id }},
    "title": "{{ playlist.title | safe }}",
    "description": "{{ playlist.description | safe if playlist.description else '' }}",
    "creation_date": "{{ playlist.creation_date.isoformat() if playlist.creation_date else '' }}",
    "updated_at": "{{ playlist.updated_at.isoformat() if playlist.updated_at else '' }}",
    "start_date": "{{ playlist.start_date.isoformat() if playlist.start_date else '' }}",
    "expiration_date": "{{ playlist.expiration_date.isoformat() if playlist.expiration_date else '' }}",
    "is_active": {{ playlist.is_active | lower }},
    "videos": [
        {% for pv in playlist.playlist_videos %}
        {
            "id": {{ pv.video.id }},
            "title": "{{ pv.video.title | safe }}",
            "description": "{{ pv.video.description | safe if pv.video.description else '' }}",
            "file_path": "{{ pv.video.file_path | safe }}",
            "duration": {{ pv.video.duration or 0 }},
            "position": {{ pv.position or 0 }},
            "order": {{ pv.position or 0 }}
        }{% if not loop.last %},{% endif %}
        {% endfor %}
    ]
}
</script>
<input type="hidden" id="playlist-id" value="{{ playlist.id }}">
{% endif %}

<!-- HEADER DE LA P√ÅGINA -->
<div class="page-header">
    <div class="container-fluid">
        <div class="row align-items-center">
            <div class="col-lg-8">
                <h1 class="page-title">
                    <i class="fas fa-list-alt me-3"></i>
                    {% if playlist %}
                        {{ playlist.title }}
                    {% else %}
                        Nueva Lista de Reproducci√≥n
                    {% endif %}
                </h1>
                <p class="page-subtitle mb-0">
                    {% if playlist %}
                        Vista y gesti√≥n de la lista de reproducci√≥n
                    {% else %}
                        Crea y organiza tus listas de reproducci√≥n
                    {% endif %}
                </p>
            </div>
            <div class="col-lg-4 text-lg-end">
                <div class="d-flex gap-2 justify-content-lg-end justify-content-center">
                    <button type="button" class="btn btn-primary" id="toggleEditModeBtn">
                        <i class="fas fa-edit me-2"></i>Modo Edici√≥n
                    </button>
                    <button type="button" class="btn btn-success" id="savePlaylistBtn" disabled>
                        <i class="fas fa-save me-2"></i>Guardar
                    </button>
                    <button type="button" class="btn btn-primary" onclick="window.location.href='/ui/playlists'">
                        <i class="fas fa-arrow-left me-2"></i>Volver a Listas
                    </button>
                    {% if playlist %}
                        <button type="button" class="btn btn-danger" data-bs-toggle="modal" data-bs-target="#deletePlaylistModal">
                            <i class="fas fa-trash-alt me-2"></i>Eliminar Lista
                        </button>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
</div>

<!-- CONTENIDO PRINCIPAL -->
<div class="container-fluid">
    <!-- SECCI√ìN: ESTAD√çSTICAS -->
    <div class="row mb-4">
        <div class="col-md-4">
            <div class="stat-card">
                <div class="stat-value" id="statVideoCount">
                    {% if playlist %}
                        {{ playlist.playlist_videos|length }}
                    {% else %}
                        0
                    {% endif %}
                </div>
                <div class="stat-label">Videos</div>
            </div>
        </div>
        <div class="col-md-4">
            <div class="stat-card">
                <div class="stat-value" id="statTotalDuration">
                    {% if playlist %}
                        {% set total_duration = 0 %}
                        {% for pv in playlist.playlist_videos %}
                            {% set total_duration = total_duration + (pv.video.duration or 0) %}
                        {% endfor %}
                        
                        {% if total_duration > 3600 %}
                            {{ (total_duration // 3600) }}h {{ ((total_duration % 3600) // 60) }}m
                        {% else %}
                            {{ (total_duration // 60) }}m {{ (total_duration % 60) }}s
                        {% endif %}
                    {% else %}
                        0m 0s
                    {% endif %}
                </div>
                <div class="stat-label">Duraci√≥n Total</div>
            </div>
        </div>
        <div class="col-md-4">
            <div class="stat-card">
                <div class="stat-value">
                    {% if playlist and playlist.is_active %}
                        <span class="text-success">Activa</span>
                    {% else %}
                        <span class="text-danger">Inactiva</span>
                    {% endif %}
                </div>
                <div class="stat-label">Estado</div>
            </div>
        </div>
    </div>

    <!-- SECCI√ìN: DETALLES DE LA LISTA (ANCHO COMPLETO) -->
    <div class="row">
        <div class="col-12">
            <div class="main-panel mb-4" id="playlistDetailsPanel">
                <div class="panel-header bg-primary text-white p-3">
                    <h5 class="mb-0">
                        <i class="fas fa-info-circle me-2"></i>Detalles de la Lista
                        <span id="unsavedIndicator" class="badge bg-warning ms-2" style="display: none;">
                            <i class="fas fa-exclamation-triangle me-1"></i>Cambios sin guardar
                        </span>
                    </h5>
                </div>
                
                <div class="panel-body p-3">
                    <div id="playlistDetailsLoading" style="display: none;">
                        <div class="d-flex justify-content-center py-4">
                            <div class="spinner-border text-primary" role="status">
                                <span class="visually-hidden">Cargando...</span>
                            </div>
                        </div>
                    </div>
                    
                    <form id="playlistForm">
                        <div class="row">
                            <!-- Columna izquierda -->
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="playlist_title" class="form-label text-dark fw-bold">
                                        <strong>T√≠tulo *</strong>
                                    </label>
                                    <input type="text" 
                                        class="form-control playlist-form-control" 
                                        id="playlist_title" 
                                        value="{{ playlist.title if playlist else '' }}" 
                                        required 
                                        disabled>
                                </div>
                                
                                <div class="mb-3 form-check">
                                    <input type="checkbox" 
                                        class="form-check playlist-form-control" 
                                        id="playlist_is_active" 
                                        {% if playlist and playlist.is_active %}checked{% endif %} 
                                        disabled>
                                    <label class="form-check-label text-dark fw-bold" for="playlist_is_active">
                                        <strong>Lista activa</strong>
                                    </label>
                                </div>
                            </div>
                            
                            <!-- Columna derecha -->
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="playlist_description" class="form-label text-dark fw-bold">
                                        <strong>Descripci√≥n</strong>
                                    </label>
                                    <textarea class="form-control playlist-form-control" 
                                            id="playlist_description" 
                                            rows="3" 
                                            disabled>{{ playlist.description if playlist and playlist.description else '' }}</textarea>
                                </div>
                            </div>
                        </div>
                        
                        <div class="row">
                            <!-- Fechas - Columna izquierda -->
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="playlist_start_datetime" class="form-label text-dark fw-bold">
                                        <strong>Inicio</strong>
                                    </label>
                                    <input type="datetime-local" 
                                        class="form-control playlist-form-control" 
                                        id="playlist_start_datetime"
                                        value="{% if playlist and playlist.start_date %}{{ playlist.start_date.strftime('%Y-%m-%dT%H:%M') }}{% endif %}" 
                                        disabled>
                                    <small class="form-text text-muted">Dejar vac√≠o para activar inmediatamente</small>
                                </div>
                            </div>
                            
                            <!-- Fechas - Columna derecha -->
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="playlist_expiration_datetime" class="form-label text-dark fw-bold">
                                        <strong>Expiraci√≥n</strong>
                                    </label>
                                    <input type="datetime-local" 
                                        class="form-control playlist-form-control" 
                                        id="playlist_expiration_datetime"
                                        value="{% if playlist and playlist.expiration_date %}{{ playlist.expiration_date.strftime('%Y-%m-%dT%H:%M') }}{% endif %}" 
                                        disabled>
                                    <small class="form-text text-muted">Dejar vac√≠o para que no expire nunca</small>
                                </div>
                            </div>
                        </div>

                        <!-- Informaci√≥n de fechas en solo lectura -->
                        {% if playlist %}
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label class="form-label text-dark fw-bold">
                                        <strong>Fecha de creaci√≥n</strong>
                                    </label>
                                    <div class="form-control-plaintext">
                                        {{ playlist.creation_date.strftime('%d/%m/%Y %H:%M') if playlist.creation_date else 'No disponible' }}
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label class="form-label text-dark fw-bold">
                                        <strong>√öltima modificaci√≥n</strong>
                                    </label>
                                    <div class="form-control-plaintext">
                                        {{ playlist.updated_at.strftime('%d/%m/%Y %H:%M') if playlist.updated_at else 'No disponible' }}
                                    </div>
                                </div>
                            </div>
                        </div>
                        {% endif %}
                    </form>
                </div>
            </div>
        </div>
    </div>
    
    <!-- SECCI√ìN: VIDEOS Y BIBLIOTECA (LADO A LADO) -->
    <div class="row">
        <!-- Videos en la Lista -->
        <div class="col-lg-7">
            <div class="main-panel mb-4">
                <div class="panel-header bg-success text-white p-3 d-flex justify-content-between align-items-center">
                    <h5 class="mb-0"><i class="fas fa-film me-2"></i>Videos en la Lista</h5>
                    <div>
                        <span class="badge bg-light text-dark me-2">
                            <i class="fas fa-list-ol me-1"></i>
                            <span id="videoCountBadge">
                                {% if playlist and playlist.playlist_videos %}
                                    {{ playlist.playlist_videos|length }}
                                {% else %}
                                    0
                                {% endif %}
                            </span>
                        </span>
                    </div>
                </div>
                <div class="panel-body p-3">
                    <div id="playlistVideosLoading" style="display: none;">
                        <div class="d-flex justify-content-center py-4">
                            <div class="spinner-border text-primary" role="status">
                                <span class="visually-hidden">Cargando...</span>
                            </div>
                        </div>
                    </div>
                    
                    <div id="playlistVideosList" style="max-height: 500px; overflow-y: auto; margin-right: 1px;">
                        {% if playlist and playlist.playlist_videos %}
                            {% for pv in playlist.playlist_videos|sort(attribute='position') %}
                            <div class="playlist-video-item" data-video-id="{{ pv.video.id }}" data-position="{{ pv.position or loop.index0 }}">
                                <div class="row align-items-center g-2">
                                    <div class="col-auto">
                                        <div class="video-handle cursor-grab">
                                            <i class="fas fa-grip-vertical text-muted"></i>
                                        </div>
                                    </div>
                                    <div class="col-auto">
                                        <span class="video-position">{{ loop.index }}</span>
                                    </div>
                                    <div class="col">
                                        <h6 class="mb-0 text-truncate-2">{{ pv.video.title or 'Sin t√≠tulo' }}</h6>
                                        <div class="d-flex align-items-center mt-1">
                                            <small class="text-muted me-2">
                                                <i class="far fa-clock me-1"></i>
                                                {{ ((pv.video.duration or 0) // 60)|int }}:{{ "%02d"|format(((pv.video.duration or 0) % 60)|int) }}
                                            </small>
                                        </div>
                                    </div>
                                    <div class="col-auto">
                                        <div class="btn-group">
                                            <button type="button" class="btn btn-sm btn-outline-primary" 
                                                    onclick="previewVideo({{ pv.video.id }})" title="Vista previa">
                                                <i class="fas fa-play"></i>
                                            </button>
                                            <button type="button" class="btn btn-sm btn-outline-danger edit-action" 
                                                    style="display: none;"
                                                    onclick="removeVideoFromPlaylist({{ pv.video.id }})" title="Quitar de la lista">
                                                <i class="fas fa-times"></i>
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            {% endfor %}
                        {% else %}
                            <div class="alert alert-info mb-0">
                                <i class="fas fa-info-circle me-2"></i>
                                Esta lista de reproducci√≥n no tiene videos. Agrega videos desde la biblioteca.
                            </div>
                        {% endif %}
                    </div>
                    
                    <div class="text-center mt-3 edit-action" style="display: none;">
                        <small class="text-muted">
                            <i class="fas fa-info-circle me-1"></i>
                            Arrastra los videos para cambiar su orden
                        </small>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Biblioteca de Videos -->
        <div class="col-lg-5">
            <div class="main-panel mb-4">
                <div class="panel-header bg-info text-white p-3">
                    <h5 class="mb-0"><i class="fas fa-photo-video me-2"></i>Biblioteca de Videos</h5>
                </div>
                <div class="panel-body p-3">
                    <!-- Buscador de videos -->
                    <div class="mb-3">
                        <div class="input-group">
                            <span class="input-group-text"><i class="fas fa-search"></i></span>
                            <input type="text" class="form-control" id="videoSearchInput" 
                                   placeholder="Buscar videos por t√≠tulo...">
                            <button class="btn btn-primary edit-action" type="button" id="addVideoToPlaylistBtn" style="display: none;">
                                <i class="fas fa-plus me-2"></i>Agregar
                            </button>
                        </div>
                    </div>
                    
                    <div id="availableVideosLoading" style="display: none;">
                        <div class="d-flex justify-content-center py-4">
                            <div class="spinner-border text-info" role="status">
                                <span class="visually-hidden">Cargando...</span>
                            </div>
                        </div>
                    </div>
                    
                    <div id="availableVideosList">
                        <div class="alert alert-info">
                            <i class="fas fa-info-circle me-2"></i>
                            Cargando videos disponibles...
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- SECCI√ìN: DISPOSITIVOS ASIGNADOS -->
    <div class="row">
        <div class="col-12">
            <div class="main-panel mb-4">
                <div class="panel-header bg-warning text-dark p-3 d-flex justify-content-between align-items-center">
                    <h5 class="mb-0"><i class="fas fa-tablet-alt me-2"></i>Dispositivos Asignados</h5>
                    <div class="d-flex align-items-center">
                        <button class="btn btn-outline-info btn-sm me-2" data-bs-toggle="modal" data-bs-target="#assignDeviceModal">
                            <i class="fas fa-plus-circle me-1"></i> Asignar Dispositivo
                        </button>
                        <span class="badge bg-dark text-white" id="deviceCountBadge">
                            <div class="spinner-border spinner-border-sm" role="status" style="width: 12px; height: 12px;">
                                <span class="visually-hidden">Cargando...</span>
                            </div>
                        </span>
                    </div>
                </div>
                <div class="panel-body p-3">
                    <!-- Alert container for device operations -->
                    <div id="deviceOperationAlerts"></div>
                    
                    <div id="assignedDevicesLoading" style="display: none;">
                        <div class="d-flex justify-content-center py-4">
                            <div class="spinner-border text-warning" role="status">
                                <span class="visually-hidden">Cargando...</span>
                            </div>
                        </div>
                    </div>
                    
                    <div class="table-responsive">
                        <table class="table table-hover table-striped mb-0">
                            <thead class="table-light">
                                <tr>
                                    <th>Dispositivo</th>
                                    <th>Ubicaci√≥n</th>
                                    <th>Estado</th>
                                    <th>√öltima Conexi√≥n</th>
                                    <th class="text-end">Acciones</th>
                                </tr>
                            </thead>
                            <tbody id="assignedDevicesList">
                                <!-- Contenido inicial de carga -->
                                <tr id="assignedDevicesLoading">
                                    <td colspan="5" class="text-center py-3">
                                        <div class="spinner-border text-primary" role="status">
                                            <span class="visually-hidden">Cargando dispositivos...</span>
                                        </div>
                                        <p class="mt-2 text-muted">Cargando dispositivos asignados...</p>
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- MODAL PARA ASIGNAR DISPOSITIVOS - VERSI√ìN CORREGIDA -->
<div class="modal fade" id="assignDeviceModal" tabindex="-1" aria-labelledby="assignDeviceModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header bg-primary text-white">
                <h5 class="modal-title" id="assignDeviceModalLabel">
                    <i class="fas fa-tv me-2"></i>Asignar Dispositivos a la Lista
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Cerrar"></button>
            </div>
            <div class="modal-body">
                <!-- Input hidden para playlist ID -->
                <input type="hidden" id="modal-playlist-id" value="{{ playlist.id if playlist else '' }}">
                
                <!-- Controles de b√∫squeda y filtros -->
                <div class="row mb-3">
                    <div class="col-md-6">
                        <div class="input-group">
                            <span class="input-group-text">
                                <i class="fas fa-search"></i>
                            </span>
                            <input type="text" id="deviceSearchInput" class="form-control" 
                                   placeholder="Buscar por ID, nombre, tienda, ubicaci√≥n o IP...">
                            <button class="btn btn-outline-secondary" type="button" id="clearDeviceSearch">
                                <i class="fas fa-times"></i> Limpiar
                            </button>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <select class="form-select" id="deviceStatusFilter">
                            <option value="all" selected>Todos los estados</option>
                            <option value="online">Solo en l√≠nea</option>
                            <option value="offline">Solo fuera de l√≠nea</option>
                            <option value="assigned">Ya asignados</option>
                            <option value="unassigned">No asignados</option>
                        </select>
                    </div>
                    <div class="col-md-3">
                        <select class="form-select" id="deviceStoreFilter">
                            <option value="all" selected>Todas las tiendas</option>
                            <!-- Las opciones se cargan din√°micamente -->
                        </select>
                    </div>
                </div>

                <!-- Alertas del modal -->
                <div id="deviceModalAlerts"></div>

                <!-- Indicador de carga -->
                <div id="deviceModalLoading" class="text-center py-4">
                    <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">Cargando...</span>
                    </div>
                    <p class="mt-2 text-muted">Cargando dispositivos...</p>
                </div>

                <!-- Contenido principal -->
                <div id="deviceModalContent" style="display: none;">
                    <!-- Controles de selecci√≥n masiva -->
                    <div class="row mb-3">
                        <div class="col-md-6">
                            <div class="btn-group btn-group-sm" role="group">
                                <button type="button" class="btn btn-outline-primary" id="selectAllDevices">
                                    <i class="fas fa-check-square me-1"></i>Seleccionar Todos
                                </button>
                                <button type="button" class="btn btn-outline-secondary" id="deselectAllDevices">
                                    <i class="fas fa-square me-1"></i>Deseleccionar Todos
                                </button>
                            </div>
                        </div>
                        <div class="col-md-6 text-end">
                            <small class="text-muted" id="deviceCounter">0 dispositivos encontrados</small>
                        </div>
                    </div>

                    <!-- Tabla de dispositivos -->
                    <div class="table-responsive" style="max-height: 500px; border: 1px solid #dee2e6; border-radius: 0.375rem;">
                        <table class="table table-hover table-striped mb-0">
                            <thead class="table-light" style="position: sticky; top: 0; z-index: 10;">
                                <tr>
                                    <th style="width: 60px;">
                                        <div class="form-check">
                                            <input class="form-check-input" type="checkbox" id="selectAllCheckbox">
                                            <label class="form-check-label" for="selectAllCheckbox"></label>
                                        </div>
                                    </th>
                                    <th style="width: 120px;">ID</th>
                                    <th>Nombre</th>
                                    <th style="width: 100px;">Estado</th>
                                    <th>Tienda</th>
                                    <th>Ubicaci√≥n</th>
                                    <th style="width: 100px;">IP LAN</th>
                                    <th style="width: 100px;">IP WLAN</th>
                                    <th style="width: 150px;">√öltima Conexi√≥n</th>
                                    <th style="width: 80px;">Acciones</th>
                                </tr>
                            </thead>
                            <tbody id="availableDevicesList">
                                <!-- El contenido se carga din√°micamente -->
                            </tbody>
                        </table>
                    </div>

                    <!-- Informaci√≥n de paginaci√≥n -->
                    <div class="d-flex justify-content-between align-items-center mt-3">
                        <small class="text-muted" id="devicesPaginationInfo">
                            Mostrando 0 dispositivos
                        </small>
                        <button class="btn btn-sm btn-outline-secondary" id="clearAllDeviceFilters">
                            <i class="fas fa-eraser me-1"></i>Limpiar Filtros
                        </button>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                    <i class="fas fa-times me-1"></i>Cancelar
                </button>
                <button type="button" class="btn btn-success" id="saveDeviceAssignments" disabled>
                    <i class="fas fa-save me-1"></i>Guardar Cambios
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Modal de previsualizaci√≥n -->
<div class="modal fade" id="videoPreviewModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header bg-dark text-white">
                <h5 class="modal-title">
                    <i class="fas fa-play-circle me-2"></i>
                    <span id="previewVideoTitle">Vista Previa</span>
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Cerrar"></button>
            </div>
            <div class="modal-body p-0 bg-dark">
                <div class="video-preview-container">
                    <!-- Reproductor de video -->
                    <video id="previewVideoPlayer" class="w-100" controls autoplay controlsList="nodownload">
                        <source src="" type="video/mp4">
                        Tu navegador no soporta la reproducci√≥n de videos.
                    </video>
                </div>
                <div class="p-3 bg-light">
                    <h6 id="previewVideoTitle" class="mb-2"></h6>
                    <p id="previewVideoDescription" class="text-muted mb-0 small"></p>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cerrar</button>
            </div>
        </div>
    </div>
</div>

<!-- Modal para confirmar eliminaci√≥n -->
<div class="modal fade" id="deletePlaylistModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header bg-danger text-white">
                <h5 class="modal-title">
                    <i class="fas fa-exclamation-triangle me-2"></i>Eliminar Lista
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Cerrar"></button>
            </div>
            <div class="modal-body">
                <p>¬øEst√°s seguro de que deseas eliminar esta lista de reproducci√≥n?</p>
                <p><strong>Esta acci√≥n no se puede deshacer.</strong></p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                <button type="button" class="btn btn-danger" id="confirmDeletePlaylistBtn">Eliminar</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_scripts %}
<!-- jQuery necesario para algunas funcionalidades -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>

<!-- Funci√≥n de compatibilidad para modales -->
<script>
function openAssignDevicesModal() {
    var assignDeviceModal = new bootstrap.Modal(document.getElementById('assignDeviceModal'));
    assignDeviceModal.show();
}
</script>

<!-- Scripts principales del sistema -->
<script src="/static/js/video_player_handler.js"></script>
<script src="/static/js/playlist_detail.js"></script>

<!-- Script CORREGIDO para el modal de asignaci√≥n -->
<script>
/**
 * DEVICE ASSIGNMENT MODAL - VERSI√ìN CORREGIDA
 * Mantiene el dise√±o original pero corrige los problemas de asignaci√≥n
 */

console.log('üöÄ Cargando device-assignment-modal.js (versi√≥n CORREGIDA)...');

// Variables globales
let allDevices = [];
let assignedDeviceIds = [];
let pendingChanges = new Set();
let filteredDevices = [];
let searchTerm = '';
let statusFilter = 'all';
let storeFilter = 'all';
let isLoading = false;
let initialized = false;

/**
 * Inicializar el modal cuando el DOM est√© listo
 */
document.addEventListener('DOMContentLoaded', function() {
    console.log('üìã DOM cargado, inicializando modal...');
    
    try {
        setupModalEvents();
        setupFilterListeners();
        setupActionButtons();
        
        // Cargar dispositivos asignados inmediatamente
        console.log('üîÑ Iniciando carga de dispositivos asignados...');
        loadAssignedDevicesInMainView().catch(error => {
            console.error('‚ùå Error cargando dispositivos asignados al inicializar:', error);
        });
        
        initialized = true;
        console.log('‚úÖ Modal inicializado correctamente');
    } catch (error) {
        console.error('‚ùå Error inicializando modal:', error);
    }
});

/**
 * Configurar eventos del modal
 */
function setupModalEvents() {
    const modal = document.getElementById('assignDeviceModal');
    if (!modal) {
        console.error('‚ùå No se encontr√≥ el modal #assignDeviceModal');
        return;
    }
    
    console.log('üîß Configurando eventos del modal...');
    
    modal.addEventListener('show.bs.modal', async function() {
        console.log('üìÇ Modal abri√©ndose...');
        await handleModalOpen();
    });
    
    modal.addEventListener('hidden.bs.modal', function() {
        console.log('üìÇ Modal cerr√°ndose...');
        handleModalClose();
        // Recargar dispositivos asignados despu√©s de cerrar
        setTimeout(loadAssignedDevicesInMainView, 500);
    });
}

/**
 * Manejar la apertura del modal
 */
async function handleModalOpen() {
    try {
        console.log('üîÑ Iniciando carga de datos del modal...');
        
        resetModalState();
        showLoading(true);
        
        const playlistId = getPlaylistId();
        console.log('üé¨ Playlist ID obtenido:', playlistId);
        
        if (!playlistId) {
            throw new Error('No se pudo obtener el ID de la playlist');
        }
        
        await loadModalData(playlistId);
        
        showLoading(false);
        applyFiltersAndRender();
        
        console.log('‚úÖ Modal cargado exitosamente');
        
    } catch (error) {
        console.error('‚ùå Error cargando modal:', error);
        showModalError('Error al cargar', error.message);
        showLoading(false);
    }
}

/**
 * Cargar datos del modal
 */
async function loadModalData(playlistId) {
    console.log('üì• Cargando datos para playlist:', playlistId);
    
    try {
        await loadAllDevices();
        await loadAssignedDevices(playlistId);
        
        console.log(`‚úÖ Datos cargados: ${allDevices.length} dispositivos, ${assignedDeviceIds.length} asignados`);
        
        loadStoreFilter();
        
    } catch (error) {
        console.error('‚ùå Error cargando datos:', error);
        throw error;
    }
}

/**
 * Cargar todos los dispositivos
 */
async function loadAllDevices() {
    console.log('üì• Cargando todos los dispositivos desde API...');
    
    try {
        const response = await fetch('/api/devices/?limit=999999', {
            method: 'GET',
            headers: {
                'Accept': 'application/json',
                'Content-Type': 'application/json'
            }
        });
        
        if (response.ok) {
            const data = await response.json();
            allDevices = Array.isArray(data) ? data : (data.results || []);
            console.log(`‚úÖ ${allDevices.length} dispositivos cargados desde API`);
        } else {
            throw new Error(`Error ${response.status}: ${response.statusText}`);
        }
        
    } catch (error) {
        console.warn('‚ö†Ô∏è API no disponible, usando datos de fallback...', error);
        allDevices = createFallbackDevices();
    }
}

/**
 * Cargar dispositivos asignados
 */
async function loadAssignedDevices(playlistId) {
    console.log(`üì• Cargando dispositivos asignados para playlist ${playlistId}...`);
    
    try {
        const response = await fetch(`/api/device-playlists/playlist/${playlistId}/devices`, {
            method: 'GET',
            headers: {
                'Accept': 'application/json',
                'Content-Type': 'application/json'
            }
        });
        
        if (response.ok) {
            const data = await response.json();
            assignedDeviceIds = data.map(device => {
                const id = device.device_id || device.id;
                return id ? id.toString() : null;
            }).filter(id => id !== null);
            
            console.log(`‚úÖ ${assignedDeviceIds.length} dispositivos asignados cargados`);
        } else {
            console.warn(`‚ö†Ô∏è Error cargando asignaciones: ${response.status}`);
            assignedDeviceIds = [];
        }
        
    } catch (error) {
        console.warn('‚ö†Ô∏è No se pudieron cargar asignaciones:', error);
        assignedDeviceIds = [];
    }
}

/**
 * FUNCI√ìN CR√çTICA CORREGIDA: Guardar asignaciones de dispositivos
 */
async function saveDeviceAssignments() {
    if (pendingChanges.size === 0) {
        console.log('‚ÑπÔ∏è No hay cambios para guardar');
        showSuccessMessage('No hay cambios para guardar');
        return;
    }
    
    const playlistId = getPlaylistId();
    if (!playlistId) {
        console.error('‚ùå No se pudo obtener el ID de la playlist');
        showModalError('Error', 'No se pudo obtener el ID de la playlist');
        return;
    }
    
    console.log(`üíæ GUARDANDO ${pendingChanges.size} cambios para playlist ${playlistId}...`);
    
    const saveButton = document.getElementById('saveDeviceAssignments');
    if (saveButton) {
        saveButton.disabled = true;
        saveButton.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>Guardando...';
    }
    
    try {
        let successCount = 0;
        let errorCount = 0;
        
        // Procesar cada cambio pendiente
        for (const deviceId of pendingChanges) {
            const isCurrentlyAssigned = assignedDeviceIds.includes(deviceId);
            
            if (isCurrentlyAssigned) {
                // DESASIGNAR dispositivo
                try {
                    console.log(`üîó Desasignando dispositivo ${deviceId}...`);
                    const response = await fetch(`/api/device-playlists/${deviceId}/${playlistId}`, {
                        method: 'DELETE',
                        headers: {
                            'Accept': 'application/json',
                            'Content-Type': 'application/json'
                        }
                    });
                    
                    if (response.ok) {
                        assignedDeviceIds = assignedDeviceIds.filter(id => id !== deviceId);
                        successCount++;
                        console.log(`‚úÖ Dispositivo ${deviceId} desasignado correctamente`);
                    } else {
                        errorCount++;
                        console.error(`‚ùå Error desasignando dispositivo ${deviceId}: ${response.status}`);
                    }
                } catch (error) {
                    errorCount++;
                    console.error(`‚ùå Error desasignando dispositivo ${deviceId}:`, error);
                }
            } else {
                // ASIGNAR dispositivo
                try {
                    console.log(`‚ûï Asignando dispositivo ${deviceId}...`);
                    const response = await fetch('/api/device-playlists/', {
                        method: 'POST',
                        headers: {
                            'Accept': 'application/json',
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            device_id: deviceId,
                            playlist_id: parseInt(playlistId)
                        })
                    });
                    
                    if (response.ok) {
                        assignedDeviceIds.push(deviceId);
                        successCount++;
                        console.log(`‚úÖ Dispositivo ${deviceId} asignado correctamente`);
                    } else {
                        errorCount++;
                        console.error(`‚ùå Error asignando dispositivo ${deviceId}: ${response.status}`);
                        const errorText = await response.text();
                        console.error('Error details:', errorText);
                    }
                } catch (error) {
                    errorCount++;
                    console.error(`‚ùå Error asignando dispositivo ${deviceId}:`, error);
                }
            }
        }
        
        // Limpiar cambios pendientes
        pendingChanges.clear();
        
        // Actualizar la UI del modal
        applyFiltersAndRender();
        
        // Mostrar mensaje de resultado
        if (successCount > 0 && errorCount === 0) {
            showSuccessMessage(`‚úÖ ${successCount} cambios guardados correctamente`);
            
            // Cerrar modal autom√°ticamente despu√©s de √©xito completo
            setTimeout(() => {
                const modal = bootstrap.Modal.getInstance(document.getElementById('assignDeviceModal'));
                if (modal) modal.hide();
            }, 1500);
            
        } else if (successCount > 0 && errorCount > 0) {
            showModalError('Guardado parcial', `${successCount} cambios guardados, ${errorCount} fallaron`);
        } else {
            showModalError('Error', 'No se pudieron guardar los cambios');
        }
        
        console.log(`‚úÖ PROCESO COMPLETADO: ${successCount} √©xitos, ${errorCount} errores`);
        
    } catch (error) {
        console.error('‚ùå Error guardando cambios:', error);
        showModalError('Error', 'No se pudieron guardar los cambios: ' + error.message);
    } finally {
        if (saveButton) {
            saveButton.disabled = false;
            saveButton.innerHTML = '<i class="fas fa-save me-1"></i>Guardar Cambios';
        }
    }
}

/**
 * FUNCI√ìN MEJORADA: Cargar dispositivos asignados en la vista principal
 */
async function loadAssignedDevicesInMainView() {
    console.log('üîÑ [MAIN VIEW] Iniciando carga de dispositivos asignados...');
    
    const playlistId = getPlaylistId();
    if (!playlistId) {
        console.error('‚ùå [MAIN VIEW] No se pudo obtener el ID de la playlist');
        showErrorInMainView('No se pudo obtener el ID de la playlist');
        return;
    }
    
    console.log(`üì∫ [MAIN VIEW] Cargando dispositivos para playlist ${playlistId}...`);
    
    const assignedDevicesList = document.getElementById('assignedDevicesList');
    const deviceCountBadge = document.getElementById('deviceCountBadge');
    
    if (!assignedDevicesList) {
        console.error('‚ùå [MAIN VIEW] No se encontr√≥ #assignedDevicesList');
        return;
    }
    
    // Mostrar estado de carga
    assignedDevicesList.innerHTML = `
        <tr id="loadingRow">
            <td colspan="5" class="text-center py-3">
                <div class="spinner-border text-primary" role="status">
                    <span class="visually-hidden">Cargando...</span>
                </div>
                <p class="mt-2 text-muted">Cargando dispositivos asignados...</p>
            </td>
        </tr>
    `;
    
    try {
        console.log(`üåê [MAIN VIEW] Haciendo petici√≥n a: /api/device-playlists/playlist/${playlistId}/devices`);
        
        const response = await fetch(`/api/device-playlists/playlist/${playlistId}/devices`, {
            method: 'GET',
            headers: {
                'Accept': 'application/json',
                'Content-Type': 'application/json'
            }
        });
        
        console.log(`üì° [MAIN VIEW] Respuesta recibida:`, {
            status: response.status,
            statusText: response.statusText,
            ok: response.ok
        });
        
        if (response.ok) {
            const devices = await response.json();
            console.log(`‚úÖ [MAIN VIEW] ${devices.length} dispositivos cargados:`, devices);
            
            // Actualizar contador
            if (deviceCountBadge) {
                deviceCountBadge.textContent = devices.length;
                console.log(`üìä [MAIN VIEW] Contador actualizado: ${devices.length}`);
            }
            
            // Renderizar tabla
            if (devices.length === 0) {
                console.log('üìã [MAIN VIEW] No hay dispositivos, mostrando mensaje vac√≠o');
                assignedDevicesList.innerHTML = `
                    <tr>
                        <td colspan="5" class="text-center py-3">
                            <div class="alert alert-info mb-0">
                                <i class="fas fa-info-circle me-2"></i>
                                Esta lista no tiene dispositivos asignados.
                            </div>
                        </td>
                    </tr>
                `;
            } else {
                console.log(`üé® [MAIN VIEW] Renderizando ${devices.length} dispositivos...`);
                
                const rowsHtml = devices.map((device, index) => {
                    const deviceId = device.device_id || device.id || 'Sin ID';
                    const deviceName = device.name || device.device_name || 'Sin nombre';
                    const location = device.location || device.ubicacion || 'Sin ubicaci√≥n';
                    const isActive = device.is_active || device.active || false;
                    
                    let lastConnection = 'Nunca';
                    if (device.last_seen) {
                        try {
                            const date = new Date(device.last_seen);
                            lastConnection = date.toLocaleString('es-ES');
                        } catch (e) {
                            lastConnection = device.last_seen.toString();
                        }
                    }
                    
                    console.log(`üì± [MAIN VIEW] Dispositivo ${index + 1}:`, {
                        id: deviceId,
                        name: deviceName,
                        active: isActive
                    });
                    
                    return `
                        <tr class="assigned-device-item">
                            <td>
                                <div class="d-flex align-items-center">
                                    <i class="fas fa-tablet-alt text-primary me-2"></i>
                                    <div>
                                        <div class="fw-bold">${deviceName}</div>
                                        <small class="text-muted">ID: ${deviceId}</small>
                                    </div>
                                </div>
                            </td>
                            <td>${location}</td>
                            <td>
                                <span class="badge ${isActive ? 'bg-success' : 'bg-secondary'}">
                                    <i class="fas ${isActive ? 'fa-check-circle' : 'fa-times-circle'} me-1"></i>
                                    ${isActive ? 'Activo' : 'Inactivo'}
                                </span>
                            </td>
                            <td>${lastConnection}</td>
                            <td class="text-end">
                                <button type="button" class="btn btn-sm btn-outline-danger edit-action"
                                        style="display: none;"
                                        onclick="unassignDeviceFromMainView('${deviceId}')" 
                                        title="Quitar dispositivo">
                                    <i class="fas fa-unlink"></i>
                                </button>
                            </td>
                        </tr>
                    `;
                }).join('');
                
                assignedDevicesList.innerHTML = rowsHtml;
                console.log('‚úÖ [MAIN VIEW] Tabla renderizada correctamente');
            }
            
        } else {
            const errorText = await response.text();
            console.error(`‚ùå [MAIN VIEW] Error en respuesta: ${response.status} - ${errorText}`);
            throw new Error(`Error ${response.status}: ${response.statusText}`);
        }
        
    } catch (error) {
        console.error('‚ùå [MAIN VIEW] Error cargando dispositivos asignados:', error);
        showErrorInMainView(`Error al cargar dispositivos: ${error.message}`);
        
        if (deviceCountBadge) {
            deviceCountBadge.innerHTML = '<i class="fas fa-exclamation-triangle text-danger"></i>';
        }
    }
}

/**
 * Mostrar error en la vista principal
 */
function showErrorInMainView(message) {
    const assignedDevicesList = document.getElementById('assignedDevicesList');
    if (assignedDevicesList) {
        assignedDevicesList.innerHTML = `
            <tr>
                <td colspan="5" class="text-center py-3">
                    <div class="alert alert-danger mb-0">
                        <i class="fas fa-exclamation-triangle me-2"></i>
                        ${message}
                        <button class="btn btn-sm btn-outline-danger ms-2" onclick="loadAssignedDevicesInMainView()">
                            <i class="fas fa-sync-alt me-1"></i>Reintentar
                        </button>
                    </div>
                </td>
            </tr>
        `;
    }
}

/**
 * Desasignar dispositivo desde la vista principal
 */
async function unassignDeviceFromMainView(deviceId) {
    if (!confirm('¬øEst√°s seguro de que deseas quitar este dispositivo de la lista?')) {
        return;
    }
    
    const playlistId = getPlaylistId();
    if (!playlistId) {
        alert('Error: No se pudo obtener el ID de la playlist');
        return;
    }
    
    console.log(`üîó Desasignando dispositivo ${deviceId} desde vista principal...`);
    
    try {
        const response = await fetch(`/api/device-playlists/${deviceId}/${playlistId}`, {
            method: 'DELETE',
            headers: {
                'Accept': 'application/json',
                'Content-Type': 'application/json'
            }
        });
        
        if (response.ok) {
            showDeviceOperationSuccess('Dispositivo desasignado correctamente');
            setTimeout(loadAssignedDevicesInMainView, 500);
        } else {
            throw new Error(`Error ${response.status}: ${response.statusText}`);
        }
        
    } catch (error) {
        console.error('‚ùå Error desasignando dispositivo desde vista principal:', error);
        showDeviceOperationError(`Error al desasignar dispositivo: ${error.message}`);
    }
}

/**
 * Obtener ID de playlist
 */
function getPlaylistId() {
    const modalInput = document.getElementById('modal-playlist-id');
    if (modalInput && modalInput.value) {
        return modalInput.value;
    }
    
    const hiddenInput = document.getElementById('playlist-id');
    if (hiddenInput && hiddenInput.value) {
        return hiddenInput.value;
    }
    
    const urlParams = new URLSearchParams(window.location.search);
    const urlId = urlParams.get('id');
    if (urlId) {
        return urlId;
    }
    
    if (window.currentPlaylistData && window.currentPlaylistData.id) {
        return window.currentPlaylistData.id.toString();
    }
    
    const pathMatch = window.location.pathname.match(/\/playlist\/(\d+)/);
    if (pathMatch) {
        return pathMatch[1];
    }
    
    console.warn('‚ö†Ô∏è No se pudo obtener ID de playlist');
    return null;
}

// Resto de funciones helper...
function createFallbackDevices() {
    const devices = [];
    for (let i = 1; i <= 20; i++) {
        devices.push({
            device_id: `DEV_${i.toString().padStart(3, '0')}`,
            id: `DEV_${i.toString().padStart(3, '0')}`,
            name: `Dispositivo ${i}`,
            is_active: Math.random() > 0.3,
            tienda: `Tienda ${Math.ceil(i/5)}`,
            location: `Ubicaci√≥n ${i}`,
            ip_address_lan: `192.168.1.${i + 100}`,
            ip_address_wifi: `10.0.1.${i + 100}`
        });
    }
    return devices;
}

function loadStoreFilter() {
    const storeFilterSelect = document.getElementById('deviceStoreFilter');
    if (!storeFilterSelect) return;
    
    const stores = new Set();
    allDevices.forEach(device => {
        const tienda = device.tienda || device.store || '';
        if (tienda && tienda.trim() !== '') {
            stores.add(tienda.trim());
        }
    });
    
    const sortedStores = Array.from(stores).sort();
    
    storeFilterSelect.innerHTML = '<option value="all" selected>Todas las tiendas</option>';
    sortedStores.forEach(store => {
        const option = document.createElement('option');
        option.value = store;
        option.textContent = store;
        storeFilterSelect.appendChild(option);
    });
}

function setupFilterListeners() {
    const searchInput = document.getElementById('deviceSearchInput');
    if (searchInput) {
        searchInput.addEventListener('input', function(e) {
            searchTerm = e.target.value.trim();
            applyFiltersAndRender();
        });
    }
    
    const clearSearch = document.getElementById('clearDeviceSearch');
    if (clearSearch) {
        clearSearch.addEventListener('click', function() {
            if (searchInput) searchInput.value = '';
            searchTerm = '';
            applyFiltersAndRender();
        });
    }
    
    const statusFilterSelect = document.getElementById('deviceStatusFilter');
    if (statusFilterSelect) {
        statusFilterSelect.addEventListener('change', function(e) {
            statusFilter = e.target.value;
            applyFiltersAndRender();
        });
    }
    
    const storeFilterSelect = document.getElementById('deviceStoreFilter');
    if (storeFilterSelect) {
        storeFilterSelect.addEventListener('change', function(e) {
            storeFilter = e.target.value;
            applyFiltersAndRender();
        });
    }
}

function setupActionButtons() {
    const selectAllBtn = document.getElementById('selectAllDevices');
    if (selectAllBtn) {
        selectAllBtn.addEventListener('click', selectAllDevices);
    }
    
    const deselectAllBtn = document.getElementById('deselectAllDevices');
    if (deselectAllBtn) {
        deselectAllBtn.addEventListener('click', deselectAllDevices);
    }
    
    const saveBtn = document.getElementById('saveDeviceAssignments');
    if (saveBtn) {
        saveBtn.addEventListener('click', saveDeviceAssignments);
    }
}

function applyFiltersAndRender() {
    filteredDevices = allDevices.filter(device => {
        // Filtro de b√∫squeda
        if (searchTerm) {
            const searchLower = searchTerm.toLowerCase();
            const deviceName = (device.name || device.device_name || '').toLowerCase();
            const deviceId = (device.device_id || device.id || '').toString().toLowerCase();
            const tienda = (device.tienda || '').toLowerCase();
            
            if (!deviceName.includes(searchLower) && 
                !deviceId.includes(searchLower) &&
                !tienda.includes(searchLower)) {
                return false;
            }
        }
        
        // Filtro de tienda
        if (storeFilter !== 'all') {
            const deviceStore = device.tienda || device.store || '';
            if (deviceStore.trim() !== storeFilter) {
                return false;
            }
        }
        
        // Filtro de estado
        const deviceId = (device.device_id || device.id || '').toString();
        const isAssigned = assignedDeviceIds.includes(deviceId);
        const isPending = pendingChanges.has(deviceId);
        const willBeAssigned = (isAssigned && !isPending) || (!isAssigned && isPending);
        const isOnline = device.is_active || (device.status && device.status.toLowerCase() === 'online');
        
        switch (statusFilter) {
            case 'online': return isOnline;
            case 'offline': return !isOnline;
            case 'assigned': return willBeAssigned;
            case 'unassigned': return !willBeAssigned;
            default: return true;
        }
    });
    
    renderDeviceList();
    updateCounters();
    updateActionButtons();
}

function renderDeviceList() {
    const devicesList = document.getElementById('availableDevicesList');
    if (!devicesList) return;
    
    if (filteredDevices.length === 0) {
        devicesList.innerHTML = `
            <tr>
                <td colspan="10" class="text-center py-4">
                    <div class="text-muted">
                        <i class="fas fa-search fa-2x mb-3"></i>
                        <p>No se encontraron dispositivos</p>
                        <button class="btn btn-sm btn-outline-secondary" onclick="clearAllFilters()">
                            <i class="fas fa-times me-1"></i>Limpiar filtros
                        </button>
                    </div>
                </td>
            </tr>
        `;
        return;
    }
    
    const rowsHtml = filteredDevices.map(device => {
        const deviceId = (device.device_id || device.id || '').toString();
        const isAssigned = assignedDeviceIds.includes(deviceId);
        const isPending = pendingChanges.has(deviceId);
        const willBeAssigned = (isAssigned && !isPending) || (!isAssigned && isPending);
        
        const deviceIdDisplay = device.device_id || device.id || 'Sin ID';
        const deviceName = device.name || device.device_name || 'Sin nombre';
        const isActive = device.is_active || device.active || false;
        const tienda = device.tienda || device.store || 'Sin tienda';
        const location = device.location || device.ubicacion || 'Sin ubicaci√≥n';
        const ipLan = device.ip_address_lan || device.ip_lan || 'N/A';
        const ipWlan = device.ip_address_wifi || device.ip_wlan || 'N/A';
        
        const isOnline = device.is_active || (device.status && device.status.toLowerCase() === 'online');
        const statusClass = isOnline ? 'bg-success' : 'bg-secondary';
        const statusText = isOnline ? 'Online' : 'Offline';
        
        let lastConnection = 'N/A';
        if (device.last_seen) {
            try {
                const date = new Date(device.last_seen);
                lastConnection = date.toLocaleString('es-ES');
            } catch (e) {
                lastConnection = device.last_seen.toString();
            }
        }
        
        return `
            <tr class="${willBeAssigned ? 'table-active' : ''} ${isPending ? 'pending-changes' : ''}">
                <td class="align-middle">
                    <div class="form-check">
                        <input class="form-check-input device-checkbox" type="checkbox"
                               id="device-${deviceId}" 
                               value="${deviceId}" 
                               ${willBeAssigned ? 'checked' : ''}
                               onchange="handleDeviceCheckboxChange('${deviceId}')">
                        <label class="form-check-label" for="device-${deviceId}"></label>
                    </div>
                </td>
                <td class="align-middle">
                    <small class="text-muted">${deviceIdDisplay}</small>
                </td>
                <td class="align-middle">
                    <strong>${deviceName}</strong>
                </td>
                <td class="align-middle">
                    <span class="badge ${statusClass}">${statusText}</span>
                </td>
                <td class="align-middle">${tienda}</td>
                <td class="align-middle">${location}</td>
                <td class="align-middle">
                    <small class="text-muted">${ipLan}</small>
                </td>
                <td class="align-middle">
                    <small class="text-muted">${ipWlan}</small>
                </td>
                <td class="align-middle">
                    <small class="text-muted">${lastConnection}</small>
                </td>
                <td class="align-middle text-center">
                    <button class="btn btn-sm btn-outline-info" 
                            onclick="viewDeviceDetails('${deviceId}')"
                            title="Ver detalles">
                        <i class="fas fa-info-circle"></i>
                    </button>
                </td>
            </tr>
        `;
    }).join('');
    
    devicesList.innerHTML = rowsHtml;
}

function handleDeviceCheckboxChange(deviceId) {
    if (pendingChanges.has(deviceId)) {
        pendingChanges.delete(deviceId);
    } else {
        pendingChanges.add(deviceId);
    }
    applyFiltersAndRender();
}

function selectAllDevices() {
    filteredDevices.forEach(device => {
        const deviceId = (device.device_id || device.id || '').toString();
        const isCurrentlyAssigned = assignedDeviceIds.includes(deviceId);
        
        if (!isCurrentlyAssigned && !pendingChanges.has(deviceId)) {
            pendingChanges.add(deviceId);
        } else if (isCurrentlyAssigned && pendingChanges.has(deviceId)) {
            pendingChanges.delete(deviceId);
        }
    });
    applyFiltersAndRender();
}

function deselectAllDevices() {
    filteredDevices.forEach(device => {
        const deviceId = (device.device_id || device.id || '').toString();
        const isCurrentlyAssigned = assignedDeviceIds.includes(deviceId);
        
        if (isCurrentlyAssigned && !pendingChanges.has(deviceId)) {
            pendingChanges.add(deviceId);
        } else if (!isCurrentlyAssigned && pendingChanges.has(deviceId)) {
            pendingChanges.delete(deviceId);
        }
    });
    applyFiltersAndRender();
}

function clearAllFilters() {
    const searchInput = document.getElementById('deviceSearchInput');
    if (searchInput) searchInput.value = '';
    
    const statusFilterSelect = document.getElementById('deviceStatusFilter');
    if (statusFilterSelect) statusFilterSelect.value = 'all';
    
    const storeFilterSelect = document.getElementById('deviceStoreFilter');
    if (storeFilterSelect) storeFilterSelect.value = 'all';
    
    searchTerm = '';
    statusFilter = 'all';
    storeFilter = 'all';
    
    applyFiltersAndRender();
}

function updateCounters() {
    const counter = document.getElementById('deviceCounter');
    const pagination = document.getElementById('devicesPaginationInfo');
    
    const selectedCount = getSelectedCount();
    const filteredCount = filteredDevices.length;
    const totalCount = allDevices.length;
    
    if (counter) {
        counter.textContent = `${selectedCount} seleccionados de ${filteredCount} dispositivos`;
    }
    
    if (pagination) {
        pagination.textContent = `Mostrando ${filteredCount} de ${totalCount} dispositivos totales`;
    }
}

function getSelectedCount() {
    return filteredDevices.reduce((count, device) => {
        const deviceId = (device.device_id || device.id || '').toString();
        const isAssigned = assignedDeviceIds.includes(deviceId);
        const isPending = pendingChanges.has(deviceId);
        const willBeAssigned = (isAssigned && !isPending) || (!isAssigned && isPending);
        
        return willBeAssigned ? count + 1 : count;
    }, 0);
}

function updateActionButtons() {
    const saveButton = document.getElementById('saveDeviceAssignments');
    if (saveButton) {
        const hasPendingChanges = pendingChanges.size > 0;
        saveButton.disabled = !hasPendingChanges;
        saveButton.innerHTML = hasPendingChanges ? 
            `<i class="fas fa-save me-1"></i>Guardar Cambios (${pendingChanges.size})` : 
            '<i class="fas fa-save me-1"></i>Guardar Cambios';
    }
}

function showLoading(show) {
    const loading = document.getElementById('deviceModalLoading');
    const content = document.getElementById('deviceModalContent');
    
    if (loading) loading.style.display = show ? 'block' : 'none';
    if (content) content.style.display = show ? 'none' : 'block';
}

function resetModalState() {
    pendingChanges.clear();
    searchTerm = '';
    statusFilter = 'all';
    storeFilter = 'all';
    
    const alertsContainer = document.getElementById('deviceModalAlerts');
    if (alertsContainer) alertsContainer.innerHTML = '';
}

function handleModalClose() {
    resetModalState();
}

function showModalError(title, message) {
    const alertsContainer = document.getElementById('deviceModalAlerts');
    if (alertsContainer) {
        alertsContainer.innerHTML = `
            <div class="alert alert-danger alert-dismissible fade show" role="alert">
                <strong>${title}:</strong> ${message}
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            </div>
        `;
    }
}

function showSuccessMessage(message) {
    const alertsContainer = document.getElementById('deviceModalAlerts');
    if (alertsContainer) {
        alertsContainer.innerHTML = `
            <div class="alert alert-success alert-dismissible fade show" role="alert">
                <i class="fas fa-check-circle me-2"></i>${message}
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            </div>
        `;
    }
}

function showDeviceOperationSuccess(message) {
    const alertsContainer = document.getElementById('deviceOperationAlerts');
    if (alertsContainer) {
        alertsContainer.innerHTML = `
            <div class="alert alert-success alert-dismissible fade show" role="alert">
                <i class="fas fa-check-circle me-2"></i>${message}
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            </div>
        `;
        
        setTimeout(() => {
            const alert = alertsContainer.querySelector('.alert');
            if (alert) {
                alert.classList.remove('show');
                setTimeout(() => alert.remove(), 150);
            }
        }, 3000);
    }
}

function showDeviceOperationError(message) {
    const alertsContainer = document.getElementById('deviceOperationAlerts');
    if (alertsContainer) {
        alertsContainer.innerHTML = `
            <div class="alert alert-danger alert-dismissible fade show" role="alert">
                <i class="fas fa-exclamation-triangle me-2"></i>${message}
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            </div>
        `;
    }
}

function viewDeviceDetails(deviceId) {
    const device = allDevices.find(d => (d.device_id || d.id || '').toString() === deviceId);
    if (!device) {
        alert('No se encontr√≥ el dispositivo');
        return;
    }
    
    alert(`Dispositivo: ${device.name || device.device_name}\nID: ${device.device_id || device.id}\nTienda: ${device.tienda || 'N/A'}\nEstado: ${device.is_active ? 'Activo' : 'Inactivo'}`);
}

// Exposici√≥n global
window.handleDeviceCheckboxChange = handleDeviceCheckboxChange;
window.selectAllDevices = selectAllDevices;
window.deselectAllDevices = deselectAllDevices;
window.clearAllFilters = clearAllFilters;
window.saveDeviceAssignments = saveDeviceAssignments;
window.viewDeviceDetails = viewDeviceDetails;
window.loadAssignedDevicesInMainView = loadAssignedDevicesInMainView;
window.unassignDeviceFromMainView = unassignDeviceFromMainView;
window.showErrorInMainView = showErrorInMainView;

// Backup: Tambi√©n ejecutar cuando la ventana est√© completamente cargada
window.addEventListener('load', function() {
    console.log('üåê [BACKUP] Ventana completamente cargada, verificando dispositivos...');
    
    // Solo ejecutar si no se han cargado a√∫n o si hay error
    const assignedDevicesList = document.getElementById('assignedDevicesList');
    if (assignedDevicesList) {
        const hasLoadingRow = assignedDevicesList.querySelector('#loadingRow');
        const hasErrorAlert = assignedDevicesList.querySelector('.alert-danger');
        
        if (hasLoadingRow || hasErrorAlert) {
            console.log('üîÑ [BACKUP] Ejecutando carga de dispositivos como respaldo...');
            setTimeout(() => {
                loadAssignedDevicesInMainView().catch(error => {
                    console.error('‚ùå [BACKUP] Error en carga de respaldo:', error);
                });
            }, 500);
        } else {
            console.log('‚úÖ [BACKUP] Los dispositivos ya est√°n cargados correctamente');
        }
    }
});

console.log('‚úÖ Device assignment modal (versi√≥n CORREGIDA) cargado');
</script>

<script src="/static/js/assigned-devices-manager.js"></script>
{% endblock %}