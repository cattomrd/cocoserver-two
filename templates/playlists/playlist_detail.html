{% extends "base.html" %}

{% block content %}
{% block extra_css %}
<style src="/static/css/playlist_detail.css"></style>
{% endblock %}

{% block title %}
{% endblock %}
<div class="container-fluid">
    <!-- Campo oculto para el ID de la playlist -->
    <input type="hidden" id="playlist-id" value="{{ playlist.title}}">

    <!-- HEADER -->
    <div class="row mb-4">
            <div class="col-md-12">
                <div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pb-2 mb-3 border-bottom">
                <h1 class="h2">
                    <i class="fas fa-list text-primary"></i>
                    Editar Lista {{ playlist.title }}
                </h1>
            <div class="btn-toolbar mb-2 mb-md-0">
                <a href="/ui/playlists" class="btn btn-outline-secondary">Volver a la lista</a>
            </div>
        </div>
    
    <!-- BOTONES PRINCIPALES DE ACCIÓN -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card">
                <div class="card-body">
                    <div class="d-flex flex-wrap gap-2">
                        <button type="button" class="btn btn-warning" data-bs-toggle="modal" data-bs-target="#editPlaylistModal">
                            <i class="fas fa-edit me-1"></i> Editar Información
                        </button>
                        <button type="button" class="btn btn-danger" data-bs-toggle="modal" data-bs-target="#deletePlaylistModal">
                            <i class="fas fa-trash me-1"></i> Eliminar Lista
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    
    <!-- CONTENEDOR PRINCIPAL CON DOS COLUMNAS -->
    <div class="row mb-4">
        <!-- PANEL IZQUIERDO: VIDEOS DE LA PLAYLIST -->
        <div class="col-lg-6">
            <div class="card h-100">
                <div class="card-header">
                    <h5 class="mb-0">
                        <i class="fas fa-list me-2"></i>Videos en la Lista
                    </h5>
                </div>
                <div class="card-body p-0">
                    <!-- Zona de Drop para Videos -->
                    <div id="playlistDropZone" class="playlist-drop-zone" style="height: 560px; overflow-y: auto;">
                        <!-- Mensaje de Drop Zone Vacía -->
                        <div id="emptyPlaylistMessage" class="text-center py-5 m-3" 
                             style="{{ 'display:none' if playlist and playlist.videos else 'display:block' }}">
                            <i class="fas fa-plus-circle fa-3x text-muted mb-3"></i>
                            <h5 class="text-muted">Lista Vacía</h5>
                            <p class="text-muted">Arrastra videos desde la biblioteca para añadirlos a esta lista</p>
                        </div>
                        
                        <!-- Lista Ordenable de Videos -->
                        <div id="playlistVideosList" class="p-2">
                            {% if playlist and playlist.videos %}
                                {% for video in playlist.videos %}
                                <div class="playlist-video-item" data-video-id="{{ video.id }}" data-order="{{ loop.index }}">
                                    <div class="card mb-2 video-card">
                                        <div class="card-body p-2">
                                            <div class="d-flex align-items-center">
                                                <div class="drag-handle me-2">
                                                    <i class="fas fa-grip-vertical text-muted"></i>
                                                </div>
                                                <div class="video-thumbnail me-3">
                                                    {% if video.thumbnail %}
                                                        <img src="{{ video.thumbnail }}" alt="Thumbnail" 
                                                             class="img-thumbnail" style="width: 60px; height: 45px; object-fit: cover;">
                                                    {% else %}
                                                        <div class="bg-secondary d-flex align-items-center justify-content-center text-white" 
                                                             style="width: 60px; height: 45px; border-radius: 0.25rem;">
                                                            <i class="fas fa-video"></i>
                                                        </div>
                                                    {% endif %}
                                                </div>
                                                <div class="flex-grow-1">
                                                    <h6 class="mb-1 video-title">{{ video.title }}</h6>
                                                    <small class="text-muted video-duration">
                                                        <span class="badge bg-secondary me-1">{{ loop.index }}</span>
                                                        {{ video.duration|duration_format if video.duration else '0:00' }}
                                                    </small>
                                                </div>
                                                <div class="video-actions">
                                                    <button class="btn btn-sm btn-outline-danger" 
                                                            onclick="removeVideoFromPlaylist({{ video.id }})" 
                                                            title="Eliminar de la lista">
                                                        <i class="fas fa-times"></i>
                                                    </button>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                {% endfor %}
                            {% endif %}
                        </div>
                    </div>
                </div>
                <div class="card-footer">
                    <div class="d-flex justify-content-between align-items-center">
                        <small class="text-muted">
                            <i class="fas fa-sort"></i>
                            Arrastra para reordenar • Duración: <span id="totalPlaylistDuration">0:00</span>
                        </small>
                        <button class="btn btn-sm btn-outline-danger" onclick="clearPlaylist()" title="Vaciar lista">
                            <i class="fas fa-trash"></i> Vaciar
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- PANEL DERECHO: BIBLIOTECA DE VIDEOS OPTIMIZADA -->
    <div class="col-lg-6">
        <div class="card h-100"> <!-- Aseguramos que tenga la misma altura que el panel izquierdo -->
            <div class="card-header bg-primary text-white py-2"> <!-- Reducimos el padding vertical -->
                <div class="d-flex justify-content-between align-items-center">
                    <h5 class="mb-0 fs-6"> <!-- Reducimos el tamaño del título -->
                        <i class="fas fa-video me-1"></i>Biblioteca de Videos
                    </h5>
                    <div class="d-flex align-items-center">
                        <span class="badge bg-light text-dark me-2" id="availableVideoCount">0 videos</span>
                        <button class="btn btn-outline-light btn-sm btn-xs" onclick="loadAvailableVideos()" title="Recargar videos">
                            <i class="fas fa-sync-alt"></i>
                        </button>
                    </div>
                </div>
            </div>
            <div class="card-body p-0 d-flex flex-column"> <!-- Usamos flexbox para organizar el contenido -->
                <!-- Barra de búsqueda compacta -->
                <div class="px-2 py-2 border-bottom">
                    <div class="input-group input-group-sm video-search-container">
                        <input type="text" id="videoSearch" class="form-control form-control-sm" placeholder="Buscar videos...">
                        <button type="button" class="btn btn-outline-secondary btn-sm" id="clearVideoSearchBtn" title="Limpiar búsqueda">
                            <i class="fas fa-times"></i>
                        </button>
                    </div>
                </div>
                
                <!-- Lista de Videos Disponibles - Ahora con altura flexible -->
                <div id="availableVideosContainer" class="available-videos-drop-zone flex-grow-1 overflow-auto">
                    <div id="loadingAvailableVideos" class="text-center py-3">
                        <div class="spinner-border spinner-border-sm text-primary" role="status">
                            <span class="visually-hidden">Cargando...</span>
                        </div>
                        <p class="mt-1 text-muted small">Cargando videos...</p>
                    </div>
                    <div id="availableVideosList" class="p-1">
                        <!-- Aquí se cargan los videos -->
                    </div>
                </div>
            </div>
            <div class="card-footer py-1"> <!-- Footer más compacto -->
                <small class="text-muted fs-xs">
                    <i class="fas fa-info-circle"></i>
                    Arrastra videos hacia la lista o usa el botón <i class="fas fa-plus text-primary"></i>
                </small>
            </div>
        </div>
    </div>

    <!-- DISPOSITIVOS ASIGNADOS -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5 class="card-title mb-0">
                        <i class="fas fa-tv me-2"></i>Dispositivos Asignados ({{ playlist.assigned_devices|length }})
                    </h5>
                    <button class="btn btn-sm btn-primary" onclick="assignDevices()">
                        <i class="fas fa-plus me-1"></i>Asignar Dispositivo
                    </button>
                </div>
                <div class="card-body">
                    {% if playlist.assigned_devices %}
                        <div class="table-responsive">
                            <table class="table table-sm">
                                <thead>
                                    <tr>
                                        <th>Dispositivo</th>
                                        <th>Ubicación</th>
                                        <th>Estado</th>
                                        <th>Acciones</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for device in playlist.assigned_devices %}
                                    <tr>
                                        <td>
                                            <div class="fw-bold">{{ device.name }}</div>
                                            <small class="text-muted">{{ device.device_id }}</small>
                                        </td>
                                        <td>{{ device.location }} - {{ device.tienda }}</td>
                                        <td>
                                            {% if device.is_active %}
                                                <span class="badge bg-success">Activo</span>
                                            {% else %}
                                                <span class="badge bg-danger">Inactivo</span>
                                            {% endif %}
                                        </td>
                                        <td>
                                            <div class="btn-group btn-group-sm">
                                                <a href="/ui/devices/{{ device.device_id }}" class="btn btn-outline-primary" title="Ver dispositivo">
                                                    <i class="fas fa-eye"></i>
                                                </a>
                                                <button class="btn btn-outline-danger" onclick="unassignDevice('{{ device.device_id }}')" title="Desasignar">
                                                    <i class="fas fa-unlink"></i>
                                                </button>
                                            </div>
                                        </td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                    {% else %}
                        <div class="text-center py-4">
                            <i class="fas fa-tv fa-2x text-muted mb-3"></i>
                            <h6>No hay dispositivos asignados</h6>
                            <p class="text-muted">Asigna dispositivos para reproducir esta lista</p>
                            <button class="btn btn-primary" onclick="assignDevices()">
                                <i class="fas fa-plus me-1"></i>Asignar Dispositivo
                            </button>
                        </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>

</div>

<!-- MODALES -->

<!-- Modal para editar playlist -->
<div class="modal fade" id="editPlaylistModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Editar Lista de Reproducción</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="editPlaylistForm">
                    <div class="mb-3">
                        <label for="editTitle" class="form-label">Título</label>
                        <input type="text" class="form-control" id="editTitle" value="{{ playlist.title }}" required>
                    </div>
                    <div class="mb-3">
                        <label for="editDescription" class="form-label">Descripción</label>
                        <textarea class="form-control" id="editDescription" rows="3">{{ playlist.description or '' }}</textarea>
                    </div>
                    <div class="mb-3">
                        <label for="editStartDate" class="form-label">Fecha de Inicio</label>
                        <input type="datetime-local" class="form-control" id="editStartDate" 
                               value="{% if playlist.start_date %}{{ playlist.start_date.strftime('%Y-%m-%dT%H:%M') }}{% endif %}">
                    </div>
                    <div class="mb-3">
                        <label for="editExpirationDate" class="form-label">Fecha de Expiración</label>
                        <input type="datetime-local" class="form-control" id="editExpirationDate" 
                               value="{% if playlist.expiration_date %}{{ playlist.expiration_date.strftime('%Y-%m-%dT%H:%M') }}{% endif %}">
                    </div>
                    <div class="mb-3 form-check">
                        <input type="checkbox" class="form-check-input" id="editIsActive" {% if playlist.is_active %}checked{% endif %}>
                        <label class="form-check-label" for="editIsActive">Lista Activa</label>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                <button type="button" class="btn btn-primary" onclick="savePlaylistChanges()">Guardar Cambios</button>
            </div>
        </div>
    </div>
</div>

<!-- Modal para confirmar eliminación -->
<div class="modal fade" id="deletePlaylistModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title text-danger">Eliminar Lista de Reproducción</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <p>¿Estás seguro de que deseas eliminar esta lista de reproducción?</p>
                <p class="text-muted">Esta acción no se puede deshacer.</p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                <button type="button" class="btn btn-danger" onclick="confirmDeletePlaylist()">Eliminar</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}
<!-- SCRIPTS -->
{% block extra_scripts %}
<script src="/static/js/playlist_detail.js"></script>


<script>
// Constants
const API_URL = window.location.origin + '/api';
const playlistId = document.getElementById('playlist-id')?.value;

// DOM Elements
const videoSearchInput = document.getElementById('videoSearch');
const clearVideoSearchBtn = document.getElementById('clearVideoSearchBtn');
const availableVideosList = document.getElementById('availableVideosList');
const playlistVideosList = document.getElementById('playlistVideosList');
const loadingAvailableVideos = document.getElementById('loadingAvailableVideos');
const emptyPlaylistMessage = document.getElementById('emptyPlaylistMessage');
const availableVideoCount = document.getElementById('availableVideoCount');
const totalPlaylistDuration = document.getElementById('totalPlaylistDuration');

// Initialize the page
document.addEventListener('DOMContentLoaded', function() {
    // Load available videos
    loadAvailableVideos();
    
    // Set up search functionality
    setupSearchFilter();
    
    // Initialize drag and drop
    initializeDragAndDrop();
    
    // Calculate total duration
    calculateTotalDuration();
});

// Load available videos from API
async function loadAvailableVideos() {
    loadingAvailableVideos.style.display = 'block';
    availableVideosList.innerHTML = '';
    
    try {
        const response = await fetch(`${API_URL}/videos?available=true`);
        if (!response.ok) throw new Error('Failed to load videos');
        
        const videos = await response.json();
        
        loadingAvailableVideos.style.display = 'none';
        
        if (videos.length === 0) {
            availableVideosList.innerHTML = `
                <div class="text-center py-4">
                    <i class="fas fa-film fa-2x text-muted mb-3"></i>
                    <h6>No hay videos disponibles</h6>
                    <p class="text-muted">Sube videos para agregarlos a la lista</p>
                </div>
            `;
            availableVideoCount.textContent = '0 videos';
            return;
        }
        
        availableVideoCount.textContent = `${videos.length} videos`;
        
        // Render each video
        videos.forEach(video => {
            const videoElement = createVideoElement(video, 'library');
            availableVideosList.appendChild(videoElement);
        });
    } catch (error) {
        console.error('Error loading videos:', error);
        loadingAvailableVideos.style.display = 'none';
        availableVideosList.innerHTML = `
            <div class="text-center py-4 text-danger">
                <i class="fas fa-exclamation-triangle fa-2x mb-3"></i>
                <h6>Error al cargar videos</h6>
                <p>No se pudieron cargar los videos. Intente de nuevo.</p>
                <button class="btn btn-outline-primary" onclick="loadAvailableVideos()">
                    <i class="fas fa-sync-alt me-1"></i>Reintentar
                </button>
            </div>
        `;
    }
}

// Create a video element for display
function createVideoElement(video, type) {
    const videoDiv = document.createElement('div');
    videoDiv.className = type === 'library' ? 'available-video-item mb-2' : 'playlist-video-item';
    videoDiv.dataset.videoId = video.id;
    
    if (type === 'playlist') {
        videoDiv.draggable = true;
        videoDiv.dataset.order = video.order || 0;
    }
    
    const thumbnailSrc = video.thumbnail || '';
    const thumbnailHtml = thumbnailSrc 
        ? `<img src="${thumbnailSrc}" alt="Thumbnail" class="img-thumbnail" style="width: 60px; height: 45px; object-fit: cover;">`
        : `<div class="bg-secondary d-flex align-items-center justify-content-center text-white" style="width: 60px; height: 45px; border-radius: 0.25rem;"><i class="fas fa-video"></i></div>`;
    
    videoDiv.innerHTML = `
        <div class="card video-card">
            <div class="card-body p-2">
                <div class="d-flex align-items-center">
                    ${type === 'playlist' ? '<div class="drag-handle me-2"><i class="fas fa-grip-vertical text-muted"></i></div>' : ''}
                    <div class="video-thumbnail me-3">
                        ${thumbnailHtml}
                    </div>
                    <div class="flex-grow-1">
                        <h6 class="mb-1 video-title">${video.title}</h6>
                        <small class="text-muted video-duration">
                            ${type === 'playlist' ? `<span class="badge bg-secondary me-1">${video.order || ''}</span>` : ''}
                            ${formatDuration(video.duration)}
                        </small>
                    </div>
                    <div class="video-actions">
                        ${type === 'library' 
                            ? `<button class="btn btn-sm btn-outline-primary" onclick="addVideoToPlaylist(${video.id})" title="Agregar a la lista"><i class="fas fa-plus"></i></button>`
                            : `<button class="btn btn-sm btn-outline-danger" onclick="removeVideoFromPlaylist(${video.id})" title="Eliminar de la lista"><i class="fas fa-times"></i></button>`
                        }
                    </div>
                </div>
            </div>
        </div>
    `;
    
    // If it's a library video, make it draggable
    if (type === 'library') {
        videoDiv.draggable = true;
        videoDiv.addEventListener('dragstart', e => {
            e.dataTransfer.setData('text/plain', video.id);
            e.dataTransfer.effectAllowed = 'copy';
        });
    }
    
    return videoDiv;
}

// Initialize drag and drop functionality
function initializeDragAndDrop() {
    const dropZone = document.getElementById('playlistDropZone');
    
    // Make playlist items draggable
    const playlistItems = document.querySelectorAll('.playlist-video-item');
    playlistItems.forEach(item => {
        item.draggable = true;
        
        item.addEventListener('dragstart', e => {
            e.dataTransfer.setData('text/plain', item.dataset.videoId);
            e.dataTransfer.setData('source', 'playlist');
            e.dataTransfer.effectAllowed = 'move';
            item.classList.add('dragging');
        });
        
        item.addEventListener('dragend', () => {
            item.classList.remove('dragging');
        });
    });
    
    // Set up drop zone
    dropZone.addEventListener('dragover', e => {
        e.preventDefault();
        e.dataTransfer.dropEffect = 'move';
        dropZone.classList.add('highlight-drop-zone');
        
        // Find the position to insert
        const afterElement = getDragAfterElement(playlistVideosList, e.clientY);
        const draggable = document.querySelector('.dragging');
        
        if (draggable && afterElement) {
            playlistVideosList.insertBefore(draggable, afterElement);
        } else if (draggable) {
            playlistVideosList.appendChild(draggable);
        }
    });
    
    dropZone.addEventListener('dragleave', () => {
        dropZone.classList.remove('highlight-drop-zone');
    });
    
    dropZone.addEventListener('drop', async e => {
        e.preventDefault();
        dropZone.classList.remove('highlight-drop-zone');
        
        const videoId = e.dataTransfer.getData('text/plain');
        const source = e.dataTransfer.getData('source');
        
        if (source === 'playlist') {
            // Reorder in playlist
            await updatePlaylistOrder();
        } else {
            // Add from library
            await addVideoToPlaylist(videoId);
        }
    });
}

// Helper to determine drop position
function getDragAfterElement(container, y) {
    const draggableElements = [...container.querySelectorAll('.playlist-video-item:not(.dragging)')];
    
    return draggableElements.reduce((closest, child) => {
        const box = child.getBoundingClientRect();
        const offset = y - box.top - box.height / 2;
        
        if (offset < 0 && offset > closest.offset) {
            return { offset: offset, element: child };
        } else {
            return closest;
        }
    }, { offset: Number.NEGATIVE_INFINITY }).element;
}

// Add a video to the playlist
async function addVideoToPlaylist(videoId) {
    try {
        // Get current order numbers
        const playlistItems = document.querySelectorAll('.playlist-video-item');
        const order = playlistItems.length + 1;
        
        const response = await fetch(`${API_URL}/playlists/${playlistId}/videos`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                video_id: parseInt(videoId),
                order: order
            })
        });
        
        if (!response.ok) throw new Error('Failed to add video');
        
        // Reload the page to reflect changes
        window.location.reload();
    } catch (error) {
        console.error('Error adding video:', error);
        alert('Error al agregar el video a la lista');
    }
}

// Update the order of videos in the playlist
async function updatePlaylistOrder() {
    try {
        // Get all videos in their current order
        const playlistItems = document.querySelectorAll('.playlist-video-item');
        const videos = [];
        
        playlistItems.forEach((item, index) => {
            videos.push({
                video_id: parseInt(item.dataset.videoId),
                order: index + 1
            });
            
            // Update order badge
            const orderBadge = item.querySelector('.badge');
            if (orderBadge) orderBadge.textContent = index + 1;
        });
        
        const response = await fetch(`${API_URL}/playlists/${playlistId}/reorder`, {
            method: 'PUT',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({ videos })
        });
        
        if (!response.ok) throw new Error('Failed to update order');
        
        // Update local UI
        calculateTotalDuration();
    } catch (error) {
        console.error('Error updating order:', error);
        alert('Error al actualizar el orden de los videos');
    }
}

// Calculate total playlist duration
function calculateTotalDuration() {
    const playlistItems = document.querySelectorAll('.playlist-video-item');
    let totalSeconds = 0;
    
    playlistItems.forEach(item => {
        const durationText = item.querySelector('.video-duration').textContent;
        // Extract time part (remove the order badge)
        const timePart = durationText.split(/\s+/).pop();
        totalSeconds += durationToSeconds(timePart);
    });
    
    totalPlaylistDuration.textContent = formatDuration(totalSeconds);
    
    // Show/hide empty message
    emptyPlaylistMessage.style.display = playlistItems.length === 0 ? 'block' : 'none';
}

// Convert duration string to seconds
function durationToSeconds(duration) {
    if (!duration || duration === '0:00') return 0;
    
    const parts = duration.split(':').map(p => parseInt(p));
    if (parts.length === 3) {
        return parts[0] * 3600 + parts[1] * 60 + parts[2];
    } else if (parts.length === 2) {
        return parts[0] * 60 + parts[1];
    } else {
        return parseInt(duration) || 0;
    }
}

// Format seconds to HH:MM:SS or MM:SS
function formatDuration(seconds) {
    if (!seconds) return '0:00';
    
    seconds = parseInt(seconds);
    const hours = Math.floor(seconds / 3600);
    const minutes = Math.floor((seconds % 3600) / 60);
    const secs = seconds % 60;
    
    if (hours > 0) {
        return `${hours}:${minutes.toString().padStart(2, '0')}:${secs.toString().padStart(2, '0')}`;
    } else {
        return `${minutes}:${secs.toString().padStart(2, '0')}`;
    }
}

// Set up search filter functionality
function setupSearchFilter() {
    if (!videoSearchInput || !clearVideoSearchBtn) return;
    
    videoSearchInput.addEventListener('input', filterVideos);
    
    clearVideoSearchBtn.addEventListener('click', () => {
        videoSearchInput.value = '';
        filterVideos();
    });
}

// Filter videos based on search input
function filterVideos() {
    const searchTerm = videoSearchInput.value.toLowerCase().trim();
    const videos = document.querySelectorAll('.available-video-item');
    
    videos.forEach(video => {
        const title = video.querySelector('.video-title').textContent.toLowerCase();
        if (title.includes(searchTerm) || searchTerm === '') {
            video.style.display = 'block';
        } else {
            video.style.display = 'none';
        }
    });
}

// Add multiple videos to the playlist
function addVideosToPlaylist() {
    // Open a modal to select multiple videos
    const modal = document.createElement('div');
    modal.className = 'modal fade';
    modal.id = 'addVideosModal';
    modal.setAttribute('tabindex', '-1');
    modal.setAttribute('aria-hidden', 'true');
    
    modal.innerHTML = `
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Agregar Videos a la Lista</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-3">
                        <input type="text" class="form-control" id="modalVideoSearch" placeholder="Buscar videos...">
                    </div>
                    <div id="modalVideosList" style="max-height: 400px; overflow-y: auto;">
                        <div class="text-center py-3">
                            <div class="spinner-border text-primary" role="status">
                                <span class="visually-hidden">Cargando...</span>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                    <button type="button" class="btn btn-primary" id="addSelectedVideos">Agregar Seleccionados</button>
                </div>
            </div>
        </div>
    `;
    
    document.body.appendChild(modal);
    
    // Initialize Bootstrap modal
    const modalInstance = new bootstrap.Modal(modal);
    modalInstance.show();
    
    // Load videos in modal
    loadVideosForModal();
    
    // Handle search in modal
    const modalSearchInput = document.getElementById('modalVideoSearch');
    modalSearchInput.addEventListener('input', () => {
        const searchTerm = modalSearchInput.value.toLowerCase().trim();
        const videos = document.querySelectorAll('#modalVideosList .video-item');
        
        videos.forEach(video => {
            const title = video.querySelector('.video-title').textContent.toLowerCase();
            if (title.includes(searchTerm) || searchTerm === '') {
                video.style.display = 'block';
            } else {
                video.style.display = 'none';
            }
        });
    });
    
    // Handle add selected
    const addSelectedBtn = document.getElementById('addSelectedVideos');
    addSelectedBtn.addEventListener('click', async () => {
        const selectedVideos = document.querySelectorAll('#modalVideosList input[type="checkbox"]:checked');
        if (selectedVideos.length === 0) {
            alert('Seleccione al menos un video para agregar');
            return;
        }
        
        const videoIds = Array.from(selectedVideos).map(cb => parseInt(cb.value));
        
        try {
            const response = await fetch(`${API_URL}/playlists/${playlistId}/videos/batch`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    video_ids: videoIds
                })
            });
            
            if (!response.ok) throw new Error('Failed to add videos');
            
            modalInstance.hide();
            window.location.reload();
        } catch (error) {
            console.error('Error adding videos:', error);
            alert('Error al agregar los videos seleccionados');
        }
    });
    
    // Clean up on modal close
    modal.addEventListener('hidden.bs.modal', () => {
        document.body.removeChild(modal);
    });
}

// Load videos for the modal
async function loadVideosForModal() {
    const modalVideosList = document.getElementById('modalVideosList');
    
    try {
        const response = await fetch(`${API_URL}/videos?available=true`);
        if (!response.ok) throw new Error('Failed to load videos');
        
        const videos = await response.json();
        
        if (videos.length === 0) {
            modalVideosList.innerHTML = `
                <div class="text-center py-4">
                    <i class="fas fa-film fa-2x text-muted mb-3"></i>
                    <h6>No hay videos disponibles</h6>
                    <p class="text-muted">Sube videos para agregarlos a la lista</p>
                </div>
            `;
            return;
        }
        
        modalVideosList.innerHTML = '';
        
        // Get current playlist videos to exclude
        const currentPlaylistVideoIds = Array.from(
            document.querySelectorAll('.playlist-video-item')
        ).map(item => parseInt(item.dataset.videoId));
        
        // Render each video with checkbox
        videos.forEach(video => {
            // Skip videos already in playlist
            if (currentPlaylistVideoIds.includes(video.id)) return;
            
            const videoDiv = document.createElement('div');
            videoDiv.className = 'video-item mb-2';
            
            const thumbnailSrc = video.thumbnail || '';
            const thumbnailHtml = thumbnailSrc 
                ? `<img src="${thumbnailSrc}" alt="Thumbnail" class="img-thumbnail" style="width: 60px; height: 45px; object-fit: cover;">`
                : `<div class="bg-secondary d-flex align-items-center justify-content-center text-white" style="width: 60px; height: 45px; border-radius: 0.25rem;"><i class="fas fa-video"></i></div>`;
            
            videoDiv.innerHTML = `
                <div class="card">
                    <div class="card-body p-2">
                        <div class="d-flex align-items-center">
                            <div class="form-check me-2">
                                <input class="form-check-input" type="checkbox" value="${video.id}" id="video-${video.id}">
                            </div>
                            <div class="video-thumbnail me-3">
                                ${thumbnailHtml}
                            </div>
                            <div class="flex-grow-1">
                                <h6 class="mb-1 video-title">${video.title}</h6>
                                <small class="text-muted">${formatDuration(video.duration)}</small>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            
            modalVideosList.appendChild(videoDiv);
        });
    } catch (error) {
        console.error('Error loading videos for modal:', error);
        modalVideosList.innerHTML = `
            <div class="text-center py-4 text-danger">
                <i class="fas fa-exclamation-triangle fa-2x mb-3"></i>
                <h6>Error al cargar videos</h6>
                <p>No se pudieron cargar los videos. Intente de nuevo.</p>
            </div>
        `;
    }
}

// Clear all videos from playlist
async function clearPlaylist() {
    if (!confirm('¿Estás seguro de vaciar toda la lista? Esta acción eliminará todos los videos de la lista.')) {
        return;
    }
    
    try {
        const response = await fetch(`${API_URL}/playlists/${playlistId}/videos/clear`, {
            method: 'DELETE'
        });
        
        if (!response.ok) throw new Error('Failed to clear playlist');
        
        window.location.reload();
    } catch (error) {
        console.error('Error clearing playlist:', error);
        alert('Error al vaciar la lista de reproducción');
    }
}

// Function to assign devices
async function assignDevices() {
    // Create modal for device selection
    const modal = document.createElement('div');
    modal.className = 'modal fade';
    modal.id = 'assignDevicesModal';
    modal.setAttribute('tabindex', '-1');
    modal.setAttribute('aria-hidden', 'true');
    
    modal.innerHTML = `
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Asignar Dispositivos</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-3">
                        <input type="text" class="form-control" id="deviceSearch" placeholder="Buscar dispositivos...">
                    </div>
                    <div id="devicesList" style="max-height: 400px; overflow-y: auto;">
                        <div class="text-center py-3">
                            <div class="spinner-border text-primary" role="status">
                                <span class="visually-hidden">Cargando...</span>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                    <button type="button" class="btn btn-primary" id="assignSelectedDevices">Asignar Seleccionados</button>
                </div>
            </div>
        </div>
    `;
    
    document.body.appendChild(modal);
    
    // Initialize Bootstrap modal
    const modalInstance = new bootstrap.Modal(modal);
    modalInstance.show();
    
    // Load devices
    loadDevicesForModal();
    
    // Handle search
    const deviceSearchInput = document.getElementById('deviceSearch');
    deviceSearchInput.addEventListener('input', () => {
        const searchTerm = deviceSearchInput.value.toLowerCase().trim();
        const devices = document.querySelectorAll('#devicesList .device-item');
        
        devices.forEach(device => {
            const name = device.querySelector('.device-name').textContent.toLowerCase();
            const location = device.querySelector('.device-location').textContent.toLowerCase();
            
            if (name.includes(searchTerm) || location.includes(searchTerm) || searchTerm === '') {
                device.style.display = 'block';
            } else {
                device.style.display = 'none';
            }
        });
    });
    
    // Handle assign selected
    const assignBtn = document.getElementById('assignSelectedDevices');
    assignBtn.addEventListener('click', async () => {
        const selectedDevices = document.querySelectorAll('#devicesList input[type="checkbox"]:checked');
        if (selectedDevices.length === 0) {
            alert('Seleccione al menos un dispositivo para asignar');
            return;
        }
        
        const deviceIds = Array.from(selectedDevices).map(cb => cb.value);
        
        try {
            const response = await fetch(`${API_URL}/device-playlists/batch`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    device_ids: deviceIds,
                    playlist_id: parseInt(playlistId)
                })
            });
            
            if (!response.ok) throw new Error('Failed to assign devices');
            
            modalInstance.hide();
            window.location.reload();
        } catch (error) {
            console.error('Error assigning devices:', error);
            alert('Error al asignar los dispositivos seleccionados');
        }
    });
    
    // Clean up on modal close
    modal.addEventListener('hidden.bs.modal', () => {
        document.body.removeChild(modal);
    });
}

// Load devices for the modal
async function loadDevicesForModal() {
    const devicesList = document.getElementById('devicesList');
    
    try {
        const response = await fetch(`${API_URL}/devices?available=true`);
        if (!response.ok) throw new Error('Failed to load devices');
        
        const devices = await response.json();
        
        if (devices.length === 0) {
            devicesList.innerHTML = `
                <div class="text-center py-4">
                    <i class="fas fa-tv fa-2x text-muted mb-3"></i>
                    <h6>No hay dispositivos disponibles</h6>
                    <p class="text-muted">Registre dispositivos para asignarlos a esta lista</p>
                </div>
            `;
            return;
        }
        
        devicesList.innerHTML = '';
        
        // Get currently assigned devices to exclude
        const currentAssignedDeviceIds = Array.from(
            document.querySelectorAll('table tbody tr')
        ).map(row => {
            const deviceId = row.querySelector('td:first-child small').textContent;
            return deviceId;
        });
        
        // Render each device with checkbox
        devices.forEach(device => {
            // Skip already assigned devices
            if (currentAssignedDeviceIds.includes(device.device_id)) return;
            
            const deviceDiv = document.createElement('div');
            deviceDiv.className = 'device-item mb-2';
            
            deviceDiv.innerHTML = `
                <div class="card">
                    <div class="card-body p-2">
                        <div class="d-flex align-items-center">
                            <div class="form-check me-2">
                                <input class="form-check-input" type="checkbox" value="${device.device_id}" id="device-${device.device_id}">
                            </div>
                            <div class="me-3">
                                <i class="fas fa-tv fa-2x text-primary"></i>
                            </div>
                            <div class="flex-grow-1">
                                <h6 class="mb-1 device-name">${device.name}</h6>
                                <small class="text-muted device-location">${device.location} - ${device.tienda || 'N/A'}</small>
                            </div>
                            <div>
                                ${device.is_active 
                                    ? '<span class="badge bg-success">Activo</span>' 
                                    : '<span class="badge bg-danger">Inactivo</span>'}
                            </div>
                        </div>
                    </div>
                </div>
            `;
            
            devicesList.appendChild(deviceDiv);
        });
    } catch (error) {
        console.error('Error loading devices:', error);
        devicesList.innerHTML = `
            <div class="text-center py-4 text-danger">
                <i class="fas fa-exclamation-triangle fa-2x mb-3"></i>
                <h6>Error al cargar dispositivos</h6>
                <p>No se pudieron cargar los dispositivos. Intente de nuevo.</p>
            </div>
        `;
    }
}

// Function to preview playlist
function previewPlaylist() {
    // Create modal for preview
    const modal = document.createElement('div');
    modal.className = 'modal fade';
    modal.id = 'previewPlaylistModal';
    modal.setAttribute('tabindex', '-1');
    modal.setAttribute('aria-hidden', 'true');
    
    modal.innerHTML = `
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Vista Previa: ${document.querySelector('h1').textContent}</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body p-0">
                    <div id="previewPlayer" class="ratio ratio-16x9">
                        <div class="d-flex align-items-center justify-content-center bg-dark text-white">
                            <div class="text-center">
                                <div class="spinner-border" role="status">
                                    <span class="visually-hidden">Cargando...</span>
                                </div>
                                <p class="mt-3">Cargando reproductor...</p>
                            </div>
                        </div>
                    </div>
                    <div class="p-3">
                        <div class="d-flex justify-content-between align-items-center mb-3">
                            <div>
                                <h6 id="currentVideoTitle">Cargando...</h6>
                                <small class="text-muted" id="currentVideoInfo"></small>
                            </div>
                            <div>
                                <button id="prevVideoBtn" class="btn btn-sm btn-outline-secondary" disabled>
                                    <i class="fas fa-step-backward"></i>
                                </button>
                                <button id="playPauseBtn" class="btn btn-sm btn-primary">
                                    <i class="fas fa-play"></i>
                                </button>
                                <button id="nextVideoBtn" class="btn btn-sm btn-outline-secondary">
                                    <i class="fas fa-step-forward"></i>
                                </button>
                            </div>
                        </div>
                        <div class="progress mb-3" style="height: 8px;">
                            <div id="videoProgressBar" class="progress-bar" role="progressbar" style="width: 0%"></div>
                        </div>
                        <div class="list-group" id="previewPlaylistItems" style="max-height: 200px; overflow-y: auto;">
                            <!-- Items se cargan dinámicamente -->
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cerrar</button>
                </div>
            </div>
        </div>
    `;
    
    document.body.appendChild(modal);
    
    // Initialize Bootstrap modal
    const modalInstance = new bootstrap.Modal(modal);
    modalInstance.show();
    
    // Load preview player
    loadPreviewPlayer();
    
    // Clean up on modal close
    modal.addEventListener('hidden.bs.modal', () => {
        document.body.removeChild(modal);
    });
}

// Load preview player
async function loadPreviewPlayer() {
    const previewPlayer = document.getElementById('previewPlayer');
    const previewPlaylistItems = document.getElementById('previewPlaylistItems');
    
    try {
        // Get playlist videos
        const response = await fetch(`${API_URL}/playlists/${playlistId}/videos`);
        if (!response.ok) throw new Error('Failed to load playlist videos');
        
        const videos = await response.json();
        
        if (videos.length === 0) {
            previewPlayer.innerHTML = `
                <div class="d-flex align-items-center justify-content-center bg-dark text-white h-100">
                    <div class="text-center">
                        <i class="fas fa-exclamation-circle fa-3x mb-3"></i>
                        <h5>No hay videos en esta lista</h5>
                        <p>Agregue videos para poder reproducir la lista</p>
                    </div>
                </div>
            `;
            previewPlaylistItems.innerHTML = '';
            return;
        }
        
        // Create playlist items
        videos.forEach((video, index) => {
            const item = document.createElement('a');
            item.href = '#';
            item.className = `list-group-item list-group-item-action ${index === 0 ? 'active' : ''}`;
            item.dataset.videoId = video.id;
            item.dataset.videoIndex = index;
            
            const thumbnailSrc = video.thumbnail || '';
            const thumbnailHtml = thumbnailSrc 
                ? `<img src="${thumbnailSrc}" alt="Thumbnail" class="img-thumbnail" style="width: 40px; height: 30px; object-fit: cover;">`
                : `<div class="bg-secondary d-flex align-items-center justify-content-center text-white" style="width: 40px; height: 30px; border-radius: 0.25rem;"><i class="fas fa-video"></i></div>`;
            
            item.innerHTML = `
                <div class="d-flex align-items-center">
                    <div class="me-2">${thumbnailHtml}</div>
                    <div class="flex-grow-1">
                        <div class="d-flex justify-content-between">
                            <div>${video.title}</div>
                            <small>${formatDuration(video.duration)}</small>
                        </div>
                    </div>
                </div>
            `;
            
            item.addEventListener('click', (e) => {
                e.preventDefault();
                changePreviewVideo(index);
            });
            
            previewPlaylistItems.appendChild(item);
        });
        
        // Load first video
        loadVideoInPlayer(videos[0]);
        
        // Set up controls
        const prevBtn = document.getElementById('prevVideoBtn');
        const nextBtn = document.getElementById('nextVideoBtn');
        const playPauseBtn = document.getElementById('playPauseBtn');
        
        prevBtn.addEventListener('click', () => {
            const currentIndex = parseInt(document.querySelector('#previewPlaylistItems .active').dataset.videoIndex);
            if (currentIndex > 0) {
                changePreviewVideo(currentIndex - 1);
            }
        });
        
        nextBtn.addEventListener('click', () => {
            const currentIndex = parseInt(document.querySelector('#previewPlaylistItems .active').dataset.videoIndex);
            if (currentIndex < videos.length - 1) {
                changePreviewVideo(currentIndex + 1);
            }
        });
        
        playPauseBtn.addEventListener('click', togglePlayPause);
        
    } catch (error) {
        console.error('Error loading preview:', error);
        previewPlayer.innerHTML = `
            <div class="d-flex align-items-center justify-content-center bg-dark text-white h-100">
                <div class="text-center">
                    <i class="fas fa-exclamation-triangle fa-3x mb-3"></i>
                    <h5>Error al cargar la vista previa</h5>
                    <p>No se pudo cargar el reproductor</p>
                </div>
            </div>
        `;
    }
}

// Load video in player
function loadVideoInPlayer(video) {
    const previewPlayer = document.getElementById('previewPlayer');
    const currentVideoTitle = document.getElementById('currentVideoTitle');
    const currentVideoInfo = document.getElementById('currentVideoInfo');
    
    // Update info
    currentVideoTitle.textContent = video.title;
    currentVideoInfo.textContent = `${formatDuration(video.duration)}`;
    
    // Create video element
    previewPlayer.innerHTML = '';
    const videoElement = document.createElement('video');
    videoElement.className = 'w-100 h-100';
    videoElement.id = 'videoElement';
    videoElement.controls = false;
    
    // Add source
    const source = document.createElement('source');
    source.src = video.url || `/videos/${video.id}/stream`;
    source.type = 'video/mp4';
    
    videoElement.appendChild(source);
    previewPlayer.appendChild(videoElement);
    
    // Set up progress tracking
    const progressBar = document.getElementById('videoProgressBar');
    videoElement.addEventListener('timeupdate', () => {
        const percent = (videoElement.currentTime / videoElement.duration) * 100;
        progressBar.style.width = `${percent}%`;
    });
    
    // Handle video end
    videoElement.addEventListener('ended', () => {
        const currentIndex = parseInt(document.querySelector('#previewPlaylistItems .active').dataset.videoIndex);
        const totalVideos = document.querySelectorAll('#previewPlaylistItems a').length;
        
        if (currentIndex < totalVideos - 1) {
            changePreviewVideo(currentIndex + 1);
        } else {
            // Reset to first video or stop
            changePreviewVideo(0);
        }
    });
    
    // Update play/pause button state
    const playPauseBtn = document.getElementById('playPauseBtn');
    videoElement.addEventListener('play', () => {
        playPauseBtn.innerHTML = '<i class="fas fa-pause"></i>';
    });
    
    videoElement.addEventListener('pause', () => {
        playPauseBtn.innerHTML = '<i class="fas fa-play"></i>';
    });
    
    // Auto play
    videoElement.play().catch(error => {
        console.warn('Auto-play prevented:', error);
        playPauseBtn.innerHTML = '<i class="fas fa-play"></i>';
    });
    
    // Update prev/next buttons
    updateNavigationButtons();
}

// Change video in preview
async function changePreviewVideo(index) {
    // Update active item
    const items = document.querySelectorAll('#previewPlaylistItems a');
    items.forEach(item => item.classList.remove('active'));
    items[index].classList.add('active');
    
    // Get video details
    const videoId = items[index].dataset.videoId;
    
    try {
        const response = await fetch(`${API_URL}/videos/${videoId}`);
        if (!response.ok) throw new Error('Failed to load video');
        
        const video = await response.json();
        loadVideoInPlayer(video);
        
    } catch (error) {
        console.error('Error loading video:', error);
        alert('Error al cargar el video');
    }
    
    // Update navigation buttons
    updateNavigationButtons();
}

// Update navigation buttons state
function updateNavigationButtons() {
    const currentIndex = parseInt(document.querySelector('#previewPlaylistItems .active').dataset.videoIndex);
    const totalVideos = document.querySelectorAll('#previewPlaylistItems a').length;
    
    const prevBtn = document.getElementById('prevVideoBtn');
    const nextBtn = document.getElementById('nextVideoBtn');
    
    prevBtn.disabled = currentIndex === 0;
    nextBtn.disabled = currentIndex === totalVideos - 1;
}

// Toggle play/pause
function togglePlayPause() {
    const videoElement = document.getElementById('videoElement');
    const playPauseBtn = document.getElementById('playPauseBtn');
    
    if (videoElement.paused) {
        videoElement.play();
        playPauseBtn.innerHTML = '<i class="fas fa-pause"></i>';
    } else {
        videoElement.pause();
        playPauseBtn.innerHTML = '<i class="fas fa-play"></i>';
    }
}

// Function to export playlist
function exportPlaylist() {
    // Create modal for export options
    const modal = document.createElement('div');
    modal.className = 'modal fade';
    modal.id = 'exportPlaylistModal';
    modal.setAttribute('tabindex', '-1');
    modal.setAttribute('aria-hidden', 'true');
    
    modal.innerHTML = `
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Exportar Lista de Reproducción</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="list-group">
                        <button class="list-group-item list-group-item-action" onclick="exportAsJson()">
                            <div class="d-flex align-items-center">
                                <i class="fas fa-file-code fa-2x text-primary me-3"></i>
                                <div>
                                    <h6 class="mb-1">Exportar como JSON</h6>
                                    <small class="text-muted">Formato de datos para sistemas</small>
                                </div>
                            </div>
                        </button>
                        <button class="list-group-item list-group-item-action" onclick="exportAsCsv()">
                            <div class="d-flex align-items-center">
                                <i class="fas fa-file-csv fa-2x text-success me-3"></i>
                                <div>
                                    <h6 class="mb-1">Exportar como CSV</h6>
                                    <small class="text-muted">Compatible con Excel y hojas de cálculo</small>
                                </div>
                            </div>
                        </button>
                        <button class="list-group-item list-group-item-action" onclick="exportAsPdf()">
                            <div class="d-flex align-items-center">
                                <i class="fas fa-file-pdf fa-2x text-danger me-3"></i>
                                <div>
                                    <h6 class="mb-1">Exportar como PDF</h6>
                                    <small class="text-muted">Documento para imprimir o compartir</small>
                                </div>
                            </div>
                        </button>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cerrar</button>
                </div>
            </div>
        </div>
    `;
    
    document.body.appendChild(modal);
    
    // Initialize Bootstrap modal
    const modalInstance = new bootstrap.Modal(modal);
    modalInstance.show();
    
    // Clean up on modal close
    modal.addEventListener('hidden.bs.modal', () => {
        document.body.removeChild(modal);
    });
    
    // Define export functions in window scope
    window.exportAsJson = exportPlaylistAsJson;
    window.exportAsCsv = exportPlaylistAsCsv;
    window.exportAsPdf = exportPlaylistAsPdf;
}

// Export playlist as JSON
async function exportPlaylistAsJson() {
    try {
        // Get playlist details
        const response = await fetch(`${API_URL}/playlists/${playlistId}?include_videos=true`);
        if (!response.ok) throw new Error('Failed to load playlist');
        
        const playlist = await response.json();
        
        // Convert to JSON and create download
        const jsonData = JSON.stringify(playlist, null, 2);
        const blob = new Blob([jsonData], { type: 'application/json' });
        const url = URL.createObjectURL(blob);
        
        // Create download link
        const a = document.createElement('a');
        a.href = url;
        a.download = `playlist-${playlistId}.json`;
        document.body.appendChild(a);
        a.click();
        
        // Clean up
        document.body.removeChild(a);
        URL.revokeObjectURL(url);
        
        // Close modal
        const modal = bootstrap.Modal.getInstance(document.getElementById('exportPlaylistModal'));
        if (modal) modal.hide();
        
    } catch (error) {
        console.error('Error exporting playlist:', error);
        alert('Error al exportar la lista de reproducción');
    }
}

// Export playlist as CSV
async function exportPlaylistAsCsv() {
    try {
        // Get playlist details
        const response = await fetch(`${API_URL}/playlists/${playlistId}?include_videos=true`);
        if (!response.ok) throw new Error('Failed to load playlist');
        
        const playlist = await response.json();
        
        // Create CSV header
        let csvContent = 'ID,Orden,Título,Duración,URL\n';
        
        // Add video rows
        if (playlist.videos && playlist.videos.length > 0) {
            playlist.videos.forEach(video => {
                const row = [
                    video.id,
                    video.order || '',
                    `"${video.title.replace(/"/g, '""')}"`,
                    formatDuration(video.duration),
                    video.url || ''
                ];
                csvContent += row.join(',') + '\n';
            });
        }
        
        // Create download
        const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
        const url = URL.createObjectURL(blob);
        
        // Create download link
        const a = document.createElement('a');
        a.href = url;
        a.download = `playlist-${playlistId}.csv`;
        document.body.appendChild(a);
        a.click();
        
        // Clean up
        document.body.removeChild(a);
        URL.revokeObjectURL(url);
        
        // Close modal
        const modal = bootstrap.Modal.getInstance(document.getElementById('exportPlaylistModal'));
        if (modal) modal.hide();
        
    } catch (error) {
        console.error('Error exporting playlist:', error);
        alert('Error al exportar la lista de reproducción');
    }
}

// Export playlist as PDF
async function exportPlaylistAsPdf() {
    alert('Función de exportación a PDF en desarrollo');
    
    // Cierra el modal
    const modal = bootstrap.Modal.getInstance(document.getElementById('exportPlaylistModal'));
    if (modal) modal.hide();
}

// Initialize the page when loaded
document.addEventListener('DOMContentLoaded', function() {
    loadAvailableVideos();
    calculateTotalDuration();
    initializeDragAndDrop();
});

</script>

{% endblock %}