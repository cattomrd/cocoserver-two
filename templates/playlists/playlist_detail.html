{% extends "base.html" %}

{% block title %}
    {% if playlist %}
        Editar Lista: {{ playlist.title }}
    {% else %}
        Gesti√≥n de Videos y Listas
    {% endif %}
{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="/static/css/playlists.css">
<style>
/* ==========================================
   ESTILOS ESPEC√çFICOS PARA PLAYLIST DETAIL
   ========================================== */

:root {
    --primary-color: #0d6efd;
    --success-color: #198754;
    --warning-color: #ffc107;
    --danger-color: #dc3545;
    --info-color: #0dcaf0;
    --secondary-color: #6c757d;
    --light-color: #f8f9fa;
    --dark-color: #212529;
    --border-radius: 0.5rem;
    --box-shadow: 0 0.125rem 0.25rem rgba(0, 0, 0, 0.075);
    --box-shadow-lg: 0 0.5rem 1rem rgba(0, 0, 0, 0.15);
    --transition: all 0.15s ease-in-out;
}

/* Header y t√≠tulo */
.page-header {
    background: linear-gradient(135deg, var(--primary-color), var(--info-color));
    color: white;
    padding: 2rem 0;
    margin-bottom: 2rem;
    border-radius: var(--border-radius);
}

.page-title {
    font-size: 2.5rem;
    font-weight: 700;
    margin-bottom: 0.5rem;
}

.page-subtitle {
    opacity: 0.9;
    font-size: 1.1rem;
}

/* Tarjetas de estad√≠sticas */
.stat-card {
    background: white;
    padding: 1.5rem;
    border-radius: var(--border-radius);
    text-align: center;
    box-shadow: var(--box-shadow);
    transition: var(--transition);
    border: 1px solid rgba(0, 0, 0, 0.1);
}

.stat-card:hover {
    transform: translateY(-2px);
    box-shadow: var(--box-shadow-lg);
}

.stat-value {
    font-size: 2.5rem;
    font-weight: 700;
    color: var(--primary-color);
    margin-bottom: 0.5rem;
}

.stat-label {
    color: var(--secondary-color);
    font-size: 0.9rem;
    font-weight: 500;
    text-transform: uppercase;
    letter-spacing: 0.5px;
}

/* Botones de acci√≥n */
.action-buttons {
    background: white;
    padding: 1rem;
    border-radius: var(--border-radius);
    box-shadow: var(--box-shadow);
    margin-bottom: 2rem;
}

.btn-action {
    padding: 0.75rem 1.5rem;
    font-weight: 500;
    border-radius: 0.375rem;
    transition: var(--transition);
    text-decoration: none;
    display: inline-flex;
    align-items: center;
    gap: 0.5rem;
}

.btn-action:hover {
    transform: translateY(-1px);
    box-shadow: 0 0.25rem 0.5rem rgba(0, 0, 0, 0.1);
}

/* Paneles principales */
.main-panel {
    background: white;
    border-radius: var(--border-radius);
    box-shadow: var(--box-shadow);
    overflow: hidden;
}

.panel-header {
    background: var(--light-color);
    padding: 1rem 1.5rem;
    border-bottom: 1px solid rgba(0, 0, 0, 0.1);
    font-weight: 600;
}

.panel-body {
    padding: 1.5rem;
}

/* Videos de la playlist */
.playlist-videos-container {
    min-height: 400px;
    max-height: 600px;
    overflow-y: auto;
}

.video-item {
    display: flex;
    align-items: center;
    padding: 1rem;
    border: 1px solid #e9ecef;
    border-radius: 0.375rem;
    margin-bottom: 0.75rem;
    background: white;
    transition: var(--transition);
    cursor: grab;
}

.video-item:hover {
    border-color: var(--primary-color);
    box-shadow: 0 0.125rem 0.25rem rgba(13, 110, 253, 0.15);
}

.video-item.dragging {
    opacity: 0.5;
    transform: rotate(5deg);
}

.video-thumbnail {
    width: 80px;
    height: 60px;
    border-radius: 0.375rem;
    object-fit: cover;
    margin-right: 1rem;
    background: var(--light-color);
}

.video-info {
    flex: 1;
}

.video-title {
    font-weight: 600;
    margin-bottom: 0.25rem;
    color: var(--dark-color);
}

.video-description {
    color: var(--secondary-color);
    font-size: 0.875rem;
    margin-bottom: 0.25rem;
}

.video-meta {
    display: flex;
    gap: 1rem;
    font-size: 0.75rem;
    color: var(--secondary-color);
}

.video-actions {
    display: flex;
    gap: 0.5rem;
}

.drag-handle {
    cursor: grab;
    color: var(--secondary-color);
    padding: 0.5rem;
}

.drag-handle:hover {
    color: var(--primary-color);
}

/* Biblioteca de videos */
.video-library {
    max-height: 600px;
    overflow-y: auto;
}

.available-video {
    display: flex;
    align-items: center;
    padding: 0.75rem;
    border: 1px solid #e9ecef;
    border-radius: 0.375rem;
    margin-bottom: 0.5rem;
    background: white;
    transition: var(--transition);
}

.available-video:hover {
    border-color: var(--success-color);
    background: rgba(25, 135, 84, 0.05);
}

.available-video .video-thumbnail {
    width: 60px;
    height: 45px;
    margin-right: 0.75rem;
}

/* Dispositivos asignados */
.devices-section {
    margin-top: 2rem;
}

.device-item {
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 1rem;
    border: 1px solid #e9ecef;
    border-radius: 0.375rem;
    margin-bottom: 0.5rem;
    background: white;
    transition: var(--transition);
}

.device-item:hover {
    border-color: var(--info-color);
    background: rgba(13, 202, 240, 0.05);
}

.device-info {
    flex: 1;
}

.device-name {
    font-weight: 600;
    margin-bottom: 0.25rem;
}

.device-meta {
    color: var(--secondary-color);
    font-size: 0.875rem;
}

.device-status {
    margin-right: 1rem;
}

.status-online {
    color: var(--success-color);
}

.status-offline {
    color: var(--secondary-color);
}

/* Modal customizations */
.modal-xl {
    max-width: 90%;
}

#assignDeviceModal .table-responsive {
    max-height: 400px;
    border: 1px solid #dee2e6;
    border-radius: 0.375rem;
}

#assignDeviceModal .pending-change {
    background-color: #fff3cd !important;
    border-left: 4px solid var(--warning-color);
}

/* Controles y filtros */
.search-controls {
    background: var(--light-color);
    padding: 1rem;
    border-radius: 0.375rem;
    margin-bottom: 1rem;
}

.form-control:focus,
.form-select:focus {
    border-color: var(--primary-color);
    box-shadow: 0 0 0 0.2rem rgba(13, 110, 253, 0.25);
}

/* Badges y labels */
.badge-custom {
    padding: 0.5rem 0.75rem;
    font-size: 0.75rem;
    font-weight: 500;
    border-radius: 0.375rem;
}

.duration-badge {
    background: var(--info-color);
    color: white;
}

.video-count-badge {
    background: linear-gradient(45deg, var(--primary-color), var(--info-color));
    color: white;
}

/* Estados de carga */
.loading-spinner {
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    padding: 3rem;
    color: var(--secondary-color);
}

.empty-state {
    text-align: center;
    padding: 3rem;
    color: var(--secondary-color);
}

.empty-state i {
    font-size: 3rem;
    margin-bottom: 1rem;
    opacity: 0.5;
}

/* Responsive */
@media (max-width: 768px) {
    .page-title {
        font-size: 2rem;
    }
    
    .video-item {
        flex-direction: column;
        align-items: flex-start;
        gap: 0.75rem;
    }
    
    .video-thumbnail {
        width: 100%;
        height: 120px;
        margin-right: 0;
    }
    
    .video-actions {
        width: 100%;
        justify-content: center;
    }
    
    .action-buttons {
        text-align: center;
    }
    
    .action-buttons .btn {
        margin-bottom: 0.5rem;
        width: 100%;
    }
}

@media (max-width: 576px) {
    .stat-card {
        margin-bottom: 1rem;
    }
    
    .stat-value {
        font-size: 2rem;
    }
}

/* Animaciones */
@keyframes slideIn {
    from {
        opacity: 0;
        transform: translateY(20px);
    }
    to {
        opacity: 1;
        transform: translateY(0);
    }
}

.fade-in {
    animation: slideIn 0.3s ease-out;
}

/* Utilidades */
.text-truncate-2 {
    overflow: hidden;
    display: -webkit-box;
    -webkit-line-clamp: 2;
    -webkit-box-orient: vertical;
}

.cursor-pointer {
    cursor: pointer;
}

.user-select-none {
    user-select: none;
}
</style>
{% endblock %}

{% block content %}
<!-- Datos de playlist para JavaScript -->
{% if playlist %}
<script type="application/json" id="playlist-data">{{ playlist | tojson | safe }}</script>
<input type="hidden" id="playlist-id" value="{{ playlist.id }}">
{% endif %}

<!-- HEADER DE LA P√ÅGINA -->
<div class="page-header">
    <div class="container-fluid">
        <div class="row align-items-center">
            <div class="col-lg-8">
                <h1 class="page-title">
                    <i class="fas fa-list-alt me-3"></i>
                    {% if playlist %}
                        {{ playlist.title }}
                    {% else %}
                        Gesti√≥n de Videos y Listas
                    {% endif %}
                </h1>
                <p class="page-subtitle mb-0">
                    {% if playlist %}
                        Edita y gestiona tu lista de reproducci√≥n
                    {% else %}
                        Crea y organiza tus listas de reproducci√≥n
                    {% endif %}
                </p>
            </div>
            <div class="col-lg-4 text-lg-end">
                <div class="d-flex gap-2 justify-content-lg-end justify-content-center">
                    <button type="button" class="btn btn-light" onclick="window.history.back()">
                        <i class="fas fa-arrow-left me-2"></i>Volver
                    </button>
                    {% if playlist %}
                    <button type="button" class="btn btn-warning" onclick="toggleEditMode()">
                        <i class="fas fa-edit me-2"></i>Editar Info
                    </button>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
</div>

<!-- SECCI√ìN DE ESTAD√çSTICAS -->
<div class="container-fluid">
    <div class="row mb-4">
        <div class="col-12">
            <div class="row g-3">
                <div class="col-md-3 col-6">
                    <div class="stat-card">
                        <div class="stat-value" id="totalVideos">0</div>
                        <div class="stat-label">Videos Total</div>
                    </div>
                </div>
                <div class="col-md-3 col-6">
                    <div class="stat-card">
                        <div class="stat-value" id="totalDuration">0m</div>
                        <div class="stat-label">Duraci√≥n Total</div>
                    </div>
                </div>
                <div class="col-md-3 col-6">
                    <div class="stat-card">
                        <div class="stat-value" id="activeVideos">0</div>
                        <div class="stat-label">Videos Activos</div>
                    </div>
                </div>
                <div class="col-md-3 col-6">
                    <div class="stat-card">
                        <div class="stat-value" id="assignedDevices">0</div>
                        <div class="stat-label">Dispositivos</div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- BOTONES DE ACCI√ìN PRINCIPALES -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="action-buttons">
                <div class="d-flex flex-wrap gap-2 justify-content-center">
                    <button type="button" class="btn btn-primary btn-action" onclick="previewPlaylist()" title="Ver lista completa">
                        <i class="fas fa-play"></i> Vista Previa
                    </button>
                    <button type="button" class="btn btn-success btn-action" data-bs-toggle="modal" data-bs-target="#assignDeviceModal" title="Asignar dispositivos">
                        <i class="fas fa-tv"></i> Asignar Dispositivos
                    </button>
                    <button type="button" class="btn btn-info btn-action" onclick="exportPlaylist()" title="Exportar playlist">
                        <i class="fas fa-download"></i> Exportar
                    </button>
                    <button type="button" class="btn btn-warning btn-action" onclick="savePlaylistChanges()" title="Guardar cambios">
                        <i class="fas fa-save"></i> Guardar
                    </button>
                    {% if playlist %}
                    <button type="button" class="btn btn-outline-danger btn-action" onclick="confirmDeletePlaylist()" title="Eliminar playlist">
                        <i class="fas fa-trash"></i> Eliminar
                    </button>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>

    <!-- CONTENEDOR PRINCIPAL: VIDEOS Y BIBLIOTECA -->
    <div class="row g-4">
        <!-- PANEL IZQUIERDO: VIDEOS DE LA PLAYLIST -->
        <div class="col-lg-7">
            <div class="main-panel">
                <div class="panel-header d-flex justify-content-between align-items-center">
                    <h5 class="mb-0">
                        <i class="fas fa-film me-2 text-primary"></i>
                        Videos de la Lista
                        <span class="badge bg-primary ms-2" id="playlistVideoCount">0</span>
                    </h5>
                    <div class="d-flex gap-2">
                        <button type="button" class="btn btn-sm btn-outline-secondary" onclick="clearPlaylist()" title="Limpiar lista">
                            <i class="fas fa-trash"></i>
                        </button>
                        <button type="button" class="btn btn-sm btn-outline-primary" onclick="shufflePlaylist()" title="Mezclar orden">
                            <i class="fas fa-random"></i>
                        </button>
                    </div>
                </div>
                <div class="panel-body">
                    <!-- Loading de videos de playlist -->
                    <div id="loadingPlaylistVideos" class="loading-spinner d-none">
                        <div class="spinner-border text-primary" role="status">
                            <span class="visually-hidden">Cargando...</span>
                        </div>
                        <p class="mt-2">Cargando videos de la lista...</p>
                    </div>
                    
                    <!-- Estado vac√≠o -->
                    <div id="playlistVideosEmpty" class="empty-state">
                        <i class="fas fa-film"></i>
                        <h5>No hay videos en esta lista</h5>
                        <p class="text-muted mb-3">Arrastra videos desde la biblioteca o usa el bot√≥n <i class="fas fa-plus"></i></p>
                        <small class="text-muted">
                            <i class="fas fa-hand-point-right me-1"></i>
                            Tip: Arrastra videos hacia la lista o usa <i class="fas fa-plus"></i>
                        </small>
                    </div>
                    
                    <!-- Contenedor de videos de la playlist -->
                    <div id="playlistVideosContainer" class="playlist-videos-container">
                        <div id="playlistVideosList">
                            <!-- Los videos se cargar√°n din√°micamente aqu√≠ -->
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- PANEL DERECHO: BIBLIOTECA DE VIDEOS -->
        <div class="col-lg-5">
            <div class="main-panel">
                <div class="panel-header">
                    <h5 class="mb-0">
                        <i class="fas fa-video me-2 text-success"></i>
                        Biblioteca de Videos
                        <span class="badge bg-success ms-2" id="availableVideoCount">0</span>
                    </h5>
                </div>
                <div class="panel-body">
                    <!-- Controles de b√∫squeda -->
                    <div class="search-controls">
                        <div class="row g-2">
                            <div class="col-md-8">
                                <div class="input-group input-group-sm">
                                    <span class="input-group-text">
                                        <i class="fas fa-search"></i>
                                    </span>
                                    <input type="text" id="videoSearchInput" class="form-control" 
                                           placeholder="Buscar videos...">
                                    <button class="btn btn-outline-secondary" type="button" id="clearVideoSearch">
                                        <i class="fas fa-times"></i>
                                    </button>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <select class="form-select form-select-sm" id="videoPageSize">
                                    <option value="10">10 por p√°gina</option>
                                    <option value="25" selected>25 por p√°gina</option>
                                    <option value="50">50 por p√°gina</option>
                                    <option value="all">Todos</option>
                                </select>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Loading de videos disponibles -->
                    <div id="loadingAvailableVideos" class="loading-spinner">
                        <div class="spinner-border text-success" role="status">
                            <span class="visually-hidden">Cargando...</span>
                        </div>
                        <p class="mt-2">Cargando biblioteca de videos...</p>
                    </div>
                    
                    <!-- Lista de videos disponibles -->
                    <div id="availableVideosContainer" class="video-library d-none">
                        <div id="availableVideosList">
                            <!-- Los videos disponibles se cargar√°n din√°micamente aqu√≠ -->
                        </div>
                        
                        <!-- Paginaci√≥n -->
                        <div class="d-flex justify-content-between align-items-center mt-3">
                            <div class="btn-group btn-group-sm">
                                <button class="btn btn-outline-secondary" id="prevPageBtn" onclick="goToPrevPage()" disabled>
                                    <i class="fas fa-chevron-left"></i>
                                </button>
                                <button class="btn btn-outline-secondary" id="nextPageBtn" onclick="goToNextPage()">
                                    <i class="fas fa-chevron-right"></i>
                                </button>
                            </div>
                            <small class="text-muted" id="paginationInfo">
                                P√°gina 1 de 1
                            </small>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- SECCI√ìN DE DISPOSITIVOS ASIGNADOS -->
    <div class="row mt-4">
        <div class="col-12">
            <div class="main-panel devices-section">
                <div class="panel-header d-flex justify-content-between align-items-center">
                    <h5 class="mb-0">
                        <i class="fas fa-tv me-2 text-info"></i>Dispositivos Asignados
                        <span class="badge bg-info ms-2" id="deviceCount">0</span>
                    </h5>
                    <button class="btn btn-outline-info btn-sm" data-bs-toggle="modal" data-bs-target="#assignDeviceModal">
                        <i class="fas fa-plus-circle me-1"></i> Asignar Dispositivo
                    </button>
                </div>
                <div class="panel-body">
                    <!-- Loading de dispositivos asignados -->
                    <div id="loadingAssignedDevices" class="loading-spinner d-none">
                        <div class="spinner-border text-info" role="status">
                            <span class="visually-hidden">Cargando...</span>
                        </div>
                        <p class="mt-2">Cargando dispositivos asignados...</p>
                    </div>
                    
                    <!-- Estado vac√≠o de dispositivos -->
                    <div id="assignedDevicesEmpty" class="empty-state">
                        <i class="fas fa-tv"></i>
                        <h5>No hay dispositivos asignados</h5>
                        <p class="text-muted mb-3">Asigna dispositivos para que puedan reproducir esta lista</p>
                        <button class="btn btn-outline-info" data-bs-toggle="modal" data-bs-target="#assignDeviceModal">
                            <i class="fas fa-plus-circle me-1"></i> Asignar Dispositivo
                        </button>
                    </div>
                    
                    <!-- Tabla de dispositivos asignados -->
                    <div id="assignedDevicesTable" class="table-responsive d-none">
                        <table class="table table-hover table-striped mb-0">
                            <thead class="table-light">
                                <tr>
                                    <th>Dispositivo</th>
                                    <th>Ubicaci√≥n</th>
                                    <th>Estado</th>
                                    <th>√öltima Conexi√≥n</th>
                                    <th class="text-end">Acciones</th>
                                </tr>
                            </thead>
                            <tbody id="assignedDevicesList">
                                <!-- Los dispositivos asignados se cargar√°n din√°micamente -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- MODAL PARA ASIGNAR DISPOSITIVOS -->
<div class="modal fade" id="assignDeviceModal" tabindex="-1" aria-labelledby="assignDeviceModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header bg-primary text-white">
                <h5 class="modal-title" id="assignDeviceModalLabel">
                    <i class="fas fa-tv me-2"></i>Asignar Dispositivos a la Lista
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Cerrar"></button>
            </div>
            <div class="modal-body">
                <!-- Controles de b√∫squeda y filtros -->
                <div class="row mb-3">
                    <div class="col-md-8">
                        <div class="input-group">
                            <span class="input-group-text">
                                <i class="fas fa-search"></i>
                            </span>
                            <input type="text" id="deviceSearchInput" class="form-control" 
                                   placeholder="Buscar dispositivos por nombre, ubicaci√≥n o MAC...">
                            <button class="btn btn-outline-secondary" type="button" id="clearDeviceSearch">
                                <i class="fas fa-times"></i> Limpiar
                            </button>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <select class="form-select" id="deviceStatusFilter">
                            <option value="all" selected>Todos los dispositivos</option>
                            <option value="online">Solo en l√≠nea</option>
                            <option value="offline">Solo fuera de l√≠nea</option>
                            <option value="assigned">Ya asignados</option>
                            <option value="unassigned">No asignados</option>
                        </select>
                    </div>
                </div>

                <!-- Informaci√≥n de estado -->
                <div class="row mb-3">
                    <div class="col-12">
                        <div class="alert alert-info d-flex align-items-center" role="alert">
                            <i class="fas fa-info-circle me-2"></i>
                            <div>
                                <strong>Instrucciones:</strong> 
                                Marca o desmarca los dispositivos que deseas asignar o desasignar de esta lista de reproducci√≥n.
                                Los cambios se aplicar√°n al hacer clic en "Guardar Cambios".
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Estad√≠sticas r√°pidas -->
                <div class="row mb-3">
                    <div class="col-12">
                        <div class="d-flex flex-wrap gap-2">
                            <span class="badge bg-primary" id="totalDevicesBadge">
                                <i class="fas fa-tv me-1"></i>0 dispositivos
                            </span>
                            <span class="badge bg-success" id="onlineDevicesBadge">
                                <i class="fas fa-circle me-1"></i>0 en l√≠nea
                            </span>
                            <span class="badge bg-warning" id="assignedDevicesBadge">
                                <i class="fas fa-link me-1"></i>0 asignados
                            </span>
                            <span class="badge bg-info" id="pendingChangesBadge">
                                <i class="fas fa-clock me-1"></i>0 cambios pendientes
                            </span>
                        </div>
                    </div>
                </div>

                <!-- Tabla de dispositivos disponibles -->
                <div class="table-responsive" style="max-height: 400px;">
                    <table class="table table-hover table-sm">
                        <thead class="table-light sticky-top">
                            <tr>
                                <th style="width: 50px;">
                                    <div class="form-check">
                                        <input class="form-check-input" type="checkbox" id="selectAllDevices">
                                        <label class="form-check-label" for="selectAllDevices"></label>
                                    </div>
                                </th>
                                <th>Dispositivo</th>
                                <th style="width: 100px;">Estado</th>
                                <th style="width: 120px;">Asignaci√≥n</th>
                                <th style="width: 150px;">Ubicaci√≥n</th>
                                <th style="width: 140px;">√öltima Conexi√≥n</th>
                            </tr>
                        </thead>
                        <tbody id="availableDevicesList">
                            <!-- Loading inicial -->
                            <tr>
                                <td colspan="6" class="text-center py-4">
                                    <div class="spinner-border spinner-border-sm text-primary" role="status">
                                        <span class="visually-hidden">Cargando...</span>
                                    </div>
                                    <p class="mt-2 text-muted small mb-0">Cargando dispositivos disponibles...</p>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>

                <!-- Informaci√≥n de paginaci√≥n -->
                <div class="d-flex justify-content-between align-items-center mt-3">
                    <small class="text-muted" id="devicesPaginationInfo">
                        Mostrando 0 dispositivos
                    </small>
                    <button class="btn btn-sm btn-outline-secondary" id="clearDeviceFilters">
                        <i class="fas fa-eraser me-1"></i>Limpiar Filtros
                    </button>
                </div>
            </div>
            <div class="modal-footer">
                <div class="d-flex justify-content-between align-items-center w-100">
                    <div>
                        <small class="text-muted" id="changesInfo">
                            No hay cambios pendientes
                        </small>
                    </div>
                    <div class="btn-group">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                            <i class="fas fa-times me-1"></i>Cancelar
                        </button>
                        <button type="button" class="btn btn-primary" id="saveDeviceAssignments" disabled>
                            <i class="fas fa-save me-1"></i>Guardar Cambios
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- MODAL PARA VISTA PREVIA DE VIDEO -->
<div class="modal fade" id="videoPreviewModal" tabindex="-1" aria-labelledby="videoPreviewModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="videoPreviewModalLabel">Vista Previa del Video</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Cerrar"></button>
            </div>
            <div class="modal-body">
                <div class="text-center">
                    <video id="previewVideo" class="w-100" controls style="max-height: 400px;">
                        Tu navegador no soporta el elemento de video.
                    </video>
                </div>
                <div class="mt-3">
                    <h6 id="previewVideoTitle"></h6>
                    <p id="previewVideoDescription" class="text-muted"></p>
                </div>
            </div>
        </div>
    </div>
</div>

{% endblock %}

{% block extra_scripts %}
<!-- Scripts principales en orden correcto -->
<script src="/static/js/api-config.js"></script>
<script>
/**
 * CONFIGURACI√ìN Y FUNCIONES BASE PARA PLAYLIST DETAIL
 * Este script se ejecuta antes que los dem√°s para configurar el entorno
 */

// ==========================================
// CONFIGURACI√ìN DE API SEGURA
// ==========================================

// Verificar y configurar API_CONFIG si no existe
if (typeof window.API_CONFIG === 'undefined') {
    console.log('üîß Configurando API_CONFIG...');
    
    const protocol = window.location.protocol;
    const host = window.location.host;
    const apiUrl = `${protocol}//${host}/api`;
    
    window.API_CONFIG = {
        BASE_URL: apiUrl,
        VIDEOS: { 
            LIST: `${apiUrl}/videos` 
        },
        PLAYLISTS: {
            LIST: `${apiUrl}/playlists`,
            GET_BY_ID: (id) => `${apiUrl}/playlists/${id}`,
            UPDATE: (id) => `${apiUrl}/playlists/${id}`,
            ADD_VIDEO: (playlistId, videoId) => `${apiUrl}/playlists/${playlistId}/videos/${videoId}`,
            REMOVE_VIDEO: (playlistId, videoId) => `${apiUrl}/playlists/${playlistId}/videos/${videoId}`,
            UPDATE_ORDER: (id) => `${apiUrl}/playlists/${id}/video-order`
        },
        DEVICES: {
            LIST: `${apiUrl}/devices`,
            PLAYLIST_DEVICES: (playlistId) => `${apiUrl}/device-playlists/playlist/${playlistId}/devices`,
            ASSIGN: `${apiUrl}/device-playlists`,
            UNASSIGN: (deviceId, playlistId) => `${apiUrl}/device-playlists/${deviceId}/${playlistId}`
        }
    };
}

// ==========================================
// FUNCI√ìN getPlaylistId ROBUSTA
// ==========================================

function getPlaylistId() {
    console.log('üîç [getPlaylistId] Obteniendo ID de playlist...');
    
    try {
        // M√©todo 1: URL params (m√°s confiable)
        const urlParams = new URLSearchParams(window.location.search);
        const idFromUrl = urlParams.get('id');
        
        if (idFromUrl) {
            const parsedId = parseInt(idFromUrl);
            if (!isNaN(parsedId) && parsedId > 0) {
                console.log(`‚úÖ [getPlaylistId] ID de URL: ${parsedId}`);
                return parsedId;
            }
        }
        
        // M√©todo 2: Path URL
        const pathMatch = window.location.pathname.match(/\/playlists?\/(\d+)/);
        if (pathMatch && pathMatch[1]) {
            const parsedId = parseInt(pathMatch[1]);
            if (!isNaN(parsedId) && parsedId > 0) {
                console.log(`‚úÖ [getPlaylistId] ID del path: ${parsedId}`);
                return parsedId;
            }
        }
        
        // M√©todo 3: Elemento hidden
        const idElement = document.getElementById('playlist-id');
        if (idElement && idElement.value) {
            const parsedId = parseInt(idElement.value);
            if (!isNaN(parsedId) && parsedId > 0) {
                console.log(`‚úÖ [getPlaylistId] ID de elemento hidden: ${parsedId}`);
                return parsedId;
            }
        }
        
        // M√©todo 4: Variables globales
        if (window.currentPlaylistId) {
            const parsedId = parseInt(window.currentPlaylistId);
            if (!isNaN(parsedId) && parsedId > 0) {
                console.log(`‚úÖ [getPlaylistId] ID de variable global: ${parsedId}`);
                return parsedId;
            }
        }
        
        if (window.currentPlaylistData && window.currentPlaylistData.id) {
            const parsedId = parseInt(window.currentPlaylistData.id);
            if (!isNaN(parsedId) && parsedId > 0) {
                console.log(`‚úÖ [getPlaylistId] ID de datos globales: ${parsedId}`);
                return parsedId;
            }
        }
        
        // M√©todo 5: JSON con correcci√≥n
        const playlistElement = document.getElementById('playlist-data');
        if (playlistElement && playlistElement.textContent) {
            try {
                let jsonText = playlistElement.textContent.trim();
                
                // Corregir JSON malformado
                jsonText = jsonText
                    .replace(/"([^"]+)":\s*,/g, '"$1": null,')
                    .replace(/,\s*}/g, '}')
                    .replace(/,\s*]/g, ']')
                    .replace(/:\s*undefined/g, ': null');
                
                const templateData = JSON.parse(jsonText);
                
                if (templateData && templateData.id) {
                    const parsedId = parseInt(templateData.id);
                    if (!isNaN(parsedId) && parsedId > 0) {
                        console.log(`‚úÖ [getPlaylistId] ID de JSON corregido: ${parsedId}`);
                        
                        // Actualizar datos globales
                        window.currentPlaylistData = templateData;
                        window.currentPlaylistId = parsedId;
                        if (templateData.videos) {
                            window.playlistVideos = templateData.videos;
                        }
                        
                        return parsedId;
                    }
                }
                
            } catch (jsonError) {
                console.warn('‚ö†Ô∏è [getPlaylistId] Error parseando JSON:', jsonError.message);
                
                // √öltimo recurso: regex
                try {
                    const idMatch = playlistElement.textContent.match(/"id":\s*(\d+)/);
                    if (idMatch && idMatch[1]) {
                        const parsedId = parseInt(idMatch[1]);
                        if (!isNaN(parsedId) && parsedId > 0) {
                            console.log(`‚úÖ [getPlaylistId] ID con regex: ${parsedId}`);
                            return parsedId;
                        }
                    }
                } catch (regexError) {
                    console.warn('‚ö†Ô∏è [getPlaylistId] Error con regex:', regexError.message);
                }
            }
        }
        
        console.error('‚ùå [getPlaylistId] No se pudo obtener ID de playlist');
        return null;
        
    } catch (error) {
        console.error('‚ùå [getPlaylistId] Error general:', error);
        return null;
    }
}

// ==========================================
// VARIABLES GLOBALES
// ==========================================

// Estado de la aplicaci√≥n
let currentPlaylistData = null;
let playlistVideos = [];
let availableVideos = [];
let assignedDevices = [];

// Estado de paginaci√≥n
let currentPage = 1;
let pageSize = 25;
let totalPages = 1;
let searchTerm = '';

// Estado de cambios
let hasUnsavedChanges = false;
let isLoading = false;

// Cargar datos iniciales si est√°n disponibles
const playlistElement = document.getElementById('playlist-data');
if (playlistElement && playlistElement.textContent) {
    try {
        let jsonText = playlistElement.textContent.trim();
        
        // Corregir JSON malformado
        jsonText = jsonText
            .replace(/"([^"]+)":\s*,/g, '"$1": null,')
            .replace(/,\s*}/g, '}')
            .replace(/,\s*]/g, ']');
        
        const templateData = JSON.parse(jsonText);
        if (templateData && templateData.id) {
            currentPlaylistData = templateData;
            playlistVideos = templateData.videos || [];
            window.currentPlaylistData = templateData;
            window.playlistVideos = playlistVideos;
            
            console.log('üìã Datos de playlist cargados desde template:', templateData.title);
        }
    } catch (error) {
        console.warn('‚ö†Ô∏è Error cargando datos desde template:', error);
    }
}

// Hacer funciones disponibles globalmente
window.getPlaylistId = getPlaylistId;
window.currentPlaylistData = currentPlaylistData;
window.playlistVideos = playlistVideos;

console.log('‚úÖ Configuraci√≥n base de playlist_detail cargada');
</script>

<!-- Script principal de funcionalidad -->
<script src="/static/js/playlist_detail.js"></script>

<!-- Script de gesti√≥n de dispositivos asignados -->
<script src="/static/js/assigned-devices-manager.js"></script>

<!-- Script del modal de asignaci√≥n de dispositivos -->
<script src="/static/js/device-assignment-modal.js"></script>

<!-- Script espec√≠fico del template -->
<script>
/**
 * FUNCIONALIDAD ESPEC√çFICA DEL TEMPLATE PLAYLIST_DETAIL
 */

// ==========================================
// FUNCIONES DE INTERFAZ DE USUARIO
// ==========================================

/**
 * Actualizar estad√≠sticas de la playlist
 */
function updatePlaylistStats() {
    console.log('üìä Actualizando estad√≠sticas...');
    
    const totalVideosEl = document.getElementById('totalVideos');
    const totalDurationEl = document.getElementById('totalDuration');
    const activeVideosEl = document.getElementById('activeVideos');
    const assignedDevicesEl = document.getElementById('assignedDevices');
    const playlistVideoCountEl = document.getElementById('playlistVideoCount');
    const availableVideoCountEl = document.getElementById('availableVideoCount');
    const deviceCountEl = document.getElementById('deviceCount');
    
    // Videos de la playlist
    const videoCount = playlistVideos ? playlistVideos.length : 0;
    const totalDuration = playlistVideos ? 
        playlistVideos.reduce((sum, video) => sum + (video.duration || 0), 0) : 0;
    
    // Disponibles
    const availableCount = availableVideos ? availableVideos.length : 0;
    
    // Dispositivos
    const deviceCount = assignedDevices ? assignedDevices.length : 0;
    
    // Actualizar elementos
    if (totalVideosEl) totalVideosEl.textContent = videoCount;
    if (totalDurationEl) totalDurationEl.textContent = formatDuration(totalDuration);
    if (activeVideosEl) activeVideosEl.textContent = videoCount;
    if (assignedDevicesEl) assignedDevicesEl.textContent = deviceCount;
    if (playlistVideoCountEl) playlistVideoCountEl.textContent = videoCount;
    if (availableVideoCountEl) availableVideoCountEl.textContent = availableCount;
    if (deviceCountEl) deviceCountEl.textContent = deviceCount;
    
    console.log(`üìä Estad√≠sticas actualizadas: ${videoCount} videos, ${deviceCount} dispositivos`);
}

/**
 * Formatear duraci√≥n en minutos y segundos
 */
function formatDuration(seconds) {
    if (!seconds || seconds <= 0) return '0m';
    
    const minutes = Math.floor(seconds / 60);
    const remainingSeconds = seconds % 60;
    
    if (minutes >= 60) {
        const hours = Math.floor(minutes / 60);
        const remainingMinutes = minutes % 60;
        return `${hours}h ${remainingMinutes}m`;
    }
    
    return remainingSeconds > 0 ? `${minutes}m ${remainingSeconds}s` : `${minutes}m`;
}

/**
 * Mostrar estado de carga
 */
function showLoadingState(elementId, show = true) {
    const element = document.getElementById(elementId);
    if (element) {
        if (show) {
            element.classList.remove('d-none');
        } else {
            element.classList.add('d-none');
        }
    }
}

/**
 * Mostrar toast notification
 */
function showToast(message, type = 'info') {
    console.log(`üì¢ Toast ${type}: ${message}`);
    
    // Si existe funci√≥n global, usarla
    if (typeof window.showToast === 'function' && window.showToast !== showToast) {
        window.showToast(message, type);
        return;
    }
    
    // Toast simple
    const alertClass = type === 'error' ? 'danger' : type;
    const toast = document.createElement('div');
    toast.className = `alert alert-${alertClass} position-fixed fade-in`;
    toast.style.cssText = 'top: 20px; right: 20px; z-index: 9999; min-width: 300px;';
    toast.innerHTML = `
        ${message}
        <button type="button" class="btn-close float-end" onclick="this.parentElement.remove()"></button>
    `;
    
    document.body.appendChild(toast);
    setTimeout(() => toast.remove(), 5000);
}

/**
 * Marcar como cambios sin guardar
 */
function markAsUnsaved() {
    hasUnsavedChanges = true;
    
    // Actualizar bot√≥n de guardar
    const saveBtn = document.querySelector('[onclick="savePlaylistChanges()"]');
    if (saveBtn) {
        saveBtn.classList.remove('btn-warning');
        saveBtn.classList.add('btn-success');
        saveBtn.innerHTML = '<i class="fas fa-save"></i> Guardar *';
    }
}

/**
 * Confirmar eliminaci√≥n de playlist
 */
function confirmDeletePlaylist() {
    if (!currentPlaylistData) return;
    
    const confirmed = confirm(
        `¬øEst√°s seguro de que deseas eliminar la lista "${currentPlaylistData.title}"?\n\n` +
        'Esta acci√≥n no se puede deshacer.'
    );
    
    if (confirmed) {
        deletePlaylist();
    }
}

/**
 * Eliminar playlist
 */
async function deletePlaylist() {
    const playlistId = getPlaylistId();
    if (!playlistId) return;
    
    try {
        const response = await fetch(window.API_CONFIG.PLAYLISTS.GET_BY_ID(playlistId), {
            method: 'DELETE'
        });
        
        if (response.ok) {
            showToast('Lista eliminada correctamente', 'success');
            setTimeout(() => {
                window.location.href = '/ui/playlists';
            }, 1500);
        } else {
            throw new Error('Error al eliminar la lista');
        }
    } catch (error) {
        console.error('Error:', error);
        showToast('Error al eliminar la lista', 'error');
    }
}

/**
 * Alternar modo de edici√≥n
 */
function toggleEditMode() {
    showToast('Funcionalidad de edici√≥n en desarrollo', 'info');
}

/**
 * Exportar playlist
 */
function exportPlaylist() {
    if (!currentPlaylistData) {
        showToast('No hay datos de playlist para exportar', 'warning');
        return;
    }
    
    const exportData = {
        playlist: currentPlaylistData,
        videos: playlistVideos,
        exported_at: new Date().toISOString()
    };
    
    const dataStr = JSON.stringify(exportData, null, 2);
    const dataBlob = new Blob([dataStr], { type: 'application/json' });
    
    const link = document.createElement('a');
    link.href = URL.createObjectURL(dataBlob);
    link.download = `playlist_${currentPlaylistData.title.replace(/[^a-z0-9]/gi, '_')}.json`;
    link.click();
    
    showToast('Playlist exportada correctamente', 'success');
}

/**
 * Mezclar orden de playlist
 */
function shufflePlaylist() {
    if (!playlistVideos || playlistVideos.length < 2) {
        showToast('Necesitas al menos 2 videos para mezclar', 'warning');
        return;
    }
    
    // Crear copia y mezclar
    const shuffled = [...playlistVideos];
    for (let i = shuffled.length - 1; i > 0; i--) {
        const j = Math.floor(Math.random() * (i + 1));
        [shuffled[i], shuffled[j]] = [shuffled[j], shuffled[i]];
    }
    
    playlistVideos = shuffled;
    
    // Actualizar orden
    playlistVideos.forEach((video, index) => {
        video.order = index + 1;
        video.position = index + 1;
    });
    
    // Re-renderizar
    if (typeof updatePlaylistVideosTable === 'function') {
        updatePlaylistVideosTable();
    }
    
    markAsUnsaved();
    showToast('Orden de videos mezclado', 'success');
}

// ==========================================
// INICIALIZACI√ìN
// ==========================================

/**
 * Inicializar cuando el DOM est√© listo
 */
document.addEventListener('DOMContentLoaded', function() {
    console.log('üé¨ Inicializando template playlist_detail...');
    
    // Actualizar estad√≠sticas iniciales
    updatePlaylistStats();
    
    // Configurar advertencia de salida
    window.addEventListener('beforeunload', function(e) {
        if (hasUnsavedChanges) {
            e.preventDefault();
            e.returnValue = 'Tienes cambios sin guardar. ¬øEst√°s seguro de que quieres salir?';
        }
    });
    
    console.log('‚úÖ Template playlist_detail inicializado');
});

// Hacer funciones disponibles globalmente
window.updatePlaylistStats = updatePlaylistStats;
window.formatDuration = formatDuration;
window.showToast = showToast;
window.markAsUnsaved = markAsUnsaved;
window.confirmDeletePlaylist = confirmDeletePlaylist;
window.deletePlaylist = deletePlaylist;
window.toggleEditMode = toggleEditMode;
window.exportPlaylist = exportPlaylist;
window.shufflePlaylist = shufflePlaylist;

console.log('‚úÖ Script espec√≠fico del template cargado');
</script>
{% endblock %}