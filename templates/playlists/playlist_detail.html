{% extends "base.html" %}

{% block title %}
    {% if playlist %}
        Editar Lista: {{ playlist.title }}
    {% else %}
        Gesti√≥n de Videos y Listas
    {% endif %}
{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="/static/css/playlist_detail.css">
<style>
/* ==========================================
   ESTILOS ESPEC√çFICOS PARA PLAYLIST DETAIL
   ========================================== */

:root {
    --primary-color: #0d6efd;
    --success-color: #198754;
    --warning-color: #ffc107;
    --danger-color: #dc3545;
    --info-color: #0dcaf0;
    --secondary-color: #6c757d;
    --light-color: #f8f9fa;
    --dark-color: #212529;
    --border-radius: 0.5rem;
    --box-shadow: 0 0.125rem 0.25rem rgba(0, 0, 0, 0.075);
    --box-shadow-lg: 0 0.5rem 1rem rgba(0, 0, 0, 0.15);
    --transition: all 0.15s ease-in-out;
}

/* Header y t√≠tulo */
.page-header {
    background: linear-gradient(135deg, var(--primary-color), var(--info-color));
    color: white;
    padding: 2rem 0;
    margin-bottom: 2rem;
    border-radius: var(--border-radius);
}

.page-title {
    font-size: 2.5rem;
    font-weight: 700;
    margin-bottom: 0.5rem;
}

.page-subtitle {
    opacity: 0.9;
    font-size: 1.1rem;
}

/* Tarjetas de estad√≠sticas */
.stat-card {
    background: white;
    padding: 1.5rem;
    border-radius: var(--border-radius);
    text-align: center;
    box-shadow: var(--box-shadow);
    transition: var(--transition);
    border: 1px solid rgba(0, 0, 0, 0.1);
}

.stat-card:hover {
    transform: translateY(-2px);
    box-shadow: var(--box-shadow-lg);
}

.stat-value {
    font-size: 2.5rem;
    font-weight: 700;
    color: var(--primary-color);
    margin-bottom: 0.5rem;
}

.stat-label {
    color: var(--secondary-color);
    font-size: 0.9rem;
    font-weight: 500;
    text-transform: uppercase;
    letter-spacing: 0.5px;
}

/* Botones de acci√≥n */
.action-buttons {
    background: white;
    padding: 1rem;
    border-radius: var(--border-radius);
    box-shadow: var(--box-shadow);
    margin-bottom: 2rem;
}

.btn-action {
    padding: 0.75rem 1.5rem;
    font-weight: 500;
    border-radius: 0.375rem;
    transition: var(--transition);
    text-decoration: none;
    display: inline-flex;
    align-items: center;
    gap: 0.5rem;
}

.btn-action:hover {
    transform: translateY(-1px);
    box-shadow: 0 0.25rem 0.5rem rgba(0, 0, 0, 0.1);
}

/* Paneles principales */
.main-panel {
    background: white;
    border-radius: var(--border-radius);
    box-shadow: var(--box-shadow);
    overflow: hidden;
}

.panel-header {
    background: var(--light-color);
    padding: 1rem 1.5rem;
    border-bottom: 1px solid rgba(0, 0, 0, 0.1);
    font-weight: 600;
}

.panel-body {
    padding: 1.5rem;
}

/* Videos de la playlist */
.playlist-videos-container {
    min-height: 400px;
    max-height: 600px;
    overflow-y: auto;
}

.video-item {
    display: flex;
    align-items: center;
    padding: 1rem;
    border: 1px solid #e9ecef;
    border-radius: 0.375rem;
    margin-bottom: 0.75rem;
    background: white;
    transition: var(--transition);
    cursor: grab;
}

.video-item:hover {
    border-color: var(--primary-color);
    box-shadow: 0 0.125rem 0.25rem rgba(13, 110, 253, 0.15);
}

.video-item.dragging {
    opacity: 0.5;
    transform: rotate(5deg);
}

.video-thumbnail {
    width: 80px;
    height: 60px;
    border-radius: 0.375rem;
    object-fit: cover;
    margin-right: 1rem;
    background: var(--light-color);
}

.video-info {
    flex: 1;
}

.video-title {
    font-weight: 600;
    margin-bottom: 0.25rem;
    color: var(--dark-color);
}

.video-description {
    color: var(--secondary-color);
    font-size: 0.875rem;
    margin-bottom: 0.25rem;
}

.video-meta {
    display: flex;
    gap: 1rem;
    font-size: 0.75rem;
    color: var(--secondary-color);
}

.video-actions {
    display: flex;
    gap: 0.5rem;
}

.drag-handle {
    cursor: grab;
    color: var(--secondary-color);
    padding: 0.5rem;
}

.drag-handle:hover {
    color: var(--primary-color);
}

/* Biblioteca de videos */
.video-library {
    max-height: 600px;
    overflow-y: auto;
}

.available-video {
    display: flex;
    align-items: center;
    padding: 0.75rem;
    border: 1px solid #e9ecef;
    border-radius: 0.375rem;
    margin-bottom: 0.5rem;
    background: white;
    transition: var(--transition);
}

.available-video:hover {
    border-color: var(--success-color);
    background: rgba(25, 135, 84, 0.05);
}

.available-video .video-thumbnail {
    width: 60px;
    height: 45px;
    margin-right: 0.75rem;
}

/* Dispositivos asignados */
.devices-section {
    margin-top: 2rem;
}

.device-item {
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 1rem;
    border: 1px solid #e9ecef;
    border-radius: 0.375rem;
    margin-bottom: 0.5rem;
    background: white;
    transition: var(--transition);
}

.device-item:hover {
    border-color: var(--info-color);
    background: rgba(13, 202, 240, 0.05);
}

.device-info {
    flex: 1;
}

.device-name {
    font-weight: 600;
    margin-bottom: 0.25rem;
}

.device-meta {
    color: var(--secondary-color);
    font-size: 0.875rem;
}

.device-status {
    margin-right: 1rem;
}

.status-online {
    color: var(--success-color);
}

.status-offline {
    color: var(--secondary-color);
}

/* Modal customizations */
.modal-xl {
    max-width: 90%;
}

#assignDeviceModal .table-responsive {
    max-height: 400px;
    border: 1px solid #dee2e6;
    border-radius: 0.375rem;
}

#assignDeviceModal .pending-change {
    background-color: #fff3cd !important;
    border-left: 4px solid var(--warning-color);
}

/* Controles y filtros */
.search-controls {
    background: var(--light-color);
    padding: 1rem;
    border-radius: 0.375rem;
    margin-bottom: 1rem;
}

.form-control:focus,
.form-select:focus {
    border-color: var(--primary-color);
    box-shadow: 0 0 0 0.2rem rgba(13, 110, 253, 0.25);
}

/* Badges y labels */
.badge-custom {
    padding: 0.5rem 0.75rem;
    font-size: 0.75rem;
    font-weight: 500;
    border-radius: 0.375rem;
}

.duration-badge {
    background: var(--info-color);
    color: white;
}

.video-count-badge {
    background: linear-gradient(45deg, var(--primary-color), var(--info-color));
    color: white;
}

/* Estados de carga */
.loading-spinner {
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    padding: 3rem;
    color: var(--secondary-color);
}

.empty-state {
    text-align: center;
    padding: 3rem;
    color: var(--secondary-color);
}

.empty-state i {
    font-size: 3rem;
    margin-bottom: 1rem;
    opacity: 0.5;
}

/* Responsive */
@media (max-width: 768px) {
    .page-title {
        font-size: 2rem;
    }
    
    .video-item {
        flex-direction: column;
        align-items: flex-start;
        gap: 0.75rem;
    }
    
    .video-thumbnail {
        width: 100%;
        height: 120px;
        margin-right: 0;
    }
    
    .video-actions {
        width: 100%;
        justify-content: center;
    }
    
    .action-buttons {
        text-align: center;
    }
    
    .action-buttons .btn {
        margin-bottom: 0.5rem;
        width: 100%;
    }
}

@media (max-width: 576px) {
    .stat-card {
        margin-bottom: 1rem;
    }
    
    .stat-value {
        font-size: 2rem;
    }
}

/* Animaciones */
@keyframes slideIn {
    from {
        opacity: 0;
        transform: translateY(20px);
    }
    to {
        opacity: 1;
        transform: translateY(0);
    }
}

.fade-in {
    animation: slideIn 0.3s ease-out;
}

/* Utilidades */
.text-truncate-2 {
    overflow: hidden;
    display: -webkit-box;
    -webkit-line-clamp: 2;
    -webkit-box-orient: vertical;
}

.cursor-pointer {
    cursor: pointer;
}

.user-select-none {
    user-select: none;
}
</style>
{% endblock %}

{% block content %}
<!-- Datos de playlist para JavaScript -->
{% if playlist %}
<script type="application/json" id="playlist-data">
{
    "id": {{ playlist.id }},
    "title": "{{ playlist.title | safe }}",
    "description": "{{ playlist.description | safe if playlist.description else '' }}",
    "creation_date": "{{ playlist.creation_date.isoformat() if playlist.creation_date else '' }}",
    "updated_at": "{{ playlist.updated_at.isoformat() if playlist.updated_at else '' }}",
    "start_date": "{{ playlist.start_date.isoformat() if playlist.start_date else '' }}",
    "expiration_date": "{{ playlist.expiration_date.isoformat() if playlist.expiration_date else '' }}",
    "is_active": {{ playlist.is_active | lower }},
    "videos": [
        {% for pv in playlist.playlist_videos %}
        {
            "id": {{ pv.video.id }},
            "title": "{{ pv.video.title | safe }}",
            "description": "{{ pv.video.description | safe if pv.video.description else '' }}",
            "file_path": "{{ pv.video.file_path | safe }}",
            "duration": {{ pv.video.duration or 0 }},
            "position": {{ pv.position or 0 }},
            "order": {{ pv.position or 0 }}
        }{% if not loop.last %},{% endif %}
        {% endfor %}
    ]
}
</script>
<input type="hidden" id="playlist-id" value="{{ playlist.id }}">
{% endif %}

<!-- HEADER DE LA P√ÅGINA -->
<div class="page-header">
    <div class="container-fluid">
        <div class="row align-items-center">
            <div class="col-lg-8">
                <h1 class="page-title">
                    <i class="fas fa-list-alt me-3"></i>
                    {% if playlists %}
                        {{ playlist.title }}
                    {% else %}
                        Gesti√≥n de Videos y Listas
                    {% endif %}
                </h1>
                <p class="page-subtitle mb-0">
                    {% if playlist %}
                        Edita y gestiona tu lista de reproducci√≥n
                    {% else %}
                        Crea y organiza tus listas de reproducci√≥n
                    {% endif %}
                </p>
            </div>
            <div class="col-lg-4 text-lg-end">
                <div class="d-flex gap-2 justify-content-lg-end justify-content-center">
                    <button type="button" class="btn btn-light" onclick="window.history.back()">
                        <i class="fas fa-arrow-left me-2"></i>Volver
                    </button>
                    {% if playlist %}
                    <button type="button" class="btn btn-warning" onclick="toggleEditMode()">
                        <i class="fas fa-edit me-2"></i>Editar Info
                    </button>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
</div>

<!-- SECCI√ìN DE ESTAD√çSTICAS -->
<div class="container-fluid">
    <div class="row mb-4">
        <div class="col-12">
            <div class="row g-3">
                <div class="col-md-3 col-6">
                    <div class="stat-card">
                        <div class="stat-value" id="totalVideos">0</div>
                        <div class="stat-label">Videos Total</div>
                    </div>
                </div>
                <div class="col-md-3 col-6">
                    <div class="stat-card">
                        <div class="stat-value" id="totalDuration">0m</div>
                        <div class="stat-label">Duraci√≥n Total</div>
                    </div>
                </div>
                <div class="col-md-3 col-6">
                    <div class="stat-card">
                        <div class="stat-value" id="activeVideos">0</div>
                        <div class="stat-label">Videos Activos</div>
                    </div>
                </div>
                <div class="col-md-3 col-6">
                    <div class="stat-card">
                        <div class="stat-value" id="assignedDevices">0</div>
                        <div class="stat-label">Dispositivos</div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- BOTONES DE ACCI√ìN PRINCIPALES -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="action-buttons">
                <div class="d-flex flex-wrap gap-2 justify-content-center">
                    <button type="button" class="btn btn-primary btn-action" onclick="previewPlaylist()" title="Ver lista completa">
                        <i class="fas fa-play"></i> Vista Previa
                    </button>
                    <button type="button" class="btn btn-success btn-action" data-bs-toggle="modal" data-bs-target="#assignDeviceModal" title="Asignar dispositivos">
                        <i class="fas fa-tv"></i> Asignar Dispositivos
                    </button>
                    <button type="button" class="btn btn-info btn-action" onclick="exportPlaylist()" title="Exportar playlist">
                        <i class="fas fa-download"></i> Exportar
                    </button>
                    <button type="button" class="btn btn-warning btn-action" onclick="savePlaylistChanges()" title="Guardar cambios">
                        <i class="fas fa-save"></i> Guardar
                    </button>
                    {% if playlist %}
                    <button type="button" class="btn btn-outline-danger btn-action" onclick="confirmDeletePlaylist()" title="Eliminar playlist">
                        <i class="fas fa-trash"></i> Eliminar
                    </button>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>

    <!-- CONTENEDOR PRINCIPAL: VIDEOS Y BIBLIOTECA -->
    <div class="row g-4">
        <!-- PANEL IZQUIERDO: VIDEOS DE LA PLAYLIST -->
        <div class="col-lg-7">
            <div class="main-panel">
                <div class="panel-header d-flex justify-content-between align-items-center">
                    <h5 class="mb-0">
                        <i class="fas fa-film me-2 text-primary"></i>
                        Videos de la Lista
                        <span class="badge bg-primary ms-2" id="playlistVideoCount">0</span>
                    </h5>
                    <div class="d-flex gap-2">
                        <button type="button" class="btn btn-sm btn-outline-secondary" onclick="clearPlaylist()" title="Limpiar lista">
                            <i class="fas fa-trash"></i>
                        </button>
                        <button type="button" class="btn btn-sm btn-outline-primary" onclick="shufflePlaylist()" title="Mezclar orden">
                            <i class="fas fa-random"></i>
                        </button>
                    </div>
                </div>
                <div class="panel-body">
                    <!-- Loading de videos de playlist -->
                    <div id="loadingPlaylistVideos" class="loading-spinner d-none">
                        <div class="spinner-border text-primary" role="status">
                            <span class="visually-hidden">Cargando...</span>
                        </div>
                        <p class="mt-2">Cargando videos de la lista...</p>
                    </div>
                    
                    <!-- Estado vac√≠o -->
                    <div id="playlistVideosEmpty" class="empty-state">
                        <i class="fas fa-film"></i>
                        <h5>No hay videos en esta lista</h5>
                        <p class="text-muted mb-3">Arrastra videos desde la biblioteca o usa el bot√≥n <i class="fas fa-plus"></i></p>
                        <small class="text-muted">
                            <i class="fas fa-hand-point-right me-1"></i>
                            Tip: Arrastra videos hacia la lista o usa <i class="fas fa-plus"></i>
                        </small>
                    </div>
                    
                    <!-- Contenedor de videos de la playlist -->
                    <div id="playlistVideosContainer" class="playlist-videos-container">
                        <div id="playlistVideosList">
                            <!-- Los videos se cargar√°n din√°micamente aqu√≠ -->
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- PANEL DERECHO: BIBLIOTECA DE VIDEOS -->
        <div class="col-lg-5">
            <div class="main-panel">
                <div class="panel-header">
                    <h5 class="mb-0">
                        <i class="fas fa-video me-2 text-success"></i>
                        Biblioteca de Videos
                        <span class="badge bg-success ms-2" id="availableVideoCount">0</span>
                    </h5>
                </div>
                <div class="panel-body">
                    <!-- Controles de b√∫squeda -->
                    <div class="search-controls">
                        <div class="row g-2">
                            <div class="col-md-8">
                                <div class="input-group input-group-sm">
                                    <span class="input-group-text">
                                        <i class="fas fa-search"></i>
                                    </span>
                                    <input type="text" id="videoSearchInput" class="form-control" 
                                           placeholder="Buscar videos...">
                                    <button class="btn btn-outline-secondary" type="button" id="clearVideoSearch">
                                        <i class="fas fa-times"></i>
                                    </button>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <select class="form-select form-select-sm" id="videoPageSize">
                                    <option value="10">10 por p√°gina</option>
                                    <option value="25" selected>25 por p√°gina</option>
                                    <option value="50">50 por p√°gina</option>
                                    <option value="all">Todos</option>
                                </select>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Loading de videos disponibles -->
                    <div id="loadingAvailableVideos" class="loading-spinner">
                        <div class="spinner-border text-success" role="status">
                            <span class="visually-hidden">Cargando...</span>
                        </div>
                        <p class="mt-2">Cargando biblioteca de videos...</p>
                    </div>
                    
                    <!-- Lista de videos disponibles -->
                    <div id="availableVideosContainer" class="video-library d-none">
                        <div id="availableVideosList">
                            <!-- Los videos disponibles se cargar√°n din√°micamente aqu√≠ -->
                        </div>
                        
                        <!-- Paginaci√≥n -->
                        <div class="d-flex justify-content-between align-items-center mt-3">
                            <div class="btn-group btn-group-sm">
                                <button class="btn btn-outline-secondary" id="prevPageBtn" onclick="goToPrevPage()" disabled>
                                    <i class="fas fa-chevron-left"></i>
                                </button>
                                <button class="btn btn-outline-secondary" id="nextPageBtn" onclick="goToNextPage()">
                                    <i class="fas fa-chevron-right"></i>
                                </button>
                            </div>
                            <small class="text-muted" id="paginationInfo">
                                P√°gina 1 de 1
                            </small>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- SECCI√ìN DE DISPOSITIVOS ASIGNADOS -->
    <div class="row mt-4">
        <div class="col-12">
            <div class="main-panel devices-section">
                <div class="panel-header d-flex justify-content-between align-items-center">
                    <h5 class="mb-0">
                        <i class="fas fa-tv me-2 text-info"></i>Dispositivos Asignados
                        <span class="badge bg-info ms-2" id="deviceCount">0</span>
                    </h5>
                    <button class="btn btn-outline-info btn-sm" data-bs-toggle="modal" data-bs-target="#assignDeviceModal">
                        <i class="fas fa-plus-circle me-1"></i> Asignar Dispositivo
                    </button>
                </div>
                <div class="panel-body">
                    <!-- Loading de dispositivos asignados -->
                    <div id="loadingAssignedDevices" class="loading-spinner d-none">
                        <div class="spinner-border text-info" role="status">
                            <span class="visually-hidden">Cargando...</span>
                        </div>
                        <p class="mt-2">Cargando dispositivos asignados...</p>
                    </div>
                    
                    <!-- Estado vac√≠o de dispositivos -->
                    <div id="assignedDevicesEmpty" class="empty-state">
                        <i class="fas fa-tv"></i>
                        <h5>No hay dispositivos asignados</h5>
                        <p class="text-muted mb-3">Asigna dispositivos para que puedan reproducir esta lista</p>
                        <button class="btn btn-outline-info" data-bs-toggle="modal" data-bs-target="#assignDeviceModal">
                            <i class="fas fa-plus-circle me-1"></i> Asignar Dispositivo
                        </button>
                    </div>
                    
                    <!-- Tabla de dispositivos asignados -->
                    <div id="assignedDevicesTable" class="table-responsive d-none">
                        <table class="table table-hover table-striped mb-0">
                            <thead class="table-light">
                                <tr>
                                    <th>Dispositivo</th>
                                    <th>Ubicaci√≥n</th>
                                    <th>Estado</th>
                                    <th>√öltima Conexi√≥n</th>
                                    <th class="text-end">Acciones</th>
                                </tr>
                            </thead>
                            <tbody id="assignedDevicesList">
                                <!-- Los dispositivos asignados se cargar√°n din√°micamente -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- MODAL PARA ASIGNAR DISPOSITIVOS -->
<div class="modal fade" id="assignDeviceModal" tabindex="-1" aria-labelledby="assignDeviceModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header bg-primary text-white">
                <h5 class="modal-title" id="assignDeviceModalLabel">
                    <i class="fas fa-tv me-2"></i>Asignar Dispositivos a la Lista
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Cerrar"></button>
            </div>
            <div class="modal-body">
                <!-- Controles de b√∫squeda y filtros -->
                <div class="row mb-3">
                    <div class="col-md-8">
                        <div class="input-group">
                            <span class="input-group-text">
                                <i class="fas fa-search"></i>
                            </span>
                            <input type="text" id="deviceSearchInput" class="form-control" 
                                   placeholder="Buscar dispositivos por nombre, ubicaci√≥n o MAC...">
                            <button class="btn btn-outline-secondary" type="button" id="clearDeviceSearch">
                                <i class="fas fa-times"></i> Limpiar
                            </button>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <select class="form-select" id="deviceStatusFilter">
                            <option value="all" selected>Todos los dispositivos</option>
                            <option value="online">Solo en l√≠nea</option>
                            <option value="offline">Solo fuera de l√≠nea</option>
                            <option value="assigned">Ya asignados</option>
                            <option value="unassigned">No asignados</option>
                        </select>
                    </div>
                </div>

                <!-- Informaci√≥n de estado -->
                <div class="row mb-3">
                    <div class="col-12">
                        <div class="alert alert-info d-flex align-items-center" role="alert">
                            <i class="fas fa-info-circle me-2"></i>
                            <div>
                                <strong>Instrucciones:</strong> 
                                Marca o desmarca los dispositivos que deseas asignar o desasignar de esta lista de reproducci√≥n.
                                Los cambios se aplicar√°n al hacer clic en "Guardar Cambios".
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Estad√≠sticas r√°pidas -->
                <div class="row mb-3">
                    <div class="col-12">
                        <div class="d-flex flex-wrap gap-2">
                            <span class="badge bg-primary" id="totalDevicesBadge">
                                <i class="fas fa-tv me-1"></i>0 dispositivos
                            </span>
                            <span class="badge bg-success" id="onlineDevicesBadge">
                                <i class="fas fa-circle me-1"></i>0 en l√≠nea
                            </span>
                            <span class="badge bg-warning" id="assignedDevicesBadge">
                                <i class="fas fa-link me-1"></i>0 asignados
                            </span>
                            <span class="badge bg-info" id="pendingChangesBadge">
                                <i class="fas fa-clock me-1"></i>0 cambios pendientes
                            </span>
                        </div>
                    </div>
                </div>

                <!-- Tabla de dispositivos disponibles -->
                <div class="table-responsive" style="max-height: 400px;">
                    <table class="table table-hover table-sm">
                        <thead class="table-light sticky-top">
                            <tr>
                                <th style="width: 50px;">
                                    <div class="form-check">
                                        <input class="form-check-input" type="checkbox" id="selectAllDevices">
                                        <label class="form-check-label" for="selectAllDevices"></label>
                                    </div>
                                </th>
                                <th>Dispositivo</th>
                                <th style="width: 100px;">Estado</th>
                                <th style="width: 120px;">Asignaci√≥n</th>
                                <th style="width: 150px;">Ubicaci√≥n</th>
                                <th style="width: 140px;">√öltima Conexi√≥n</th>
                            </tr>
                        </thead>
                        <tbody id="availableDevicesList">
                            <!-- Loading inicial -->
                            <tr>
                                <td colspan="6" class="text-center py-4">
                                    <div class="spinner-border spinner-border-sm text-primary" role="status">
                                        <span class="visually-hidden">Cargando...</span>
                                    </div>
                                    <p class="mt-2 text-muted small mb-0">Cargando dispositivos disponibles...</p>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>

                <!-- Informaci√≥n de paginaci√≥n -->
                <div class="d-flex justify-content-between align-items-center mt-3">
                    <small class="text-muted" id="devicesPaginationInfo">
                        Mostrando 0 dispositivos
                    </small>
                    <button class="btn btn-sm btn-outline-secondary" id="clearDeviceFilters">
                        <i class="fas fa-eraser me-1"></i>Limpiar Filtros
                    </button>
                </div>
            </div>
            <div class="modal-footer">
                <div class="d-flex justify-content-between align-items-center w-100">
                    <div>
                        <small class="text-muted" id="changesInfo">
                            No hay cambios pendientes
                        </small>
                    </div>
                    <div class="btn-group">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                            <i class="fas fa-times me-1"></i>Cancelar
                        </button>
                        <button type="button" class="btn btn-primary" id="saveDeviceAssignments" disabled>
                            <i class="fas fa-save me-1"></i>Guardar Cambios
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- MODAL PARA VISTA PREVIA DE VIDEO -->
<div class="modal fade" id="videoPreviewModal" tabindex="-1" aria-labelledby="videoPreviewModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="videoPreviewModalLabel">Vista Previa del Video</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Cerrar"></button>
            </div>
            <div class="modal-body">
                <div class="text-center">
                    <video id="previewVideo" class="w-100" controls style="max-height: 400px;">
                        Tu navegador no soporta el elemento de video.
                    </video>
                </div>
                <div class="mt-3">
                    <h6 id="previewVideoTitle"></h6>
                    <p id="previewVideoDescription" class="text-muted"></p>
                </div>
            </div>
        </div>
    </div>
</div>

{% endblock %}

{% block extra_scripts %}
<!-- Scripts principales en orden correcto -->
<script src="/static/js/api-config.js"></script>
<script>
/**
 * CONFIGURACI√ìN Y FUNCIONES BASE PARA PLAYLIST DETAIL
 * Este script se ejecuta antes que los dem√°s para configurar el entorno
 */

// ==========================================
// CONFIGURACI√ìN DE API SEGURA
// ==========================================

// Verificar y configurar API_CONFIG si no existe
// Verificar y configurar API_CONFIG si no existe
if (typeof window.API_CONFIG === 'undefined') {
    console.log('üîß Configurando API_CONFIG de respaldo...');
    
    // Usar URLs relativas que heredan el protocolo actual
    const apiUrl = '/api';
    
    window.API_CONFIG = {
        BASE_URL: '',
        API_URL: apiUrl,
        VIDEOS: { 
            LIST: `${apiUrl}/videos` 
        },
        PLAYLISTS: {
            LIST: `${apiUrl}/playlists`,
            GET_BY_ID: (id) => `${apiUrl}/playlists/${id}`,
            UPDATE: (id) => `${apiUrl}/playlists/${id}`,
            ADD_VIDEO: (playlistId, videoId) => `${apiUrl}/playlists/${playlistId}/videos/${videoId}`,
            REMOVE_VIDEO: (playlistId, videoId) => `${apiUrl}/playlists/${playlistId}/videos/${videoId}`,
            UPDATE_ORDER: (id) => `${apiUrl}/playlists/${id}/video-order`
        },
        DEVICE_PLAYLISTS: {
            PLAYLIST_DEVICES: (playlistId) => `${apiUrl}/device-playlists/playlist/${playlistId}/devices`,
            ASSIGN: `${apiUrl}/device-playlists`,
            UNASSIGN: (deviceId, playlistId) => `${apiUrl}/device-playlists/${deviceId}/${playlistId}`
        },
        DEVICES: {
            LIST: `${apiUrl}/devices`
        }
    };
}

// Usar window para evitar redeclaraciones
if (typeof window.currentPlaylistData === 'undefined') {
    window.currentPlaylistData = null;
}
if (typeof window.playlistVideos === 'undefined') {
    window.playlistVideos = [];
}
if (typeof window.availableVideos === 'undefined') {
    window.availableVideos = [];
}
if (typeof window.assignedDevices === 'undefined') {
    window.assignedDevices = [];
}

// ==========================================
// FUNCI√ìN getPlaylistId ROBUSTA
// ==========================================

function getPlaylistId() {
    console.log('üîç [getPlaylistId] Obteniendo ID de playlist...');
    
    // 1. Intentar desde el input hidden
    const hiddenInput = document.getElementById('playlist-id');
    if (hiddenInput && hiddenInput.value) {
        console.log('‚úÖ [getPlaylistId] ID desde input hidden:', hiddenInput.value);
        return hiddenInput.value;
    }
    
    // 2. Intentar desde la URL
    const urlParams = new URLSearchParams(window.location.search);
    const urlId = urlParams.get('id');
    if (urlId) {
        console.log('‚úÖ [getPlaylistId] ID de URL:', urlId);
        return urlId;
    }
    
    // 3. Intentar desde currentPlaylistData
    if (window.currentPlaylistData && window.currentPlaylistData.id) {
        console.log('‚úÖ [getPlaylistId] ID desde datos actuales:', window.currentPlaylistData.id);
        return window.currentPlaylistData.id;
    }
    
    console.error('‚ùå [getPlaylistId] No se pudo obtener el ID de la playlist');
    return null;
}

/**
 * Cargar datos desde el template
 */
function loadDataFromTemplate() {
    try {
        const playlistElement = document.getElementById('playlist-data');
        if (playlistElement && playlistElement.textContent) {
            const templateData = JSON.parse(playlistElement.textContent);
            const playlistVideos = templateData.videos || [];
            window.currentPlaylistData = templateData;
            window.playlistVideos = playlistVideos;
            
            console.log('üìã Datos de playlist cargados desde template:', templateData.title);
        }
    } catch (error) {
        console.warn('‚ö†Ô∏è Error cargando datos desde template:', error);
    }
}

// Cargar datos inmediatamente
loadDataFromTemplate();

// Hacer funciones disponibles globalmente
window.getPlaylistId = getPlaylistId;

// Cargar datos iniciales si est√°n disponibles
const playlistElement = document.getElementById('playlist-data');
if (playlistElement && playlistElement.textContent) {
    try {
        let jsonText = playlistElement.textContent.trim();
        
        // Corregir JSON malformado
        jsonText = jsonText
            .replace(/"([^"]+)":\s*,/g, '"$1": null,')
            .replace(/,\s*}/g, '}')
            .replace(/,\s*]/g, ']');
        
        const templateData = JSON.parse(jsonText);
        if (templateData && templateData.id) {
            window.currentPlaylistData = templateData;
            window.playlistVideos = templateData.videos || [];
            
            console.log('üìã Datos de playlist cargados desde template:', templateData.title);
        }
    } catch (error) {
        console.warn('‚ö†Ô∏è Error cargando datos desde template:', error);
    }
}

console.log('‚úÖ Configuraci√≥n base de playlist_detail cargada');
</script>

<!-- Script principal de funcionalidad -->
<script src="/static/js/playlist_detail.js"></script>
<script src="/static/js/device-assignment-modal.js"></script>
<script src="/static/js/assigned-devices-manager.js"></script>
<!-- Script espec√≠fico del template -->
<script>
/**
 * FUNCIONALIDAD ESPEC√çFICA DEL TEMPLATE PLAYLIST_DETAIL
 */

// ==========================================
// INICIALIZACI√ìN Y GESTI√ìN DE DATOS
// ==========================================

/**
 * Cargar datos de playlist desde el template JSON embebido
 */
function loadPlaylistDataFromTemplate() {
    try {
        const playlistElement = document.getElementById('playlist-data');
        if (playlistElement && playlistElement.textContent) {
            try {
                // Intentar cargar el JSON
                const data = JSON.parse(playlistElement.textContent);
                
                // Solo asignar a variables globales si se carg√≥ correctamente
                if (data && data.id) {
                    // Definir datos de playlist y videos
                    window.currentPlaylistData = data;
                    window.playlistVideos = data.videos || [];
                    
                    console.log('üìã Datos de playlist cargados desde template:', data.title);
                    
                    // Actualizar estad√≠sticas
                    updatePlaylistStats();
                    return true;
                }
            } catch (jsonError) {
                console.warn('‚ö†Ô∏è Error parseando JSON:', jsonError);
            }
        }
        
        console.warn('‚ö†Ô∏è No se pudieron cargar datos desde template');
        return false;
    } catch (error) {
        console.error('‚ùå Error cargando datos del template:', error);
        return false;
    }
}

// ==========================================
// FUNCIONES DE INTERFAZ DE USUARIO
// ==========================================

/**
 * Actualizar estad√≠sticas de la playlist
 */
function updatePlaylistStats() {
    console.log('üìä Actualizando estad√≠sticas...');
    
    const totalVideosEl = document.getElementById('totalVideos');
    const totalDurationEl = document.getElementById('totalDuration');
    const activeVideosEl = document.getElementById('activeVideos');
    const assignedDevicesEl = document.getElementById('assignedDevices');
    const playlistVideoCountEl = document.getElementById('playlistVideoCount');
    const availableVideoCountEl = document.getElementById('availableVideoCount');
    const deviceCountEl = document.getElementById('deviceCount');
    
    // Videos de la playlist
    const videoCount = window.playlistVideos ? window.playlistVideos.length : 0;
    const totalDuration = window.playlistVideos ? 
        window.playlistVideos.reduce((sum, video) => sum + (video.duration || 0), 0) : 0;
    
    // Disponibles
    const availableCount = window.availableVideos ? window.availableVideos.length : 0;
    
    // Dispositivos
    const deviceCount = window.assignedDevices ? window.assignedDevices.length : 0;
    
    // Actualizar elementos
    if (totalVideosEl) totalVideosEl.textContent = videoCount;
    if (totalDurationEl) totalDurationEl.textContent = formatDuration(totalDuration);
    if (assignedDevicesEl) assignedDevicesEl.textContent = deviceCount;
    if (playlistVideoCountEl) playlistVideoCountEl.textContent = videoCount;
    if (availableVideoCountEl) availableVideoCountEl.textContent = availableCount;
    if (deviceCountEl) deviceCountEl.textContent = deviceCount;
    
    console.log(`üìä Estad√≠sticas actualizadas: ${videoCount} videos, ${deviceCount} dispositivos`);
}

/**
 * Formatear duraci√≥n en segundos a formato MM:SS
 */
function formatDuration(seconds) {
    if (!seconds || isNaN(seconds)) return '00:00';
    
    seconds = Math.round(seconds);
    const minutes = Math.floor(seconds / 60);
    const remainingSeconds = seconds % 60;
    
    return `${minutes.toString().padStart(2, '0')}:${remainingSeconds.toString().padStart(2, '0')}`;
}

/**
 * Mostrar toast de notificaci√≥n
 */
function showToast(message, type = 'info') {
    console.log(`üîî Toast: ${message} (${type})`);
    
    // Implementaci√≥n b√°sica
    const toast = document.createElement('div');
    toast.className = `alert alert-${type} alert-dismissible fade show position-fixed bottom-0 end-0 m-3`;
    toast.setAttribute('role', 'alert');
    toast.style.zIndex = '9999';
    
    toast.innerHTML = `
        ${message}
        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
    `;
    
    document.body.appendChild(toast);
    
    // Auto cerrar despu√©s de 3 segundos
    setTimeout(() => {
        toast.classList.remove('show');
        setTimeout(() => toast.remove(), 300);
    }, 3000);
}

/**
 * Marcar que hay cambios sin guardar
 */
function markAsUnsaved() {
    window.hasUnsavedChanges = true;
    
    // Activar bot√≥n de guardar si existe
    const saveBtn = document.getElementById('saveChangesBtn');
    if (saveBtn) {
        saveBtn.disabled = false;
        saveBtn.classList.remove('btn-outline-primary');
        saveBtn.classList.add('btn-primary');
    }
}

/**
 * Confirmar eliminaci√≥n de playlist
 */
function confirmDeletePlaylist() {
    if (!window.currentPlaylistData) return;
    
    if (confirm(`¬øEst√°s seguro de que deseas eliminar la playlist "${window.currentPlaylistData.title}"? Esta acci√≥n no se puede deshacer.`)) {
        deletePlaylist();
    }
}

/**
 * Eliminar playlist
 */
async function deletePlaylist() {
    if (!window.currentPlaylistData || !window.currentPlaylistData.id) return;
    
    try {
        showToast('Eliminando playlist...', 'warning');
        
        const url = `/api/playlists/${window.currentPlaylistData.id}`;
        const response = await fetch(url, {
            method: 'DELETE'
        });
        
        if (!response.ok) {
            throw new Error(`Error ${response.status}: ${response.statusText}`);
        }
        
        showToast('Playlist eliminada correctamente', 'success');
        
        // Redireccionar a la lista de playlists
        setTimeout(() => {
            window.location.href = '/playlists';
        }, 1000);
        
    } catch (error) {
        console.error('‚ùå Error eliminando playlist:', error);
        showToast(`Error al eliminar: ${error.message}`, 'error');
    }
}

/**
 * Activar modo de edici√≥n de playlist
 */
function toggleEditMode() {
    console.log('‚úèÔ∏è Activando modo de edici√≥n...');
    
    // Implementaci√≥n b√°sica - redireccionar a p√°gina de edici√≥n
    if (window.currentPlaylistData && window.currentPlaylistData.id) {
        window.location.href = `/edit_playlist?id=${window.currentPlaylistData.id}`;
    } else {
        showToast('No se puede editar la playlist', 'error');
    }
}

/**
 * Exportar playlist como JSON
 */
function exportPlaylist() {
    if (!window.currentPlaylistData) {
        showToast('No hay datos para exportar', 'warning');
        return;
    }
    
    const exportData = {
        playlist: window.currentPlaylistData,
        videos: window.playlistVideos,
        exported_at: new Date().toISOString()
    };
    
    const dataStr = JSON.stringify(exportData, null, 2);
    const dataBlob = new Blob([dataStr], { type: 'application/json' });
    
    const link = document.createElement('a');
    link.href = URL.createObjectURL(dataBlob);
    link.download = `playlist_${window.currentPlaylistData.title.replace(/[^a-z0-9]/gi, '_')}.json`;
    link.click();
    
    showToast('Playlist exportada correctamente', 'success');
}

/**
 * Mezclar orden de playlist
 */
function shufflePlaylist() {
    if (!window.playlistVideos || window.playlistVideos.length < 2) {
        showToast('Necesitas al menos 2 videos para mezclar', 'warning');
        return;
    }
    
    // Crear copia y mezclar
    const shuffled = [...window.playlistVideos];
    for (let i = shuffled.length - 1; i > 0; i--) {
        const j = Math.floor(Math.random() * (i + 1));
        [shuffled[i], shuffled[j]] = [shuffled[j], shuffled[i]];
    }
    
    window.playlistVideos = shuffled;
    
    // Actualizar orden
    window.playlistVideos.forEach((video, index) => {
        video.order = index + 1;
        video.position = index + 1;
    });
    
    // Re-renderizar
    if (typeof updatePlaylistVideosTable === 'function') {
        updatePlaylistVideosTable();
    }
    
    markAsUnsaved();
    showToast('Orden de videos mezclado', 'success');
}

// ==========================================
// INICIALIZACI√ìN
// ==========================================

/**
 * Inicializar cuando el DOM est√© listo
 */
document.addEventListener('DOMContentLoaded', function() {
    console.log('üé¨ Inicializando template playlist_detail...');
    
    // Cargar datos desde template
    loadPlaylistDataFromTemplate();
    
    // Actualizar estad√≠sticas iniciales
    updatePlaylistStats();
    
    // Configurar advertencia de salida
    window.addEventListener('beforeunload', function(e) {
        if (window.hasUnsavedChanges) {
            e.preventDefault();
            e.returnValue = 'Tienes cambios sin guardar. ¬øEst√°s seguro de que quieres salir?';
        }
    });
    
    console.log('‚úÖ Template playlist_detail inicializado');
});

// Hacer funciones disponibles globalmente - CORREGIDO
// Solo asignamos, no declaramos variables que podr√≠an entrar en conflicto con playlist_detail.js
window.updatePlaylistStats = updatePlaylistStats;
window.formatDuration = formatDuration;
window.showToast = showToast;
window.markAsUnsaved = markAsUnsaved;
window.confirmDeletePlaylist = confirmDeletePlaylist;
window.deletePlaylist = deletePlaylist;
window.toggleEditMode = toggleEditMode;
window.exportPlaylist = exportPlaylist;
window.shufflePlaylist = shufflePlaylist;

console.log('‚úÖ Script espec√≠fico del template cargado');
</script>
{% endblock %}