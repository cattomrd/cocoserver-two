{% extends "base.html" %}

{% block content %}
<style>
    /* Estilos optimizados para vista de playlist */
    .playlist-drop-zone {
        border: 2px dashed #dee2e6;
        border-radius: 0.25rem;
        transition: all 0.3s ease;
        min-height: 100px;
    }

    .playlist-drop-zone.highlight-drop-zone {
        border-color: #0d6efd;
        background-color: rgba(13, 110, 253, 0.05);
    }

    .playlist-video-item {
        cursor: grab;
        transition: transform 0.2s ease, box-shadow 0.2s ease;
    }

    .playlist-video-item:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
    }

    .playlist-video-item.dragging {
        opacity: 0.7;
        transform: rotate(5deg);
        box-shadow: 0 8px 16px rgba(0, 0, 0, 0.2);
    }

    .available-video-item {
        cursor: grab;
        transition: transform 0.2s ease;
    }

    .available-video-item:hover {
        transform: translateX(5px);
        background-color: rgba(0, 123, 255, 0.05);
    }

    .drag-handle {
        cursor: grab;
        color: #6c757d;
        opacity: 0.7;
        transition: opacity 0.2s ease;
    }

    .playlist-video-item:hover .drag-handle {
        opacity: 1;
        color: #0d6efd;
    }

    .video-thumbnail {
        position: relative;
        overflow: hidden;
        border-radius: 0.25rem;
    }

    .video-thumbnail img {
        transition: transform 0.2s ease;
    }

    .video-thumbnail:hover img {
        transform: scale(1.05);
    }

    .playlist-stats .stat-card {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        border-radius: 0.5rem;
        padding: 1rem;
        text-align: center;
    }

    .playlist-stats .stat-value {
        font-size: 1.5rem;
        font-weight: bold;
        margin-bottom: 0.25rem;
    }

    .playlist-stats .stat-label {
        font-size: 0.875rem;
        opacity: 0.9;
    }

    /* Paginaci√≥n compacta */
    .pagination-container .pagination {
        margin-bottom: 0;
    }

    .pagination-container .page-item .page-link {
        padding: 0.25rem 0.5rem;
        font-size: 0.875rem;
    }

    /* Estado de videos */
    .video-status-indicator {
        width: 4px;
        height: 100%;
        position: absolute;
        left: 0;
        top: 0;
        border-radius: 0.25rem 0 0 0.25rem;
    }

    .video-status-active { background-color: #28a745; }
    .video-status-inactive { background-color: #6c757d; }
    .video-status-expired { background-color: #dc3545; }

    /* Responsive adjustments */
    @media (max-width: 768px) {
        .video-thumbnail img {
            width: 50px !important;
            height: 40px !important;
        }
        
        .playlist-stats .stat-card {
            margin-bottom: 0.5rem;
        }
    }

    /* Animaciones */
    .fade-in {
        animation: fadeIn 0.5s ease-in-out;
    }

    @keyframes fadeIn {
        from { opacity: 0; transform: translateY(10px); }
        to { opacity: 1; transform: translateY(0); }
    }

    /* Toast container */
    .toast-container {
        z-index: 9999;
    }
</style>

<div class="container-fluid">
    <!-- Campo oculto para el ID de la playlist -->
    <input type="hidden" id="playlist-id" value="{{ playlist.id }}">
    
    <!-- JSON data para JavaScript -->
    <script type="application/json" id="playlist-data">
        {
            "id": {{ playlist.id }},
            "title": "{{ playlist.title|escape }}",
            "description": "{{ playlist.description|escape if playlist.description else '' }}",
            "is_active": {{ playlist.is_active|lower }},
            "created_at": "{% if playlist.created_at or playlist.creation_date %}{{ (playlist.created_at or playlist.creation_date).isoformat() }}{% endif %}",
            "start_date": "{% if playlist.start_date %}{{ playlist.start_date.isoformat() }}{% endif %}",
            "expiration_date": "{% if playlist.expiration_date %}{{ playlist.expiration_date.isoformat() }}{% endif %}",
            "videos": {{ playlist.videos|tojson if playlist.videos else '[]' }}
        }
    </script>

    <!-- HEADER CON INFORMACI√ìN DE LA PLAYLIST -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card border-0 shadow-sm">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-start mb-3">
                        <div class="flex-grow-1">
                            <div class="d-flex align-items-center mb-2">
                                <h1 class="mb-0 me-3" id="pageTitle">{{ playlist.title }}</h1>
                                {% if playlist.is_active %}
                                    <span class="badge bg-success">Activa</span>
                                {% else %}
                                    <span class="badge bg-secondary">Inactiva</span>
                                {% endif %}
                            </div>
                            {% if playlist.description %}
                                <p class="text-muted mb-2">{{ playlist.description }}</p>
                            {% endif %}
                            <div class="d-flex flex-wrap gap-2">
                                <small class="text-muted">
                                    <i class="fas fa-calendar-plus me-1"></i>
                                    Creada: 
                                    {% if playlist.created_at or playlist.creation_date %}
                                        {{ (playlist.created_at or playlist.creation_date).strftime('%d/%m/%Y %H:%M') }}
                                    {% else %}
                                        <span class="text-muted">No especificada</span>
                                    {% endif %}
                                </small>
                                {% if playlist.start_date %}
                                    <small class="text-muted">
                                        <i class="fas fa-play-circle me-1"></i>
                                        Inicio: {{ playlist.start_date.strftime('%d/%m/%Y %H:%M') }}
                                    </small>
                                {% endif %}
                                {% if playlist.expiration_date %}
                                    <small class="text-muted">
                                        <i class="fas fa-stop-circle me-1"></i>
                                        Expira: {{ playlist.expiration_date.strftime('%d/%m/%Y %H:%M') }}
                                    </small>
                                {% endif %}
                            </div>
                        </div>
                        <div class="flex-shrink-0">
                            <a href="/ui/playlists" class="btn btn-outline-secondary">
                                <i class="fas fa-arrow-left me-1"></i>
                                Volver
                            </a>
                        </div>
                    </div>
                    
                    <!-- ESTAD√çSTICAS R√ÅPIDAS -->
                    <div class="row playlist-stats">
                        <div class="col-md-3 col-6 mb-2">
                            <div class="stat-card">
                                <div class="stat-value" id="totalVideos">{{ playlist.videos|length if playlist.videos else 0 }}</div>
                                <div class="stat-label">Videos</div>
                            </div>
                        </div>
                        <div class="col-md-3 col-6 mb-2">
                            <div class="stat-card">
                                <div class="stat-value" id="totalDuration">0m</div>
                                <div class="stat-label">Duraci√≥n Total</div>
                            </div>
                        </div>
                        <div class="col-md-3 col-6 mb-2">
                            <div class="stat-card">
                                <div class="stat-value" id="activeVideos">0</div>
                                <div class="stat-label">Videos Activos</div>
                            </div>
                        </div>
                        <div class="col-md-3 col-6 mb-2">
                            <div class="stat-card">
                                <div class="stat-value" id="assignedDevices">0</div>
                                <div class="stat-label">Dispositivos</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- BOTONES DE ACCI√ìN PRINCIPALES -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card border-0 shadow-sm">
                <div class="card-body py-2">
                    <div class="d-flex flex-wrap gap-2 justify-content-center">
                        <button type="button" class="btn btn-primary" onclick="previewPlaylist()" title="Ver lista completa">
                            <i class="fas fa-play me-1"></i> Vista Previa
                        </button>
                        <button type="button" class="btn btn-success" data-bs-toggle="modal" data-bs-target="#assignDeviceModal" title="Asignar dispositivos">
                            <i class="fas fa-tv me-1"></i> Asignar Dispositivos
                        </button>
                        <button type="button" class="btn btn-info" onclick="exportPlaylist()" title="Exportar playlist">
                            <i class="fas fa-download me-1"></i> Exportar
                        </button>
                        <button type="button" class="btn btn-warning" onclick="editPlaylistInfo()" title="Editar informaci√≥n">
                            <i class="fas fa-edit me-1"></i> Editar Info
                        </button>
                        <button type="button" class="btn btn-outline-danger" onclick="confirmDeletePlaylist()" title="Eliminar playlist">
                            <i class="fas fa-trash me-1"></i> Eliminar
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- CONTENEDOR PRINCIPAL: VIDEOS Y BIBLIOTECA -->
    <div class="row">
        <!-- PANEL IZQUIERDO: VIDEOS DE LA PLAYLIST -->
        <div class="col-lg-7">
            <div class="card border-0 shadow-sm h-100">
                <div class="card-header bg-gradient-primary text-white">
                    <div class="d-flex justify-content-between align-items-center">
                        <h5 class="mb-0">
                            <i class="fas fa-list-ol me-2"></i>Videos en la Lista
                        </h5>
                        <div class="d-flex align-items-center">
                            <span class="badge bg-light text-dark me-2" id="playlistVideoCount">
                                {{ playlist.videos|length if playlist.videos else 0 }} videos
                            </span>
                            <button class="btn btn-outline-light btn-sm" onclick="loadPlaylistData()" title="Recargar">
                                <i class="fas fa-sync-alt"></i>
                            </button>
                        </div>
                    </div>
                </div>
                <div class="card-body p-0">
                    <!-- Zona de Drop y Lista de Videos -->
                    <div id="playlistDropZone" class="playlist-drop-zone" style="height: 560px; overflow-y: auto;">
                        <!-- Mensaje cuando la lista est√° vac√≠a -->
                        <div id="emptyPlaylistMessage" class="text-center py-5 m-3" 
                             style="{{ 'display:none' if playlist.videos else 'display:block' }}">
                            <i class="fas fa-plus-circle fa-3x text-muted mb-3"></i>
                            <h5 class="text-muted">Lista Vac√≠a</h5>
                            <p class="text-muted mb-3">Arrastra videos desde la biblioteca o usa el bot√≥n + para a√±adir contenido</p>
                            <button class="btn btn-outline-primary" onclick="showAddVideosModal()">
                                <i class="fas fa-plus-circle me-1"></i> Agregar Videos
                            </button>
                        </div>
                        
                        <!-- Lista de Videos (cargada din√°micamente y desde template) -->
                        <div id="playlistVideosList" class="p-2">
                            {% if playlist.videos %}
                                {% for video in playlist.videos %}
                                <div class="playlist-video-item mb-2 fade-in" data-video-id="{{ video.id }}" data-order="{{ video.order or loop.index }}">
                                    <div class="card border-0 shadow-sm position-relative">
                                        <!-- Indicador de estado del video -->
                                        <div class="video-status-indicator {{ 'video-status-active' if video.is_active else 'video-status-inactive' }}"></div>
                                        
                                        <div class="card-body p-2">
                                            <div class="d-flex align-items-center">
                                                <div class="drag-handle me-2" title="Arrastrar para reordenar">
                                                    <i class="fas fa-grip-vertical"></i>
                                                </div>
                                                <div class="video-thumbnail me-3">
                                                    {% if video.thumbnail %}
                                                        <img src="{{ video.thumbnail }}" alt="Thumbnail" 
                                                             class="img-thumbnail" style="width: 60px; height: 45px; object-fit: cover;">
                                                    {% else %}
                                                        <div class="bg-secondary d-flex align-items-center justify-content-center text-white" 
                                                             style="width: 60px; height: 45px; border-radius: 0.25rem;">
                                                            <i class="fas fa-video"></i>
                                                        </div>
                                                    {% endif %}
                                                </div>
                                                <div class="flex-grow-1">
                                                    <h6 class="mb-1 video-title fw-bold">{{ video.title }}</h6>
                                                    <div class="d-flex align-items-center">
                                                        <span class="badge bg-primary me-2">{{ video.order or loop.index }}</span>
                                                        <small class="text-muted">
                                                            {{ video.duration|duration_format if video.duration else '0:00' }}
                                                        </small>
                                                        {% if not video.is_active %}
                                                            <span class="badge bg-warning ms-2">Inactivo</span>
                                                        {% endif %}
                                                    </div>
                                                </div>
                                                <div class="btn-group btn-group-sm">
                                                    <button class="btn btn-outline-primary" 
                                                            onclick="previewVideo({{ video.id }})"
                                                            title="Vista previa">
                                                        <i class="fas fa-play"></i>
                                                    </button>
                                                    <button class="btn btn-outline-danger" 
                                                            onclick="removeVideoFromPlaylist({{ video.id }})"
                                                            title="Quitar de la lista">
                                                        <i class="fas fa-times"></i>
                                                    </button>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                {% endfor %}
                            {% endif %}
                        </div>
                    </div>
                </div>
                <div class="card-footer bg-light">
                    <div class="d-flex justify-content-between align-items-center">
                        <small class="text-muted">
                            <i class="fas fa-info-circle me-1"></i>
                            Arrastra para reordenar ‚Ä¢ Total: <span id="totalPlaylistDuration">0:00</span>
                        </small>
                        <div class="btn-group btn-group-sm">
                            <button class="btn btn-outline-success" onclick="showAddVideosModal()" title="Agregar videos">
                                <i class="fas fa-plus"></i>
                            </button>
                            <button class="btn btn-outline-danger" onclick="clearPlaylist()" title="Vaciar lista">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- PANEL DERECHO: BIBLIOTECA DE VIDEOS -->
        <div class="col-lg-5">
            <div class="card border-0 shadow-sm h-100">
                <div class="card-header bg-info text-white">
                    <div class="d-flex justify-content-between align-items-center">
                        <h5 class="mb-0">
                            <i class="fas fa-video me-2"></i>Biblioteca
                        </h5>
                        <div class="d-flex align-items-center">
                            <span class="badge bg-light text-dark me-2" id="availableVideoCount">0 videos</span>
                            <button class="btn btn-outline-light btn-sm" onclick="loadAvailableVideos()" title="Recargar">
                                <i class="fas fa-sync-alt"></i>
                            </button>
                        </div>
                    </div>
                </div>
                <div class="card-body p-0">
                    <!-- Controles de b√∫squeda y filtrado -->
                    <div class="p-3 border-bottom bg-light">
                        <div class="input-group input-group-sm">
                            <input type="text" id="videoSearch" class="form-control" 
                                   placeholder="Buscar videos...">
                            <button class="btn btn-outline-secondary" type="button" id="clearVideoSearchBtn">
                                <i class="fas fa-times"></i>
                            </button>
                        </div>
                    </div>
                    
                    <!-- Lista de Videos Disponibles -->
                    <div id="availableVideosContainer" style="height: 450px; overflow-y: auto;">
                        <div id="availableVideosList" class="p-2">
                            <!-- Loading inicial -->
                            <div class="text-center py-4" id="loadingAvailableVideos">
                                <div class="spinner-border text-primary" role="status">
                                    <span class="visually-hidden">Cargando...</span>
                                </div>
                                <p class="mt-2 text-muted">Cargando videos disponibles...</p>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="card-footer bg-light">
                    <!-- Controles de paginaci√≥n -->
                    <div class="pagination-container d-none">
                        <div class="d-flex justify-content-between align-items-center">
                            <small class="text-muted">
                                P√°gina <span id="currentPage">1</span> de <span id="totalPages">1</span>
                            </small>
                            <div class="btn-group btn-group-sm">
                                <button class="btn btn-outline-secondary" id="prevPageBtn" onclick="goToPrevPage()" disabled>
                                    <i class="fas fa-chevron-left"></i>
                                </button>
                                <button class="btn btn-outline-secondary" id="nextPageBtn" onclick="goToNextPage()">
                                    <i class="fas fa-chevron-right"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                    <small class="text-muted">
                        <i class="fas fa-hand-point-right me-1"></i>
                        Arrastra videos hacia la lista o usa <i class="fas fa-plus"></i>
                    </small>
                </div>
            </div>
        </div>
    </div>

    <!-- SECCI√ìN DE DISPOSITIVOS ASIGNADOS -->
    <div class="row mt-4">
        <div class="col-12">
            <div class="card border-0 shadow-sm">
                <div class="card-header bg-gradient-secondary text-white d-flex justify-content-between align-items-center">
                    <h5 class="mb-0">
                        <i class="fas fa-tv me-2"></i>Dispositivos Asignados
                    </h5>
                    <button class="btn btn-outline-light btn-sm" data-bs-toggle="modal" data-bs-target="#assignDeviceModal">
                        <i class="fas fa-plus-circle me-1"></i> Asignar Dispositivo
                    </button>
                </div>
                <div class="card-body p-0">
                    <!-- Loading de dispositivos asignados -->
                    <div id="loadingAssignedDevices" class="text-center py-3 d-none">
                        <div class="spinner-border spinner-border-sm text-primary" role="status">
                            <span class="visually-hidden">Cargando...</span>
                        </div>
                        <p class="mt-1 text-muted small">Cargando dispositivos asignados...</p>
                    </div>
                    
                    <!-- Mensaje cuando no hay dispositivos -->
                    <div id="assignedDevicesEmpty" class="text-center py-4">
                        <i class="fas fa-tv fa-2x text-muted mb-3"></i>
                        <p class="text-muted mb-2">No hay dispositivos asignados a esta lista</p>
                        <button class="btn btn-sm btn-outline-primary" data-bs-toggle="modal" data-bs-target="#assignDeviceModal">
                            <i class="fas fa-plus-circle me-1"></i> Asignar Dispositivo
                        </button>
                    </div>
                    
                    <!-- Tabla de dispositivos asignados -->
                    <div id="assignedDevicesTable" class="table-responsive d-none">
                        <table class="table table-hover table-striped mb-0">
                            <thead class="table-light">
                                <tr>
                                    <th>Dispositivo</th>
                                    <th>Ubicaci√≥n</th>
                                    <th>Estado</th>
                                    <th>√öltima Conexi√≥n</th>
                                    <th class="text-end">Acciones</th>
                                </tr>
                            </thead>
                            <tbody id="assignedDevicesList">
                                <!-- Los dispositivos asignados se cargar√°n din√°micamente -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- MODAL PARA ASIGNAR DISPOSITIVOS -->
<div class="modal fade" id="assignDeviceModal" tabindex="-1" aria-labelledby="assignDeviceModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="assignDeviceModalLabel">
                    <i class="fas fa-tv me-2"></i>Asignar Dispositivos
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Cerrar"></button>
            </div>
            <div class="modal-body">
                <!-- Buscador de dispositivos -->
                <div class="mb-3">
                    <div class="input-group">
                        <input type="text" id="deviceSearchInput" class="form-control" placeholder="Buscar dispositivos por nombre, ubicaci√≥n o MAC...">
                        <button class="btn btn-outline-secondary" type="button" id="clearDeviceSearch">
                            <i class="fas fa-times"></i>
                        </button>
                    </div>
                </div>
                
                <!-- Selector de estado para filtrar -->
                <div class="mb-3">
                    <select class="form-select" id="deviceStatusFilter">
                        <option value="all" selected>Todos los dispositivos</option>
                        <option value="active">Solo activos</option>
                        <option value="inactive">Solo inactivos</option>
                        <option value="unassigned">No asignados a esta lista</option>
                    </select>
                </div>
                
                <!-- Tabla de dispositivos -->
                <div id="availableDevicesTable" class="table-responsive" style="max-height: 400px; overflow-y: auto;">
                    <table class="table table-hover table-sm mb-0">
                        <thead class="table-light sticky-top">
                            <tr>
                                <th style="width: 50px;"></th>
                                <th>Dispositivo</th>
                                <th>Ubicaci√≥n</th>
                                <th>Estado</th>
                                <th>Asignado</th>
                            </tr>
                        </thead>
                        <tbody id="availableDevicesList">
                            <tr>
                                <td colspan="5" class="text-center py-3">
                                    <div class="spinner-border spinner-border-sm text-primary" role="status">
                                        <span class="visually-hidden">Cargando...</span>
                                    </div>
                                    <p class="mt-1 text-muted small mb-0">Cargando dispositivos...</p>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                    <i class="fas fa-times me-1"></i>Cancelar
                </button>
                <button type="button" class="btn btn-primary" id="saveDeviceAssignments" disabled>
                    <i class="fas fa-save me-1"></i> Guardar Asignaciones
                </button>
            </div>
        </div>
    </div>
</div>

<!-- MODAL PARA VISTA PREVIA DE VIDEO -->
<div class="modal fade" id="videoPreviewModal" tabindex="-1" aria-labelledby="videoPreviewModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="videoPreviewModalTitle">Vista Previa</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Cerrar"></button>
            </div>
            <div class="modal-body p-0">
                <div class="ratio ratio-16x9">
                    <video id="previewVideoPlayer" class="w-100" controls>
                        Tu navegador no soporta el elemento video.
                    </video>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Loading Indicator -->
<div id="loadingIndicator" class="position-fixed top-0 start-0 w-100 h-100 d-none" 
     style="background-color: rgba(0,0,0,0.5); z-index: 9998;">
    <div class="d-flex justify-content-center align-items-center h-100">
        <div class="card shadow">
            <div class="card-body text-center">
                <div class="spinner-border text-primary mb-2" role="status">
                    <span class="visually-hidden">Cargando...</span>
                </div>
                <p class="mb-0">Procesando...</p>
            </div>
        </div>
    </div>
</div>

{% endblock %}

{% block extra_scripts %}
    <!-- Script principal de playlist -->
     <script>
    (function() {
        // Guardar la funci√≥n fetch original
        const originalFetch = window.fetch;
        
        // Funci√≥n para convertir URL a HTTPS
        function forceHttpsUrl(url) {
            // Si es string y comienza con http:, convertir a https:
            if (typeof url === 'string') {
                // URL completa con protocolo HTTP
                if (url.startsWith('http:')) {
                    return url.replace(/^http:/i, 'https:');
                }
                
                // URL relativa
                if (url.startsWith('/')) {
                    return window.location.origin + url;
                }
                
                // URL sin protocolo
                if (!url.startsWith('https:') && !url.startsWith('/')) {
                    // Si contiene dominio pero sin protocolo
                    if (url.includes('gestionpi-test.ikeasi.com')) {
                        return 'https://' + url;
                    }
                    // URL relativa sin barra inicial
                    return window.location.origin + '/' + url;
                }
            }
            return url;
        }
        
        // Sobrescribir fetch global
        window.fetch = function(url, options) {
            const secureUrl = forceHttpsUrl(url);
            console.log(`üîí Fetch interceptado: ${url} -> ${secureUrl}`);
            return originalFetch.call(this, secureUrl, options);
        };
        
        // Sobrescribir XMLHttpRequest para forzar HTTPS (algunas librer√≠as usan XHR en lugar de fetch)
        const originalXhrOpen = XMLHttpRequest.prototype.open;
        XMLHttpRequest.prototype.open = function(method, url, ...rest) {
            const secureUrl = forceHttpsUrl(url);
            console.log(`üîí XHR interceptado: ${url} -> ${secureUrl}`);
            return originalXhrOpen.call(this, method, secureUrl, ...rest);
        };
        
        // Definir una URL base global segura
        window.API_BASE_URL = window.location.origin + '/api';
        
        console.log('üîí HTTPS Enforcer activado - Todas las solicitudes usar√°n HTTPS');
    })();
    </script>
    <script src="/static/js/playlist_detail.js"></script>
    
    <!-- Script espec√≠fico del modal de dispositivos -->
    <script src="/static/js/device-assignment-modal.js"></script>
    
    <!-- Script para gestionar dispositivos asignados -->
    <script src="/static/js/assigned-devices-manager.js"></script>
    
    <!-- Script adicional para funcionalidades espec√≠ficas de vista -->
    <script>
    // ==========================================
    // FUNCIONES ESPEC√çFICAS DE LA VISTA
    // ==========================================
    
    /**
     * Funci√≥n para editar informaci√≥n de la playlist
     */
    function editPlaylistInfo() {
        // Aqu√≠ puedes abrir un modal de edici√≥n o redirigir a p√°gina de edici√≥n
        const editUrl = `/ui/playlists/${getPlaylistId()}/edit`;
        window.location.href = editUrl;
    }
    
    /**
     * Funci√≥n para confirmar eliminaci√≥n de playlist
     */
    function confirmDeletePlaylist() {
        if (confirm('¬øEst√°s seguro de que deseas eliminar esta lista de reproducci√≥n? Esta acci√≥n no se puede deshacer.')) {
            deletePlaylist();
        }
    }
    
    /**
     * Funci√≥n para eliminar playlist
     */
    async function deletePlaylist() {
        const playlistId = getPlaylistId();
        if (!playlistId) {
            showToast('Error: No se pudo determinar el ID de la playlist', 'error');
            return;
        }
        
        try {
            showLoadingState('Eliminando lista de reproducci√≥n...');
            
            const response = await fetch(`${API_URL}/playlists/${playlistId}`, {
                method: 'DELETE',
                headers: {
                    'Content-Type': 'application/json'
                }
            });

            if (!response.ok) {
                throw new Error('Error al eliminar la playlist');
            }
            
            showToast('Lista de reproducci√≥n eliminada correctamente', 'success');
            
            // Redirigir a la lista de playlists despu√©s de un breve delay
            setTimeout(() => {
                window.location.href = '/ui/playlists';
            }, 1500);
            
        } catch (error) {
            console.error('Error eliminando playlist:', error);
            hideLoadingState();
            showToast(`Error al eliminar la playlist: ${error.message}`, 'error');
        }
    }

    // Hacer funciones disponibles globalmente
    window.editPlaylistInfo = editPlaylistInfo;
    window.confirmDeletePlaylist = confirmDeletePlaylist;
    window.deletePlaylist = deletePlaylist;
    window.showAddVideosModal = showAddVideosModal;
    window.exportPlaylist = exportPlaylist;
    window.formatDuration = formatDuration;
    window.formatDurationsOnPage = formatDurationsOnPage;
    
    /**
     * Mostrar modal para agregar m√∫ltiples videos
     */
    function showAddVideosModal() {
        // Implementar modal para selecci√≥n m√∫ltiple de videos
        showToast('Funci√≥n de agregar m√∫ltiples videos en desarrollo', 'info');
    }
    
    /**
     * Funci√≥n para exportar playlist
     */
    function exportPlaylist() {
        // Implementar opciones de exportaci√≥n (JSON, CSV, PDF)
        showToast('Funci√≥n de exportaci√≥n en desarrollo', 'info');
    }
    
    /**
     * Cargar dispositivos asignados en las estad√≠sticas
     */
    async function loadAssignedDevicesCount() {
        const playlistId = getPlaylistId();
        if (!playlistId) return;
        
        try {
            const response = await fetch(`${API_URL}/device-playlists/playlist/${playlistId}/devices`);
            if (response.ok) {
                const devices = await response.json();
                const countElement = document.getElementById('assignedDevices');
                if (countElement) {
                    countElement.textContent = devices.length;
                }
                
                // Guardar datos para uso posterior
                window.assignedDevicesData = devices;
            }
        } catch (error) {
            console.error('Error cargando dispositivos asignados:', error);
        }
    }
    
    /**
     * Formatear duraciones en la p√°gina
     */
    function formatDurationsOnPage() {
        const durationElements = document.querySelectorAll('.video-duration[data-duration]');
        let totalSeconds = 0;
        
        durationElements.forEach(element => {
            const duration = parseInt(element.getAttribute('data-duration')) || 0;
            element.textContent = formatDuration(duration);
            totalSeconds += duration;
        });
        
        // Actualizar duraci√≥n total en estad√≠sticas
        const totalDurationElement = document.getElementById('totalDuration');
        if (totalDurationElement) {
            totalDurationElement.textContent = formatDuration(totalSeconds);
        }
        
        // Actualizar duraci√≥n total en footer
        const totalPlaylistDurationElement = document.getElementById('totalPlaylistDuration');
        if (totalPlaylistDurationElement) {
            totalPlaylistDurationElement.textContent = formatDuration(totalSeconds);
        }
        
        // Contar videos activos
        const videoItems = document.querySelectorAll('.playlist-video-item');
        let activeVideosCount = 0;
        
        videoItems.forEach(item => {
            // Si el item no tiene un badge de "Inactivo", es activo
            const inactiveBadge = item.querySelector('.badge.bg-warning');
            if (!inactiveBadge) {
                activeVideosCount++;
            }
        });
        
        const activeVideosElement = document.getElementById('activeVideos');
        if (activeVideosElement) {
            activeVideosElement.textContent = activeVideosCount;
        }
    }
    
    /**
     * Formatear duraci√≥n en segundos a MM:SS o HH:MM:SS
     */
    function formatDuration(seconds) {
        if (!seconds || seconds === 0) return '0:00';
        
        const hours = Math.floor(seconds / 3600);
        const minutes = Math.floor((seconds % 3600) / 60);
        const secs = Math.floor(seconds % 60);
        
        if (hours > 0) {
            return `${hours}:${minutes.toString().padStart(2, '0')}:${secs.toString().padStart(2, '0')}`;
        } else {
            return `${minutes}:${secs.toString().padStart(2, '0')}`;
        }
    }
    
    /**
     * Inicializaci√≥n adicional para la vista
     */
    document.addEventListener('DOMContentLoaded', function() {
        // Formatear duraciones en la p√°gina
        formatDurationsOnPage();
        
        // Cargar conteo de dispositivos asignados
        loadAssignedDevicesCount();
        
        // Configurar tooltips de Bootstrap si est√°n disponibles
        if (typeof bootstrap !== 'undefined' && bootstrap.Tooltip) {
            var tooltipTriggerList = [].slice.call(document.querySelectorAll('[title]'));
            var tooltipList = tooltipTriggerList.map(function (tooltipTriggerEl) {
                return new bootstrap.Tooltip(tooltipTriggerEl);
            });
        }
        
        // Cargar dispositivos asignados con un peque√±o delay para asegurar que todos los scripts est√©n listos
        setTimeout(function() {
            if (typeof window.loadAssignedDevices === 'function') {
                window.loadAssignedDevices();
            }
        }, 1000);
    });
    </script>
{% endblock %}