{% extends "/base.html" %}
{% set title = playlist.title if playlist else "Lista de Reproducción" %}

{% block styles %}
<link href="{{ url_for('static', path='/css/playlists.css') }}" rel="stylesheet">
<style>
    .playlist-header {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        padding: 2rem 0;
        margin-bottom: 2rem;
        border-radius: 0.5rem;
    }
    
    .video-item {
        transition: all 0.3s ease;
        border: 1px solid #e0e0e0;
        border-radius: 0.5rem;
        margin-bottom: 1rem;
        background: white;
    }
    
    .video-item:hover {
        box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        transform: translateY(-2px);
    }
    
    .video-thumbnail {
        width: 120px;
        height: 90px;
        object-fit: cover;
        border-radius: 0.375rem;
    }
    
    .video-duration {
        position: absolute;
        bottom: 5px;
        right: 5px;
        background: rgba(0,0,0,0.8);
        color: white;
        padding: 2px 6px;
        border-radius: 3px;
        font-size: 0.75rem;
    }
    
    .playlist-stats {
        background: rgba(255,255,255,0.1);
        border-radius: 0.5rem;
        padding: 1rem;
        backdrop-filter: blur(10px);
    }
    
    .video-order {
        background: #6c757d;
        color: white;
        border-radius: 50%;
        width: 30px;
        height: 30px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-weight: bold;
        font-size: 0.875rem;
    }
    
    .control-panel {
        position: sticky;
        top: 20px;
        z-index: 1000;
    }

    .playlist-videos-container {
        background: #f8f9fa;
        border-radius: 0.5rem;
        padding: 1.5rem;
        margin-top: 2rem;
    }

    .video-list-header {
        background: white;
        border-radius: 0.5rem;
        padding: 1rem;
        margin-bottom: 1rem;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }

    .empty-playlist {
        text-align: center;
        padding: 3rem 1rem;
        color: #6c757d;
    }

    .loading-spinner {
        display: flex;
        justify-content: center;
        align-items: center;
        padding: 2rem;
    }

    .video-actions {
        opacity: 0;
        transition: opacity 0.3s ease;
    }

    .video-item:hover .video-actions {
        opacity: 1;
    }
    
    @media (max-width: 768px) {
        .video-thumbnail {
            width: 80px;
            height: 60px;
        }
        
        .playlist-header {
            padding: 1rem 0;
        }
    }
</style>
{% endblock %}

{% block content %}
<main class="container-fluid py-4">
    <!-- Header de la Playlist -->
    <div class="playlist-header">
        <div class="container">
            <div class="row align-items-center">
                <div class="col-md-8">
                    <div class="d-flex align-items-center mb-3">
                        <a href="{{ url_for('get_playlists_page') }}" class="btn btn-outline-light me-3">
                            <i class="fas fa-arrow-left"></i> Volver
                        </a>
                        <div>
                            <h1 class="mb-0" id="playlistTitle">{{ playlist.title if playlist else "Lista de Reproducción" }}</h1>
                            <p class="mb-0 opacity-75" id="playlistDescription">
                                {{ playlist.description if playlist and playlist.description else "Descripción no disponible" }}
                            </p>
                        </div>
                    </div>
                </div>
                <div class="col-md-4">
                    <div class="playlist-stats">
                        <div class="row text-center">
                            <div class="col">
                                <div class="h3 mb-0" id="videoCount">{{ playlist.video_count if playlist else 0 }}</div>
                                <small>Videos</small>
                            </div>
                            <div class="col">
                                <div class="h3 mb-0" id="totalDuration">--:--</div>
                                <small>Duración</small>
                            </div>
                            <div class="col">
                                <div class="h3 mb-0">
                                    <span class="badge {{ 'bg-success' if playlist and playlist.is_active else 'bg-secondary' }}" id="statusBadge">
                                        {{ 'Activa' if playlist and playlist.is_active else 'Inactiva' }}
                                    </span>
                                </div>
                                <small>Estado</small>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Panel de Control -->
    <div class="container">
        <div class="row">
            <div class="col-md-3">
                <div class="control-panel">
                    <div class="card">
                        <div class="card-header">
                            <h6 class="mb-0"><i class="fas fa-cog"></i> Controles</h6>
                        </div>
                        <div class="card-body">
                            <div class="d-grid gap-2">
                                <button class="btn btn-primary" onclick="editPlaylist()">
                                    <i class="fas fa-edit"></i> Editar Lista
                                </button>
                                <button class="btn btn-outline-primary" onclick="playAllVideos()">
                                    <i class="fas fa-play"></i> Reproducir Todo
                                </button>
                                <button class="btn btn-outline-secondary" onclick="refreshPlaylistVideos()">
                                    <i class="fas fa-sync"></i> Actualizar Videos
                                </button>
                            </div>
                            
                            <!-- Información adicional -->
                            <hr>
                            <div class="small text-muted">
                                <div class="d-flex justify-content-between mb-1">
                                    <span>Creada:</span>
                                    <span id="creationDate">{{ playlist.created_at.strftime('%d/%m/%Y') if playlist and playlist.created_at else '--' }}</span>
                                </div>
                                <div class="d-flex justify-content-between mb-1">
                                    <span>Actualizada:</span>
                                    <span id="lastUpdate">{{ playlist.updated_at.strftime('%d/%m/%Y') if playlist and playlist.updated_at else '--' }}</span>
                                </div>
                                {% if playlist and playlist.start_date %}
                                <div class="d-flex justify-content-between mb-1">
                                    <span>Inicio:</span>
                                    <span>{{ playlist.start_date.strftime('%d/%m/%Y %H:%M') }}</span>
                                </div>
                                {% endif %}
                                {% if playlist and playlist.expiration_date %}
                                <div class="d-flex justify-content-between">
                                    <span>Expira:</span>
                                    <span>{{ playlist.expiration_date.strftime('%d/%m/%Y %H:%M') }}</span>
                                </div>
                                {% endif %}
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Lista de Videos -->
            <div class="col-md-9">
                <div class="playlist-videos-container">
                    <div class="video-list-header">
                        <div class="row align-items-center">
                            <div class="col">
                                <h5 class="mb-0">
                                    <i class="fas fa-video"></i> Videos de la Lista
                                    <span class="badge bg-primary ms-2" id="playlistVideoCount">0 videos</span>
                                </h5>
                            </div>
                            <div class="col-auto">
                                <div class="btn-group btn-group-sm">
                                    <button class="btn btn-outline-secondary" onclick="sortPlaylistVideos('order')">
                                        <i class="fas fa-sort-numeric-up"></i> Orden
                                    </button>
                                    <button class="btn btn-outline-secondary" onclick="sortPlaylistVideos('title')">
                                        <i class="fas fa-sort-alpha-up"></i> Título
                                    </button>
                                    <button class="btn btn-outline-secondary" onclick="sortPlaylistVideos('duration')">
                                        <i class="fas fa-clock"></i> Duración
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Loading State -->
                    <div id="loadingPlaylistVideos" class="loading-spinner" style="display: none;">
                        <div class="spinner-border text-primary" role="status">
                            <span class="visually-hidden">Cargando videos...</span>
                        </div>
                    </div>

                    <!-- Empty State -->
                    <div id="emptyPlaylistMessage" class="empty-playlist" style="display: none;">
                        <i class="fas fa-video fa-3x mb-3 text-muted"></i>
                        <h5>No hay videos en esta lista</h5>
                        <p class="text-muted">Esta lista de reproducción está vacía.</p>
                        <button class="btn btn-primary" onclick="editPlaylist()">
                            <i class="fas fa-plus"></i> Agregar Videos
                        </button>
                    </div>

                    <!-- Lista de Videos -->
                    <div id="playlistVideosList">
                        <!-- Los videos se cargarán dinámicamente aquí -->
                    </div>
                </div>
            </div>
        </div>
    </div>
</main>

<!-- Modal para reproducir video -->
<div class="modal fade" id="videoPlayerModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="videoPlayerTitle">Reproduciendo Video</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body p-0">
                <div id="videoPlayerContainer" style="background: #000; min-height: 300px;">
                    <!-- El reproductor se cargará aquí -->
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cerrar</button>
                <button type="button" class="btn btn-primary" onclick="playNextVideo()">
                    <i class="fas fa-step-forward"></i> Siguiente
                </button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_scripts %}
<script>
// ==========================================
// VARIABLES GLOBALES
// ==========================================
let currentPlaylistData = {{ playlist|tojson if playlist else 'null' }};
let playlistVideos = [];
let currentVideoIndex = 0;
let isLoading = false;

// ==========================================
// FUNCIONES PRINCIPALES DE CARGA
// ==========================================

/**
 * Cargar los videos de la playlist actual
 */
async function loadPlaylistVideos() {
    if (!currentPlaylistData || !currentPlaylistData.id) {
        console.warn('No hay playlist cargada');
        showEmptyState();
        return;
    }

    showLoadingState();
    
    try {
        console.log('🎵 Cargando videos de playlist:', currentPlaylistData.id);
        
        const response = await fetch(`/api/playlists/${currentPlaylistData.id}/videos`);
        if (!response.ok) throw new Error('Error al cargar videos de la playlist');
        
        const data = await response.json();
        playlistVideos = Array.isArray(data) ? data : (data.videos || []);
        
        console.log('✅ Videos cargados:', playlistVideos.length);
        
        renderPlaylistVideos();
        updatePlaylistStats();
        
    } catch (error) {
        console.error('❌ Error cargando videos:', error);
        showErrorState('Error al cargar los videos de la lista');
    }
}

/**
 * Renderizar los videos en la interfaz
 */
function renderPlaylistVideos() {
    const container = document.getElementById('playlistVideosList');
    const emptyMessage = document.getElementById('emptyPlaylistMessage');
    const loadingElement = document.getElementById('loadingPlaylistVideos');
    
    // Ocultar loading
    if (loadingElement) loadingElement.style.display = 'none';
    
    if (!playlistVideos || playlistVideos.length === 0) {
        showEmptyState();
        return;
    }

    // Ocultar mensaje vacío
    if (emptyMessage) emptyMessage.style.display = 'none';
    
    // Generar HTML de videos
    const videosHTML = playlistVideos.map((video, index) => {
        const thumbnailUrl = video.thumbnail_url || '/static/images/default-video.jpg';
        const duration = formatDuration(video.duration || 0);
        const status = getVideoStatus(video);
        
        return `
        <div class="video-item" data-video-id="${video.id}" data-order="${video.order || index + 1}">
            <div class="row g-0 align-items-center p-3">
                <div class="col-auto me-3">
                    <div class="video-order">${video.order || index + 1}</div>
                </div>
                <div class="col-auto me-3">
                    <div class="position-relative">
                        <img src="${thumbnailUrl}" alt="${escapeHtml(video.title)}" class="video-thumbnail">
                        <div class="video-duration">${duration}</div>
                    </div>
                </div>
                <div class="col">
                    <div class="row">
                        <div class="col-md-8">
                            <h6 class="mb-1">${escapeHtml(video.title)}</h6>
                            <p class="mb-1 text-muted small">${escapeHtml(video.description || 'Sin descripción')}</p>
                            <div class="d-flex align-items-center">
                                <span class="badge ${status.class} me-2">${status.text}</span>
                                ${video.tags ? video.tags.split(',').map(tag => `<span class="badge bg-light text-dark me-1">${tag.trim()}</span>`).join('') : ''}
                            </div>
                        </div>
                        <div class="col-md-4 text-end">
                            <div class="video-actions">
                                <button class="btn btn-sm btn-primary me-1" onclick="playVideo(${index})" title="Reproducir">
                                    <i class="fas fa-play"></i>
                                </button>
                                <button class="btn btn-sm btn-outline-secondary me-1" onclick="showVideoDetails(${video.id})" title="Detalles">
                                    <i class="fas fa-info"></i>
                                </button>
                                <button class="btn btn-sm btn-outline-danger" onclick="removeVideoFromPlaylist(${video.id})" title="Quitar de la lista">
                                    <i class="fas fa-times"></i>
                                </button>
                            </div>
                            <div class="small text-muted mt-1">
                                ${video.file_size ? formatFileSize(video.file_size) : ''}
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        `;
    }).join('');
    
    container.innerHTML = videosHTML;
    
    // Actualizar contador
    const countElement = document.getElementById('playlistVideoCount');
    if (countElement) {
        countElement.textContent = `${playlistVideos.length} video${playlistVideos.length !== 1 ? 's' : ''}`;
    }
}

// ==========================================
// FUNCIONES DE REPRODUCCIÓN
// ==========================================

/**
 * Reproducir un video específico
 */
function playVideo(index) {
    if (!playlistVideos[index]) return;
    
    currentVideoIndex = index;
    const video = playlistVideos[index];
    
    const modal = new bootstrap.Modal(document.getElementById('videoPlayerModal'));
    document.getElementById('videoPlayerTitle').textContent = video.title;
    
    // Crear reproductor
    const container = document.getElementById('videoPlayerContainer');
    container.innerHTML = `
        <video controls style="width: 100%; height: 400px;" autoplay>
            <source src="/videos/${video.filename}" type="video/mp4">
            Tu navegador no soporta la reproducción de video.
        </video>
    `;
    
    modal.show();
}

/**
 * Reproducir siguiente video
 */
function playNextVideo() {
    if (currentVideoIndex < playlistVideos.length - 1) {
        playVideo(currentVideoIndex + 1);
    }
}

/**
 * Reproducir todos los videos
 */
function playAllVideos() {
    if (playlistVideos.length > 0) {
        playVideo(0);
    }
}

// ==========================================
// FUNCIONES DE GESTIÓN
// ==========================================

/**
 * Editar la playlist
 */
function editPlaylist() {
    if (currentPlaylistData && currentPlaylistData.id) {
        window.location.href = `/ui/edit-playlists?id=${currentPlaylistData.id}`;
    }
}

/**
 * Actualizar videos de la playlist
 */
function refreshPlaylistVideos() {
    loadPlaylistVideos();
}

/**
 * Quitar video de la playlist
 */
async function removeVideoFromPlaylist(videoId) {
    if (!confirm('¿Estás seguro de quitar este video de la lista?')) return;
    
    try {
        const response = await fetch(`/api/playlists/${currentPlaylistData.id}/videos/${videoId}`, {
            method: 'DELETE'
        });
        
        if (response.ok) {
            showToast('Video quitado de la lista', 'success');
            loadPlaylistVideos(); // Recargar videos
        } else {
            throw new Error('Error al quitar video');
        }
    } catch (error) {
        console.error('Error:', error);
        showToast('Error al quitar el video', 'error');
    }
}

/**
 * Ordenar videos de la playlist
 */
function sortPlaylistVideos(sortBy) {
    if (!playlistVideos || playlistVideos.length === 0) return;
    
    const sortedVideos = [...playlistVideos].sort((a, b) => {
        switch (sortBy) {
            case 'order':
                return (a.order || 0) - (b.order || 0);
            case 'title':
                return a.title.localeCompare(b.title);
            case 'duration':
                return (a.duration || 0) - (b.duration || 0);
            default:
                return 0;
        }
    });
    
    playlistVideos = sortedVideos;
    renderPlaylistVideos();
}

// ==========================================
// FUNCIONES DE ESTADO Y UI
// ==========================================

function showLoadingState() {
    const loadingElement = document.getElementById('loadingPlaylistVideos');
    const emptyMessage = document.getElementById('emptyPlaylistMessage');
    const videosList = document.getElementById('playlistVideosList');
    
    if (loadingElement) loadingElement.style.display = 'flex';
    if (emptyMessage) emptyMessage.style.display = 'none';
    if (videosList) videosList.innerHTML = '';
}

function showEmptyState() {
    const loadingElement = document.getElementById('loadingPlaylistVideos');
    const emptyMessage = document.getElementById('emptyPlaylistMessage');
    const videosList = document.getElementById('playlistVideosList');
    
    if (loadingElement) loadingElement.style.display = 'none';
    if (emptyMessage) emptyMessage.style.display = 'block';
    if (videosList) videosList.innerHTML = '';
    
    // Actualizar contador
    const countElement = document.getElementById('playlistVideoCount');
    if (countElement) countElement.textContent = '0 videos';
}

function showErrorState(message) {
    const loadingElement = document.getElementById('loadingPlaylistVideos');
    const videosList = document.getElementById('playlistVideosList');
    
    if (loadingElement) loadingElement.style.display = 'none';
    if (videosList) {
        videosList.innerHTML = `
            <div class="alert alert-danger text-center">
                <i class="fas fa-exclamation-triangle"></i>
                <strong>Error:</strong> ${message}
                <br>
                <button class="btn btn-outline-danger btn-sm mt-2" onclick="loadPlaylistVideos()">
                    <i class="fas fa-retry"></i> Reintentar
                </button>
            </div>
        `;
    }
}

/**
 * Actualizar estadísticas de la playlist
 */
function updatePlaylistStats() {
    const videoCountElement = document.getElementById('videoCount');
    const totalDurationElement = document.getElementById('totalDuration');
    
    if (videoCountElement) {
        videoCountElement.textContent = playlistVideos.length;
    }
    
    if (totalDurationElement && playlistVideos.length > 0) {
        const totalSeconds = playlistVideos.reduce((total, video) => total + (video.duration || 0), 0);
        totalDurationElement.textContent = formatDuration(totalSeconds);
    } else if (totalDurationElement) {
        totalDurationElement.textContent = '--:--';
    }
}

// ==========================================
// FUNCIONES AUXILIARES
// ==========================================

function formatDuration(seconds) {
    if (!seconds) return '--:--';
    const hours = Math.floor(seconds / 3600);
    const minutes = Math.floor((seconds % 3600) / 60);
    const secs = Math.floor(seconds % 60);
    
    if (hours > 0) {
        return `${hours}:${minutes.toString().padStart(2, '0')}:${secs.toString().padStart(2, '0')}`;
    }
    return `${minutes}:${secs.toString().padStart(2, '0')}`;
}

function formatFileSize(bytes) {
    if (!bytes) return '';
    const units = ['B', 'KB', 'MB', 'GB'];
    let size = bytes;
    let unitIndex = 0;
    
    while (size >= 1024 && unitIndex < units.length - 1) {
        size /= 1024;
        unitIndex++;
    }
    
    return `${size.toFixed(1)} ${units[unitIndex]}`;
}

function getVideoStatus(video) {
    const now = new Date();
    const expiration = video.expiration_date ? new Date(video.expiration_date) : null;
    
    if (expiration && now > expiration) {
        return { class: 'bg-danger', text: 'Expirado' };
    }
    return { class: 'bg-success', text: 'Activo' };
}

function escapeHtml(text) {
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
}

function showToast(message, type = 'info') {
    // Implementación simple de toast - puedes mejorar con librerías como Toastify
    const toastContainer = document.getElementById('toastContainer') || (() => {
        const container = document.createElement('div');
        container.id = 'toastContainer';
        container.style.cssText = 'position: fixed; top: 20px; right: 20px; z-index: 9999;';
        document.body.appendChild(container);
        return container;
    })();
    
    const toast = document.createElement('div');
    toast.className = `alert alert-${type === 'error' ? 'danger' : type} alert-dismissible fade show`;
    toast.innerHTML = `
        ${message}
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    `;
    
    toastContainer.appendChild(toast);
    
    setTimeout(() => {
        toast.remove();
    }, 5000);
}

// ==========================================
// INICIALIZACIÓN
// ==========================================

document.addEventListener('DOMContentLoaded', function() {
    console.log('🎵 Inicializando vista de playlist');
    
    // Cargar videos si hay una playlist
    if (currentPlaylistData && currentPlaylistData.id) {
        loadPlaylistVideos();
    } else {
        showEmptyState();
    }
    
    // Configurar eventos adicionales si es necesario
    console.log('✅ Vista de playlist inicializada');
});

// Hacer funciones disponibles globalmente
window.loadPlaylistVideos = loadPlaylistVideos;
window.renderPlaylistVideos = renderPlaylistVideos;
window.playVideo = playVideo;
window.playNextVideo = playNextVideo;
window.playAllVideos = playAllVideos;
window.editPlaylist = editPlaylist;
window.refreshPlaylistVideos = refreshPlaylistVideos;
window.removeVideoFromPlaylist = removeVideoFromPlaylist;
window.sortPlaylistVideos = sortPlaylistVideos;
window.updatePlaylistStats = updatePlaylistStats;
</script>
{% endblock %}