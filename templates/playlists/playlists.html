{% extends "base.html" %}

{% block title %}Listas de Reproducción{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="/static/css/playlists.css">
<style>
/* Estilos específicos para la vista de playlists */
.playlist-card {
    transition: transform 0.2s ease, box-shadow 0.2s ease;
    border: 1px solid #dee2e6;
    margin-bottom: 1rem;
}

.playlist-card:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 15px rgba(0,0,0,0.1);
}

.playlist-thumbnail {
    width: 100px;
    height: 75px;
    object-fit: cover;
    border-radius: 8px;
}

.playlist-status-badge {
    font-size: 0.75rem;
    padding: 0.35em 0.65em;
}

.playlist-actions .btn {
    margin: 0 2px;
}

.video-count-badge {
    background: linear-gradient(45deg, #007bff, #0056b3);
    color: white;
    border-radius: 20px;
    padding: 4px 12px;
    font-size: 0.8rem;
    font-weight: 500;
}

.playlist-grid-view .playlist-item {
    border: 1px solid #dee2e6;
    border-radius: 12px;
    padding: 1rem;
    margin-bottom: 1rem;
    background: white;
    transition: all 0.3s ease;
}

.playlist-grid-view .playlist-item:hover {
    border-color: #007bff;
    box-shadow: 0 4px 20px rgba(0,123,255,0.15);
}

.view-toggle-buttons .btn {
    border-radius: 0;
}

.view-toggle-buttons .btn:first-child {
    border-top-left-radius: 0.375rem;
    border-bottom-left-radius: 0.375rem;
}

.view-toggle-buttons .btn:last-child {
    border-top-right-radius: 0.375rem;
    border-bottom-right-radius: 0.375rem;
}

@media (max-width: 768px) {
    .playlist-actions {
        flex-direction: column;
        gap: 0.5rem;
    }
    
    .playlist-actions .btn {
        font-size: 0.875rem;
        padding: 0.375rem 0.75rem;
    }
}

/* Toast notifications */
.toast-container {
    position: fixed;
    top: 20px;
    right: 20px;
    z-index: 9999;
}

.loading-overlay {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0, 0, 0, 0.5);
    display: flex;
    justify-content: center;
    align-items: center;
    z-index: 9998;
}
</style>
{% endblock %}

{% block content %}
<main class="container-fluid py-4">
    <!-- Toast Container -->
    <div class="toast-container" id="toastContainer"></div>
    
    <!-- Loading Overlay -->
    <div id="loadingOverlay" class="loading-overlay" style="display: none;">
        <div class="text-center text-white">
            <div class="spinner-border spinner-border-lg" role="status">
                <span class="visually-hidden">Cargando...</span>
            </div>
            <p class="mt-3">Cargando listas de reproducción...</p>
        </div>
    </div>

    <!-- Header y controles principales -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="d-flex flex-column flex-md-row justify-content-between align-items-start align-items-md-center mb-3">
                <div>
                    <h1 class="h3 mb-2 text-primary">
                        <i class="fas fa-list-alt me-2"></i>Mis Listas de Reproducción
                    </h1>
                    <p class="text-muted mb-0">Gestiona y organiza tus listas de reproducción</p>
                </div>
                <div class="d-flex flex-column flex-sm-row gap-2">
                    <a href="/ui/create_playlist" class="btn btn-primary">
                        <i class="fas fa-plus me-2"></i>Nueva Lista
                    </a>
                    <button class="btn btn-outline-secondary" onclick="refreshPlaylists()">
                        <i class="fas fa-sync-alt me-2"></i>Actualizar
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Controles de filtrado y búsqueda -->
    <div class="row mb-3">
        <div class="col-lg-4 col-md-6 mb-3 mb-lg-0">
            <div class="input-group">
                <span class="input-group-text"><i class="fas fa-search"></i></span>
                <input type="text" 
                       class="form-control" 
                       id="searchInput" 
                       placeholder="Buscar por título o descripción..."
                       autocomplete="off">
            </div>
        </div>
        <div class="col-lg-2 col-md-3 col-6">
            <select class="form-select" id="statusFilter">
                <option value="">Todos los estados</option>
                <option value="active">Solo activas</option>
                <option value="inactive">Solo inactivas</option>
                <option value="expired">Expiradas</option>
            </select>
        </div>
        <div class="col-lg-2 col-md-3 col-6">
            <select class="form-select" id="sortBy">
                <option value="creation_date_desc">Más recientes</option>
                <option value="creation_date_asc">Más antiguas</option>
                <option value="title_asc">Título A-Z</option>
                <option value="title_desc">Título Z-A</option>
                <option value="videos_desc">Más videos</option>
                <option value="videos_asc">Menos videos</option>
            </select>
        </div>
        <div class="col-lg-2 col-md-6 col-6">
            <select class="form-select" id="pageSize">
                <option value="12">12 por página</option>
                <option value="24" selected>24 por página</option>
                <option value="48">48 por página</option>
                <option value="all">Todas</option>
            </select>
        </div>
        <div class="col-lg-2 col-md-6 col-6">
            <div class="btn-group view-toggle-buttons w-100" role="group">
                <button type="button" class="btn btn-outline-secondary active" id="tableViewBtn" onclick="setView('table')">
                    <i class="fas fa-table"></i>
                </button>
                <button type="button" class="btn btn-outline-secondary" id="gridViewBtn" onclick="setView('grid')">
                    <i class="fas fa-th-large"></i>
                </button>
            </div>
        </div>
    </div>

    <!-- Estadísticas rápidas -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="d-flex flex-wrap justify-content-between align-items-center bg-light p-3 rounded">
                <div class="d-flex flex-wrap gap-3">
                    <span id="totalPlaylistsBadge" class="badge bg-primary fs-6">
                        <i class="fas fa-list me-1"></i>0 listas
                    </span>
                    <span id="activePlaylistsBadge" class="badge bg-success fs-6">
                        <i class="fas fa-check-circle me-1"></i>0 activas
                    </span>
                    <span id="expiredPlaylistsBadge" class="badge bg-danger fs-6">
                        <i class="fas fa-exclamation-triangle me-1"></i>0 expiradas
                    </span>
                    <span id="totalVideosBadge" class="badge bg-info fs-6">
                        <i class="fas fa-video me-1"></i>0 videos
                    </span>
                </div>
                <small class="text-muted mt-2 mt-sm-0" id="paginationInfo">
                    Mostrando 0 - 0 de 0 resultados
                </small>
            </div>
        </div>
    </div>

    <!-- Vista de tabla (por defecto) -->
    <div id="tableView" class="playlist-view">
        <div class="card shadow-sm">
            <div class="card-header bg-white">
                <div class="d-flex justify-content-between align-items-center">
                    <h5 class="mb-0 text-dark">
                        <i class="fas fa-table me-2 text-primary"></i>Vista de Tabla
                    </h5>
                    <!-- Paginación superior -->
                    <nav aria-label="Paginación de playlists">
                        <div class="d-flex align-items-center gap-2">
                            <button class="btn btn-sm btn-outline-secondary" id="firstPageBtn" onclick="goToPage(1)" title="Primera página">
                                <i class="fas fa-angle-double-left"></i>
                            </button>
                            <button class="btn btn-sm btn-outline-secondary" id="prevPageBtn" onclick="goToPrevPage()" title="Anterior">
                                <i class="fas fa-angle-left"></i>
                            </button>
                            <input type="number" id="pageInput" class="form-control form-control-sm text-center" 
                                   style="width: 60px;" min="1" value="1" onchange="goToPage(this.value)">
                            <span class="text-muted small">de <span id="totalPages">1</span></span>
                            <button class="btn btn-sm btn-outline-secondary" id="nextPageBtn" onclick="goToNextPage()" title="Siguiente">
                                <i class="fas fa-angle-right"></i>
                            </button>
                            <button class="btn btn-sm btn-outline-secondary" id="lastPageBtn" onclick="goToLastPage()" title="Última página">
                                <i class="fas fa-angle-double-right"></i>
                            </button>
                        </div>
                    </nav>
                </div>
            </div>
            
            <div class="table-responsive">
                <table class="table table-hover align-middle mb-0">
                    <thead class="table-light">
                        <tr>
                            <th scope="col" style="width: 30%">
                                <i class="fas fa-list me-1"></i>Lista de Reproducción
                            </th>
                            <th scope="col" style="width: 25%">
                                <i class="fas fa-info-circle me-1"></i>Descripción
                            </th>
                            <th scope="col" style="width: 15%">
                                <i class="fas fa-calendar me-1"></i>Creada
                            </th>
                            <th scope="col" style="width: 10%">
                                <i class="fas fa-video me-1"></i>Videos
                            </th>
                            <th scope="col" style="width: 10%">
                                <i class="fas fa-toggle-on me-1"></i>Estado
                            </th>
                            <th scope="col" style="width: 10%">
                                <i class="fas fa-cogs me-1"></i>Acciones
                            </th>
                        </tr>
                    </thead>
                    <tbody id="playlistsTableBody">
                        <!-- Los datos se cargarán dinámicamente -->
                        <tr>
                            <td colspan="6" class="text-center py-5">
                                <div class="spinner-border text-primary" role="status">
                                    <span class="visually-hidden">Cargando...</span>
                                </div>
                                <p class="mt-2 text-muted">Cargando listas de reproducción...</p>
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- Vista de tarjetas -->
    <div id="gridView" class="playlist-view" style="display: none;">
        <div class="row" id="playlistsGridContainer">
            <!-- Los datos se cargarán dinámicamente -->
        </div>
    </div>

    <!-- Paginación inferior -->
    <nav aria-label="Paginación inferior" class="mt-4">
        <div class="d-flex justify-content-between align-items-center">
            <div class="d-flex align-items-center gap-2">
                <button class="btn btn-outline-secondary" onclick="goToPage(1)">
                    <i class="fas fa-angle-double-left"></i> Primera
                </button>
                <button class="btn btn-outline-secondary" onclick="goToPrevPage()">
                    <i class="fas fa-angle-left"></i> Anterior
                </button>
            </div>
            <div class="d-flex align-items-center gap-2">
                <span class="text-muted" id="paginationInfoBottom">Página 1 de 1</span>
            </div>
            <div class="d-flex align-items-center gap-2">
                <button class="btn btn-outline-secondary" onclick="goToNextPage()">
                    Siguiente <i class="fas fa-angle-right"></i>
                </button>
                <button class="btn btn-outline-secondary" onclick="goToLastPage()">
                    Última <i class="fas fa-angle-double-right"></i>
                </button>
            </div>
        </div>
    </nav>
</main>

<!-- Scripts específicos para gestión de playlists -->
<script>
/**
 * SCRIPT PARA GESTIÓN DE PLAYLISTS - VISTA PRINCIPAL
 * Versión corregida con soporte HTTPS
 */

// ==========================================
// CONFIGURACIÓN GLOBAL
// ==========================================

// Variables globales
let playlists = [];
let filteredPlaylists = [];
let currentPage = 1;
let pageSize = 24;
let totalPages = 1;
let currentView = 'table';
let isLoading = false;

// Configuración de API con soporte HTTPS automático
const getApiUrl = () => {
    const protocol = window.location.protocol; // 'https:' o 'http:'
    const host = window.location.host;
    return `${protocol}//${host}/api`;
};

const API_ENDPOINTS = {
    playlists: `${getApiUrl()}/playlists`,
    playlistById: (id) => `${getApiUrl()}/playlists/${id}`,
    deletePlaylist: (id) => `${getApiUrl()}/playlists/${id}`
};

console.log('🔧 API Endpoints configurados:', API_ENDPOINTS);

// ==========================================
// INICIALIZACIÓN
// ==========================================

document.addEventListener('DOMContentLoaded', function() {
    console.log('📋 Inicializando gestión de playlists...');
    
    // Configurar event listeners
    setupEventListeners();
    
    // Cargar playlists iniciales
    loadPlaylists();
    
    console.log('✅ Sistema de playlists inicializado');
});

// ==========================================
// EVENT LISTENERS
// ==========================================

function setupEventListeners() {
    // Búsqueda
    const searchInput = document.getElementById('searchInput');
    if (searchInput) {
        searchInput.addEventListener('input', debounce(handleSearch, 300));
    }
    
    // Filtros
    const statusFilter = document.getElementById('statusFilter');
    if (statusFilter) {
        statusFilter.addEventListener('change', applyFilters);
    }
    
    const sortBy = document.getElementById('sortBy');
    if (sortBy) {
        sortBy.addEventListener('change', applyFilters);
    }
    
    const pageSizeSelect = document.getElementById('pageSize');
    if (pageSizeSelect) {
        pageSizeSelect.addEventListener('change', handlePageSizeChange);
    }
}

// ==========================================
// FUNCIONES DE CARGA DE DATOS
// ==========================================

async function loadPlaylists() {
    if (isLoading) return;
    
    console.log('📥 Cargando playlists...');
    setLoadingState(true);
    
    try {
        showToast('Cargando listas de reproducción...', 'info');
        
        const response = await fetch(API_ENDPOINTS.playlists);
        
        if (!response.ok) {
            throw new Error(`Error ${response.status}: No se pudieron cargar las playlists`);
        }
        
        const data = await response.json();
        playlists = Array.isArray(data) ? data : (data.playlists || []);
        
        console.log('✅ Playlists cargadas:', playlists.length);
        
        // Aplicar filtros y renderizar
        applyFilters();
        updateStatsBadges();
        
        showToast(`${playlists.length} listas cargadas correctamente`, 'success');
        
    } catch (error) {
        console.error('❌ Error cargando playlists:', error);
        showToast(`Error al cargar listas: ${error.message}`, 'error');
        showErrorState(error.message);
    } finally {
        setLoadingState(false);
    }
}

// ==========================================
// FUNCIONES DE FILTRADO Y BÚSQUEDA
// ==========================================

function handleSearch(event) {
    const searchTerm = event.target.value.toLowerCase().trim();
    console.log('🔍 Búsqueda:', searchTerm);
    applyFilters();
}

function applyFilters() {
    console.log('🔧 Aplicando filtros...');
    
    let filtered = [...playlists];
    
    // Filtro de búsqueda
    const searchTerm = document.getElementById('searchInput')?.value.toLowerCase().trim();
    if (searchTerm) {
        filtered = filtered.filter(playlist => 
            playlist.title.toLowerCase().includes(searchTerm) ||
            (playlist.description && playlist.description.toLowerCase().includes(searchTerm))
        );
    }
    
    // Filtro de estado
    const statusFilter = document.getElementById('statusFilter')?.value;
    if (statusFilter) {
        filtered = filtered.filter(playlist => {
            const isActive = isPlaylistActive(playlist);
            const isExpired = playlist.expiration_date && new Date(playlist.expiration_date) < new Date();
            
            switch (statusFilter) {
                case 'active': return isActive && !isExpired;
                case 'inactive': return !isActive;
                case 'expired': return isExpired;
                default: return true;
            }
        });
    }
    
    // Ordenamiento
    const sortBy = document.getElementById('sortBy')?.value || 'creation_date_desc';
    filtered = sortPlaylists(filtered, sortBy);
    
    filteredPlaylists = filtered;
    currentPage = 1;
    updatePagination();
    renderPlaylists();
    
    console.log(`✅ Filtros aplicados: ${filtered.length}/${playlists.length} playlists`);
}

function sortPlaylists(playlists, sortBy) {
    return playlists.sort((a, b) => {
        switch (sortBy) {
            case 'title_asc':
                return a.title.localeCompare(b.title);
            case 'title_desc':
                return b.title.localeCompare(a.title);
            case 'creation_date_asc':
                return new Date(a.creation_date) - new Date(b.creation_date);
            case 'creation_date_desc':
                return new Date(b.creation_date) - new Date(a.creation_date);
            case 'videos_asc':
                return (a.videos?.length || 0) - (b.videos?.length || 0);
            case 'videos_desc':
                return (b.videos?.length || 0) - (a.videos?.length || 0);
            default:
                return new Date(b.creation_date) - new Date(a.creation_date);
        }
    });
}

// ==========================================
// FUNCIONES DE RENDERIZADO
// ==========================================

function renderPlaylists() {
    if (currentView === 'table') {
        renderTableView();
    } else {
        renderGridView();
    }
    updatePaginationInfo();
}

function renderTableView() {
    const tbody = document.getElementById('playlistsTableBody');
    if (!tbody) return;
    
    const start = (currentPage - 1) * pageSize;
    const end = pageSize === 'all' ? filteredPlaylists.length : start + parseInt(pageSize);
    const pageData = filteredPlaylists.slice(start, end);
    
    if (pageData.length === 0) {
        tbody.innerHTML = `
            <tr>
                <td colspan="6" class="text-center py-5">
                    <div class="text-muted">
                        <i class="fas fa-inbox fa-3x mb-3"></i>
                        <p class="mb-0">No se encontraron listas de reproducción</p>
                        <small>Prueba ajustando los filtros de búsqueda</small>
                    </div>
                </td>
            </tr>
        `;
        return;
    }
    
    tbody.innerHTML = pageData.map(playlist => {
        const isActive = isPlaylistActive(playlist);
        const isExpired = playlist.expiration_date && new Date(playlist.expiration_date) < new Date();
        const videoCount = playlist.videos?.length || 0;
        
        return `
            <tr class="playlist-row" data-playlist-id="${playlist.id}">
                <td>
                    <div class="d-flex align-items-center">
                        <div class="playlist-thumbnail me-3">
                            <i class="fas fa-list-alt fa-2x text-primary"></i>
                        </div>
                        <div>
                            <h6 class="mb-1">${escapeHtml(playlist.title)}</h6>
                            <small class="text-muted">ID: ${playlist.id}</small>
                        </div>
                    </div>
                </td>
                <td>
                    <span class="text-muted">${playlist.description ? escapeHtml(playlist.description) : 'Sin descripción'}</span>
                </td>
                <td>
                    <small class="text-muted">${formatDate(playlist.creation_date)}</small>
                    ${playlist.expiration_date ? `<br><small class="text-${isExpired ? 'danger' : 'info'}">${isExpired ? 'Expiró' : 'Expira'}: ${formatDate(playlist.expiration_date)}</small>` : ''}
                </td>
                <td>
                    <span class="video-count-badge">${videoCount}</span>
                </td>
                <td>
                    <span class="badge ${isActive && !isExpired ? 'bg-success' : isExpired ? 'bg-danger' : 'bg-secondary'}">
                        ${isExpired ? 'Expirada' : isActive ? 'Activa' : 'Inactiva'}
                    </span>
                </td>
                <td>
                    <div class="playlist-actions d-flex gap-1">
                        <button class="btn btn-sm btn-primary" onclick="viewPlaylistDetail(${playlist.id})" title="Ver detalles">
                            <i class="fas fa-eye"></i>
                        </button>
                        <button class="btn btn-sm btn-outline-secondary" onclick="editPlaylist(${playlist.id})" title="Editar">
                            <i class="fas fa-edit"></i>
                        </button>
                        <button class="btn btn-sm btn-outline-danger" onclick="deletePlaylist(${playlist.id})" title="Eliminar">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                </td>
            </tr>
        `;
    }).join('');
}

function renderGridView() {
    const container = document.getElementById('playlistsGridContainer');
    if (!container) return;
    
    const start = (currentPage - 1) * pageSize;
    const end = pageSize === 'all' ? filteredPlaylists.length : start + parseInt(pageSize);
    const pageData = filteredPlaylists.slice(start, end);
    
    if (pageData.length === 0) {
        container.innerHTML = `
            <div class="col-12 text-center py-5">
                <div class="text-muted">
                    <i class="fas fa-inbox fa-3x mb-3"></i>
                    <p class="mb-0">No se encontraron listas de reproducción</p>
                    <small>Prueba ajustando los filtros de búsqueda</small>
                </div>
            </div>
        `;
        return;
    }
    
    container.innerHTML = pageData.map(playlist => {
        const isActive = isPlaylistActive(playlist);
        const isExpired = playlist.expiration_date && new Date(playlist.expiration_date) < new Date();
        const videoCount = playlist.videos?.length || 0;
        
        return `
            <div class="col-xl-3 col-lg-4 col-md-6 col-sm-12 mb-4">
                <div class="card playlist-card h-100">
                    <div class="card-header bg-primary text-white">
                        <h6 class="card-title mb-0">
                            <i class="fas fa-list-alt me-2"></i>
                            ${escapeHtml(playlist.title)}
                        </h6>
                    </div>
                    <div class="card-body">
                        <p class="card-text text-muted small">
                            ${playlist.description ? escapeHtml(playlist.description) : 'Sin descripción'}
                        </p>
                        <div class="d-flex justify-content-between align-items-center mb-2">
                            <span class="video-count-badge">${videoCount} videos</span>
                            <span class="badge ${isActive && !isExpired ? 'bg-success' : isExpired ? 'bg-danger' : 'bg-secondary'}">
                                ${isExpired ? 'Expirada' : isActive ? 'Activa' : 'Inactiva'}
                            </span>
                        </div>
                        <small class="text-muted">
                            Creada: ${formatDate(playlist.creation_date)}
                            ${playlist.expiration_date ? `<br><span class="text-${isExpired ? 'danger' : 'info'}">${isExpired ? 'Expiró' : 'Expira'}: ${formatDate(playlist.expiration_date)}</span>` : ''}
                        </small>
                    </div>
                    <div class="card-footer bg-transparent">
                        <div class="d-flex gap-1">
                            <button class="btn btn-sm btn-primary flex-fill" onclick="viewPlaylistDetail(${playlist.id})">
                                <i class="fas fa-eye me-1"></i>Ver
                            </button>
                            <button class="btn btn-sm btn-outline-secondary" onclick="editPlaylist(${playlist.id})" title="Editar">
                                <i class="fas fa-edit"></i>
                            </button>
                            <button class="btn btn-sm btn-outline-danger" onclick="deletePlaylist(${playlist.id})" title="Eliminar">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        `;
    }).join('');
}

// ==========================================
// FUNCIONES DE PAGINACIÓN
// ==========================================

function updatePagination() {
    if (pageSize === 'all') {
        totalPages = 1;
    } else {
        totalPages = Math.ceil(filteredPlaylists.length / parseInt(pageSize));
    }
    
    // Actualizar elementos de paginación
    const pageInput = document.getElementById('pageInput');
    const totalPagesSpan = document.getElementById('totalPages');
    
    if (pageInput) pageInput.value = currentPage;
    if (totalPagesSpan) totalPagesSpan.textContent = totalPages;
    
    // Habilitar/deshabilitar botones
    updatePaginationButtons();
}

function updatePaginationButtons() {
    const firstBtn = document.getElementById('firstPageBtn');
    const prevBtn = document.getElementById('prevPageBtn');
    const nextBtn = document.getElementById('nextPageBtn');
    const lastBtn = document.getElementById('lastPageBtn');
    
    const isFirstPage = currentPage <= 1;
    const isLastPage = currentPage >= totalPages;
    
    if (firstBtn) firstBtn.disabled = isFirstPage;
    if (prevBtn) prevBtn.disabled = isFirstPage;
    if (nextBtn) nextBtn.disabled = isLastPage;
    if (lastBtn) lastBtn.disabled = isLastPage;
}

function updatePaginationInfo() {
    const start = (currentPage - 1) * (pageSize === 'all' ? filteredPlaylists.length : parseInt(pageSize)) + 1;
    const end = Math.min(currentPage * (pageSize === 'all' ? filteredPlaylists.length : parseInt(pageSize)), filteredPlaylists.length);
    
    const infoText = filteredPlaylists.length > 0 
        ? `Mostrando ${start} - ${end} de ${filteredPlaylists.length} resultados`
        : 'No hay resultados para mostrar';
    
    const paginationInfo = document.getElementById('paginationInfo');
    const paginationInfoBottom = document.getElementById('paginationInfoBottom');
    
    if (paginationInfo) paginationInfo.textContent = infoText;
    if (paginationInfoBottom) paginationInfoBottom.textContent = `Página ${currentPage} de ${totalPages}`;
}

// ==========================================
// FUNCIONES DE NAVEGACIÓN
// ==========================================

function goToPage(page) {
    const pageNum = parseInt(page);
    if (pageNum >= 1 && pageNum <= totalPages) {
        currentPage = pageNum;
        renderPlaylists();
        updatePagination();
    }
}

function goToPrevPage() {
    if (currentPage > 1) {
        currentPage--;
        renderPlaylists();
        updatePagination();
    }
}

function goToNextPage() {
    if (currentPage < totalPages) {
        currentPage++;
        renderPlaylists();
        updatePagination();
    }
}

function goToLastPage() {
    currentPage = totalPages;
    renderPlaylists();
    updatePagination();
}

function handlePageSizeChange(event) {
    pageSize = event.target.value;
    currentPage = 1;
    updatePagination();
    renderPlaylists();
}

// ==========================================
// FUNCIONES DE VISTA
// ==========================================

function setView(view) {
    currentView = view;
    
    const tableView = document.getElementById('tableView');
    const gridView = document.getElementById('gridView');
    const tableBtn = document.getElementById('tableViewBtn');
    const gridBtn = document.getElementById('gridViewBtn');
    
    if (view === 'table') {
        tableView.style.display = 'block';
        gridView.style.display = 'none';
        tableBtn.classList.add('active');
        gridBtn.classList.remove('active');
    } else {
        tableView.style.display = 'none';
        gridView.style.display = 'block';
        tableBtn.classList.remove('active');
        gridBtn.classList.add('active');
    }
    
    renderPlaylists();
}

// ==========================================
// FUNCIONES DE ACCIÓN
// ==========================================

function viewPlaylistDetail(playlistId) {
    window.location.href = `/ui/playlist_detail?id=${playlistId}`;
}

function editPlaylist(playlistId) {
    window.location.href = `/ui/edit_playlist?id=${playlistId}`;
}

async function deletePlaylist(playlistId) {
    const playlist = playlists.find(p => p.id === playlistId);
    if (!playlist) return;
    
    const confirmMessage = `¿Estás seguro de que quieres eliminar la playlist "${playlist.title}"?\n\nEsta acción no se puede deshacer.`;
    
    if (!confirm(confirmMessage)) return;
    
    try {
        showToast('Eliminando playlist...', 'info');
        
        const response = await fetch(API_ENDPOINTS.deletePlaylist(playlistId), {
            method: 'DELETE'
        });
        
        if (!response.ok) {
            throw new Error(`Error ${response.status}: No se pudo eliminar la playlist`);
        }
        
        showToast('Playlist eliminada correctamente', 'success');
        
        // Recargar la lista
        await loadPlaylists();
        
    } catch (error) {
        console.error('❌ Error eliminando playlist:', error);
        showToast(`Error al eliminar playlist: ${error.message}`, 'error');
    }
}

function refreshPlaylists() {
    loadPlaylists();
}

// ==========================================
// FUNCIONES DE ESTADÍSTICAS
// ==========================================

function updateStatsBadges() {
    const totalBadge = document.getElementById('totalPlaylistsBadge');
    const activeBadge = document.getElementById('activePlaylistsBadge');
    const expiredBadge = document.getElementById('expiredPlaylistsBadge');
    const videosBadge = document.getElementById('totalVideosBadge');
    
    const totalPlaylists = playlists.length;
    const activePlaylists = playlists.filter(p => isPlaylistActive(p) && !isPlaylistExpired(p)).length;
    const expiredPlaylists = playlists.filter(p => isPlaylistExpired(p)).length;
    const totalVideos = playlists.reduce((sum, p) => sum + (p.videos?.length || 0), 0);
    
    if (totalBadge) totalBadge.innerHTML = `<i class="fas fa-list me-1"></i>${totalPlaylists} listas`;
    if (activeBadge) activeBadge.innerHTML = `<i class="fas fa-check-circle me-1"></i>${activePlaylists} activas`;
    if (expiredBadge) expiredBadge.innerHTML = `<i class="fas fa-exclamation-triangle me-1"></i>${expiredPlaylists} expiradas`;
    if (videosBadge) videosBadge.innerHTML = `<i class="fas fa-video me-1"></i>${totalVideos} videos`;
}

// ==========================================
// FUNCIONES UTILITARIAS
// ==========================================

function isPlaylistActive(playlist) {
    return playlist.is_active === true || playlist.is_active === 1;
}

function isPlaylistExpired(playlist) {
    return playlist.expiration_date && new Date(playlist.expiration_date) < new Date();
}

function formatDate(dateString) {
    if (!dateString) return 'N/A';
    const date = new Date(dateString);
    return date.toLocaleDateString('es-ES', {
        year: 'numeric',
        month: 'short',
        day: 'numeric'
    });
}

function escapeHtml(text) {
    const map = {
        '&': '&amp;',
        '<': '&lt;',
        '>': '&gt;',
        '"': '&quot;',
        "'": '&#039;'
    };
    return text.replace(/[&<>"']/g, m => map[m]);
}

function debounce(func, wait) {
    let timeout;
    return function executedFunction(...args) {
        const later = () => {
            clearTimeout(timeout);
            func(...args);
        };
        clearTimeout(timeout);
        timeout = setTimeout(later, wait);
    };
}

function setLoadingState(loading) {
    isLoading = loading;
    const overlay = document.getElementById('loadingOverlay');
    if (overlay) {
        overlay.style.display = loading ? 'flex' : 'none';
    }
}

function showErrorState(message) {
    const tbody = document.getElementById('playlistsTableBody');
    const container = document.getElementById('playlistsGridContainer');
    
    const errorHtml = `
        <div class="text-center py-5">
            <div class="text-danger">
                <i class="fas fa-exclamation-triangle fa-3x mb-3"></i>
                <h5>Error al cargar datos</h5>
                <p class="mb-3">${message}</p>
                <button class="btn btn-outline-primary" onclick="loadPlaylists()">
                    <i class="fas fa-sync-alt me-2"></i>Reintentar
                </button>
            </div>
        </div>
    `;
    
    if (currentView === 'table' && tbody) {
        tbody.innerHTML = `<tr><td colspan="6">${errorHtml}</td></tr>`;
    } else if (currentView === 'grid' && container) {
        container.innerHTML = `<div class="col-12">${errorHtml}</div>`;
    }
}

// ==========================================
// SISTEMA DE NOTIFICACIONES
// ==========================================

function showToast(message, type = 'info', duration = 3000) {
    const container = document.getElementById('toastContainer');
    if (!container) return;
    
    const toastId = 'toast-' + Date.now();
    const iconMap = {
        success: 'fas fa-check-circle',
        error: 'fas fa-exclamation-triangle',
        warning: 'fas fa-exclamation-circle',
        info: 'fas fa-info-circle'
    };
    
    const toast = document.createElement('div');
    toast.id = toastId;
    toast.className = `toast show align-items-center text-white bg-${type === 'error' ? 'danger' : type} border-0`;
    toast.setAttribute('role', 'alert');
    toast.innerHTML = `
        <div class="d-flex">
            <div class="toast-body">
                <i class="${iconMap[type] || iconMap.info} me-2"></i>
                ${message}
            </div>
            <button type="button" class="btn-close btn-close-white me-2 m-auto" onclick="closeToast('${toastId}')"></button>
        </div>
    `;
    
    container.appendChild(toast);
    
    setTimeout(() => closeToast(toastId), duration);
}

function closeToast(toastId) {
    const toast = document.getElementById(toastId);
    if (toast) {
        toast.remove();
    }
}

// ==========================================
// INICIALIZACIÓN AUTOMÁTICA
// ==========================================

console.log('✅ Script de gestión de playlists cargado correctamente');
</script>
{% endblock %}