{% extends "base.html" %}

{% block title %}Listas de Reproducción{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="/static/css/playlists.css">
<style>
/* Estilos específicos para la vista de playlists */
.playlist-card {
    transition: transform 0.2s ease, box-shadow 0.2s ease;
    border: 1px solid #dee2e6;
    margin-bottom: 1rem;
}

.playlist-card:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 15px rgba(0,0,0,0.1);
}

.playlist-thumbnail {
    width: 100px;
    height: 75px;
    object-fit: cover;
    border-radius: 8px;
}

.playlist-status-badge {
    font-size: 0.75rem;
    padding: 0.35em 0.65em;
}

.playlist-actions .btn {
    margin: 0 2px;
}

.video-count-badge {
    background: linear-gradient(45deg, #007bff, #0056b3);
    color: white;
    border-radius: 20px;
    padding: 4px 12px;
    font-size: 0.8rem;
    font-weight: 500;
}

.playlist-grid-view .playlist-item {
    border: 1px solid #dee2e6;
    border-radius: 12px;
    padding: 1rem;
    margin-bottom: 1rem;
    background: white;
    transition: all 0.3s ease;
}

.playlist-grid-view .playlist-item:hover {
    border-color: #007bff;
    box-shadow: 0 4px 20px rgba(0,123,255,0.15);
}

.view-toggle-buttons .btn {
    border-radius: 0;
}

.view-toggle-buttons .btn:first-child {
    border-top-left-radius: 0.375rem;
    border-bottom-left-radius: 0.375rem;
}

.view-toggle-buttons .btn:last-child {
    border-top-right-radius: 0.375rem;
    border-bottom-right-radius: 0.375rem;
}

@media (max-width: 768px) {
    .playlist-actions {
        flex-direction: column;
        gap: 0.5rem;
    }
    
    .playlist-actions .btn {
        font-size: 0.875rem;
        padding: 0.375rem 0.75rem;
    }
}
</style>
{% endblock %}

{% block content %}
<main class="container-fluid py-4">
    <!-- Header y botón crear nueva playlist -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="d-flex flex-column flex-md-row justify-content-between align-items-start align-items-md-center mb-3">
                <div>
                    <h1 class="h3 mb-2 text-primary">
                        <i class="fas fa-list-alt me-2"></i>Mis Listas de Reproducción
                    </h1>
                    <p class="text-muted mb-0">Gestiona y organiza tus listas de reproducción</p>
                </div>
                <div class="d-flex gap-2 mt-3 mt-md-0">
                    <button type="button" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#createPlaylistModal">
                        <i class="fas fa-plus-circle me-1"></i>
                        <span class="d-none d-sm-inline">Nueva Lista</span>
                        <span class="d-sm-none">Nueva</span>
                    </button>
                    <button type="button" class="btn btn-outline-secondary" onclick="loadPlaylists()">
                        <i class="fas fa-sync-alt me-1"></i>
                        <span class="d-none d-sm-inline">Actualizar</span>
                        <span class="d-sm-none"><i class="fas fa-sync-alt"></i></span>
                    </button>
                </div>
            </div>
            
            <!-- Filtros y búsqueda -->
            <div class="card mb-4">
                <div class="card-body p-3">
                    <div class="row g-3">
                        <div class="col-md-4">
                            <div class="input-group">
                                <span class="input-group-text">
                                    <i class="fas fa-search"></i>
                                </span>
                                <input type="text" class="form-control" id="playlistSearchInput" 
                                    placeholder="Buscar playlists..." aria-label="Buscar playlists">
                                <button class="btn btn-outline-secondary" type="button" id="clearSearchBtn">
                                    <i class="fas fa-times"></i>
                                </button>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <select class="form-select" id="playlistFilterStatus" aria-label="Filtrar por estado">
                                <option value="all" selected>Todos los estados</option>
                                <option value="active">Activas</option>
                                <option value="inactive">Inactivas</option>
                                <option value="expired">Expiradas</option>
                            </select>
                        </div>
                        <div class="col-md-3">
                            <select class="form-select" id="playlistSortBy" aria-label="Ordenar por">
                                <option value="title-asc" selected>Título (A-Z)</option>
                                <option value="title-desc">Título (Z-A)</option>
                                <option value="created-desc">Más recientes</option>
                                <option value="created-asc">Más antiguas</option>
                                <option value="videos-desc">Más videos</option>
                                <option value="videos-asc">Menos videos</option>
                            </select>
                        </div>
                        <div class="col-md-2">
                            <div class="view-toggle-buttons btn-group w-100">
                                <button type="button" class="btn btn-outline-secondary active" id="tableViewBtn">
                                    <i class="fas fa-list"></i>
                                </button>
                                <button type="button" class="btn btn-outline-secondary" id="gridViewBtn">
                                    <i class="fas fa-th-large"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Paginación superior -->
    <div class="d-flex justify-content-between align-items-center mb-3">
        <div class="d-flex gap-1">
            <button class="btn btn-sm btn-outline-secondary" id="prevPageBtn">
                <i class="fas fa-chevron-left"></i>
            </button>
            <span class="btn btn-sm btn-outline-secondary disabled">
                Página <span id="currentPageDisplay">1</span> de <span id="totalPagesDisplay">1</span>
            </span>
            <button class="btn btn-sm btn-outline-secondary" id="nextPageBtn">
                <i class="fas fa-chevron-right"></i>
            </button>
        </div>
        <div class="d-flex align-items-center">
            <select class="form-select form-select-sm me-2" id="pageSizeSelect">
                <option value="12">12 por página</option>
                <option value="24" selected>24 por página</option>
                <option value="48">48 por página</option>
                <option value="all">Ver todas</option>
            </select>
        </div>
        <div class="d-flex align-items-start">
            <small class="text-muted" id="playlistPaginationInfo">
                Mostrando 0 - 0 de 0 resultados
            </small>
        </div>
    </div>

    <!-- Contenedor de playlists (Vista de tabla o grid) -->
    <div id="playlistsContainer" class="mb-4">
        <!-- Vista de tabla (default) -->
        <div id="tableView">
            <div class="card">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5 class="mb-0">
                        <i class="fas fa-list me-2"></i>Listas de Reproducción
                    </h5>
                </div>
                <div class="table-responsive">
                    <table class="table table-hover align-middle">
                        <thead>
                            <tr>
                                <th scope="col" style="width: 25%">Título</th>
                                <th scope="col" style="width: 20%">Descripción</th>
                                <th scope="col" style="width: 15%">Fecha de Creación</th>
                                <th scope="col" style="width: 15%">Expiración</th>
                                <th scope="col" style="width: 10%">Estado</th>
                                <th scope="col" style="width: 15%">Acciones</th>
                            </tr>
                        </thead>
                        <tbody id="playlistsList">
                            <tr>
                                <td colspan="7" class="text-center py-3" id="playlistsLoading">
                                    <div class="spinner-border text-primary" role="status">
                                        <span class="visually-hidden">Cargando...</span>
                                    </div>
                                    <p class="mt-2">Cargando listas de reproducción...</p>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
        
        <!-- Vista de grid (inicialmente oculta) -->
        <div id="gridView" class="playlist-grid-view row g-3" style="display: none;">
            <div class="col-12 text-center py-3" id="playlistsGridLoading">
                <div class="spinner-border text-primary" role="status">
                    <span class="visually-hidden">Cargando...</span>
                </div>
                <p class="mt-2">Cargando listas de reproducción...</p>
            </div>
        </div>
    </div>
    
    <!-- Paginación inferior -->
    <div class="d-flex justify-content-between align-items-center mb-3">
        <div class="d-flex gap-1">
            <button class="btn btn-sm btn-outline-secondary" onclick="goToFirstPage()">
                <i class="fas fa-angle-double-left"></i>
            </button>
            <button class="btn btn-sm btn-outline-secondary" onclick="goToPrevPage()">
                <i class="fas fa-angle-left"></i>
            </button>
            <div class="input-group input-group-sm" style="width: 100px;">
                <input type="number" class="form-control" id="pageNumberInput" min="1" value="1">
                <span class="input-group-text">/ <span id="totalPagesLabel">1</span></span>
            </div>
            <button class="btn btn-sm btn-outline-secondary" onclick="goToNextPage()">
                <i class="fas fa-angle-right"></i>
            </button>
            <button class="btn btn-sm btn-outline-secondary" onclick="goToLastPage()">
                <i class="fas fa-angle-double-right"></i>
            </button>
        </div>
        <div>
            <small class="text-muted" id="playlistSummary">
                Total: 0 listas
            </small>
        </div>
    </div>
</main>

<!-- Modal para crear nueva playlist -->
<div class="modal fade" id="createPlaylistModal" tabindex="-1" aria-labelledby="createPlaylistModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="createPlaylistModalLabel">Crear Nueva Lista de Reproducción</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="createPlaylistForm">
                    <div class="mb-3">
                        <label for="createPlaylistTitle" class="form-label">Título *</label>
                        <input type="text" class="form-control" id="createPlaylistTitle" name="title" required>
                    </div>
                    <div class="mb-3">
                        <label for="createPlaylistDescription" class="form-label">Descripción</label>
                        <textarea class="form-control" id="createPlaylistDescription" name="description" rows="3"></textarea>
                    </div>
                    <div class="mb-3">
                        <label for="createPlaylistExpiration" class="form-label">Fecha de Expiración</label>
                        <input type="date" class="form-control" id="createPlaylistExpiration" name="expiration_date">
                    </div>
                    <div class="mb-3 form-check">
                        <input type="checkbox" class="form-check-input" id="createPlaylistActive" name="is_active" checked>
                        <label class="form-check-label" for="createPlaylistActive">Activa</label>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                <button type="button" class="btn btn-primary" id="saveNewPlaylistBtn">Crear Lista</button>
            </div>
        </div>
    </div>
</div>

<!-- Modal para editar playlist -->
<div class="modal fade" id="editPlaylistModal" tabindex="-1" aria-labelledby="editPlaylistModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="editPlaylistModalLabel">Editar Lista de Reproducción</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="editPlaylistForm">
                    <input type="hidden" id="editPlaylistId" name="id">
                    <div class="mb-3">
                        <label for="editPlaylistTitle" class="form-label">Título *</label>
                        <input type="text" class="form-control" id="editPlaylistTitle" name="title" required>
                    </div>
                    <div class="mb-3">
                        <label for="editPlaylistDescription" class="form-label">Descripción</label>
                        <textarea class="form-control" id="editPlaylistDescription" name="description" rows="3"></textarea>
                    </div>
                    <div class="mb-3">
                        <label for="editPlaylistExpiration" class="form-label">Fecha de Expiración</label>
                        <input type="date" class="form-control" id="editPlaylistExpiration" name="expiration_date">
                    </div>
                    <div class="mb-3 form-check">
                        <input type="checkbox" class="form-check-input" id="editPlaylistActive" name="is_active">
                        <label class="form-check-label" for="editPlaylistActive">Activa</label>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                <button type="button" class="btn btn-primary" id="updatePlaylistBtn">Guardar Cambios</button>
            </div>
        </div>
    </div>
</div>

<!-- Modal de confirmación para eliminar playlist -->
<div class="modal fade" id="deletePlaylistModal" tabindex="-1" aria-labelledby="deletePlaylistModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header bg-danger text-white">
                <h5 class="modal-title" id="deletePlaylistModalLabel">
                    <i class="fas fa-exclamation-triangle me-2"></i>Eliminar Lista
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <p>¿Estás seguro de que deseas eliminar la lista de reproducción <strong id="deletePlaylistName"></strong>?</p>
                <p class="text-danger">Esta acción no se puede deshacer.</p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                <button type="button" class="btn btn-danger" id="confirmDeletePlaylistBtn">Eliminar</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_scripts %}
<!-- Primero cargar el script de corrección de URLs seguras -->
<script src="/static/js/playlist-fix.js"></script>

<script>
    // Variables de estado
    let allPlaylists = [];
    let filteredPlaylists = [];
    let currentPlaylistPage = 1;
    let playlistPageSize = 24;
    let totalPlaylistPages = 1;
    let currentPlaylistFilter = 'all';
    let currentPlaylistSearchTerm = '';
    let playlistSortField = '';
    let playlistSortDirection = 'asc';

    // Hacer variables compatibles con main.js
    window.allPlaylists = allPlaylists;
    window.currentPlaylistPage = currentPlaylistPage;

    // Inicializar cuando el DOM esté listo
    document.addEventListener('DOMContentLoaded', function() {
        console.log('Playlist template - Inicializando...');
        
        // Esperar a main.js si está disponible
        setTimeout(() => {
            // Si loadPlaylistsSecurely está disponible, usarlo
            if (typeof window.loadPlaylistsSecurely === 'function') {
                console.log('Usando loadPlaylistsSecurely del script de corrección');
                loadPlaylistsSecurely();
            } 
            // Si loadPlaylists de main.js está disponible, usarlo
            else if (typeof window.loadPlaylists === 'function') {
                console.log('Usando loadPlaylists de main.js');
                window.loadPlaylists();
            } 
            // Si no, usar el local
            else {
                console.log('Usando loadPlaylists local');
                loadPlaylists();
            }
            
            setupEventListeners();
        }, 200);
    });

    // Cargar listas de reproducción usando URLs relativas
    async function loadPlaylists() {
        console.log('Cargando playlists...');
        
        try {
            const response = await fetch('/api/playlists/?limit=10000');
            if (!response.ok) throw new Error('Error al cargar las playlists');
            
            allPlaylists = await response.json();
            window.allPlaylists = allPlaylists;
            
            console.log(`Playlists cargadas: ${allPlaylists.length}`);
            filterAndDisplayPlaylists();
        } catch (error) {
            console.error('Error:', error);
            const playlistsList = document.getElementById('playlistsList');
            if (playlistsList) {
                playlistsList.innerHTML = `
                    <tr>
                        <td colspan="7" class="text-center text-danger">
                            <i class="fas fa-exclamation-triangle me-2"></i>
                            Error al cargar las listas de reproducción
                        </td>
                    </tr>
                `;
            }
        }
    }

    // Filtrar y mostrar playlists
    function filterAndDisplayPlaylists() {
        // Implementar lógica de filtrado y visualización
        console.log('Filtrando y mostrando playlists...');
        
        // Simple implementación de ejemplo
        const playlistsList = document.getElementById('playlistsList');
        if (!playlistsList) return;
        
        if (!allPlaylists || allPlaylists.length === 0) {
            playlistsList.innerHTML = `
                <tr>
                    <td colspan="7" class="text-center py-4">
                        <div class="alert alert-info">
                            <i class="fas fa-info-circle me-2"></i>
                            No hay listas de reproducción disponibles
                        </div>
                    </td>
                </tr>
            `;
            return;
        }
        
        // Aquí iría el código completo de filtrado y paginación
        // Pero para simplificar, solo mostramos todas las playlists
        
        let html = '';
        allPlaylists.forEach(playlist => {
            const createdDate = new Date(playlist.created_at).toLocaleDateString();
            const expirationDate = playlist.expiration_date ? new Date(playlist.expiration_date).toLocaleDateString() : 'Sin expiración';
            const isActive = playlist.is_active;
            
            html += `
                <tr>
                    <td>${playlist.title}</td>
                    <td>${playlist.description || '<span class="text-muted">Sin descripción</span>'}</td>
                    <td>${createdDate}</td>
                    <td>${expirationDate}</td>
                    <td>
                        <span class="badge ${isActive ? 'bg-success' : 'bg-danger'}">${isActive ? 'Activa' : 'Inactiva'}</span>
                    </td>
                    <td>
                        <div class="btn-group btn-group-sm">
                            <button class="btn btn-outline-primary" onclick="viewPlaylist(${playlist.id})">
                                <i class="fas fa-eye"></i>
                            </button>
                            <button class="btn btn-outline-secondary" onclick="editPlaylist(${playlist.id})">
                                <i class="fas fa-edit"></i>
                            </button>
                            <button class="btn btn-outline-danger" onclick="deletePlaylist(${playlist.id}, '${playlist.title}')">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    </td>
                </tr>
            `;
        });
        
        playlistsList.innerHTML = html;
    }

    // Configurar event listeners para interacciones de UI
    function setupEventListeners() {
        // Implementar configuración de event listeners
        console.log('Configurando event listeners...');
    }

    // Funciones para manejar acciones de playlist
    function viewPlaylist(id) {
        window.location.href = `/ui/playlists/detail?id=${id}`;
    }
    
    function editPlaylist(id) {
        // Implementar edición
        console.log('Editar playlist:', id);
    }
    
    function deletePlaylist(id, title) {
        // Implementar eliminación
        console.log('Eliminar playlist:', id, title);
    }
</script>
{% endblock %}