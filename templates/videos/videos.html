{% extends "base.html" %}

{% block content %}
    <div class="container-fluid px-3 py-4" style="max-width: auto; width: auto;">  
        <!-- Formulario de subida de videos -->
        <div class="row mb-4">
            <div class="col-md-12">
                <div class="card">
                    <div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pb-2 mb-3 border-bottom">
                        <h1 class="h2">
                            <i class="fas fa-film text-primary"></i>
                            Gestión Videos
                        </h1>
                        <button type="button" class="btn btn-primary" data-bs-toggle="collapse" data-bs-target="#uploadForm">
                            <i class="fas fa-plus"></i> Mostrar/Ocultar
                        </button>
                    </div>
                    <div id="uploadForm" class="collapse">
                        <div class="card-body">
                            <form id="videoUploadForm">
                                <div class="mb-3">
                                    <label for="videoTitle" class="form-label">Título</label>
                                    <input type="text" class="form-control" id="videoTitle" name="title" required>
                                </div>
                                <div class="mb-3">
                                    <label for="videoDescription" class="form-label">Descripción</label>
                                    <textarea class="form-control" id="videoDescription" name="description" rows="3"></textarea>
                                </div>
                                <div class="mb-3">
                                    <label for="videoExpiration" class="form-label">Fecha de Expiración (opcional)</label>
                                    <input type="datetime-local" class="form-control" id="videoExpiration" name="expiration_date">
                                </div>
                                <div class="mb-3">
                                    <label for="videoFile" class="form-label">Archivo de Video</label>
                                    <input type="file" class="form-control" id="videoFile" name="file" accept="video/*" required>
                                </div>
                                <div class="mb-3">
                                    <div class="progress d-none" id="uploadProgress" style="height: 25px;">
                                        <div class="progress-bar" role="progressbar" style="width: 0%; font-size: 1rem;" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100">0%</div>
                                    </div>
                                </div>
                                <button type="submit" class="btn btn-primary btn-lg">Subir Video</button>
                            </form>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Controles de búsqueda y filtros -->
        <div class="row mb-3">
            <div class="col-md-6">
                <div class="input-group">
                    <input type="text" id="videoSearchInput" class="form-control" placeholder="Buscar videos por título o descripción...">
                    <button class="btn btn-outline-primary" type="button" id="clearVideoSearch">
                        <i class="fas fa-times"></i> Limpiar
                    </button>
                </div>
            </div>
            <div class="col-md-3">
                <select class="form-select" id="videoFilterExpiration">
                    <option value="all">Todos los videos</option>
                    <option value="active">Videos activos</option>
                    <option value="expired">Videos expirados</option>
                </select>
            </div>
            <div class="col-md-3">
                <select class="form-select" id="videoPageSizeSelect">
                    <option value="25" selected>25 por página</option>
                    <option value="50">50 por página</option>
                    <option value="100">100 por página</option>
                    <option value="200">200 por página</option>
                    <option value="500">Todos los videos</option>
                </select>
            </div>
        </div>

        <!-- Información de resultados y paginación superior -->
        <div class="row mb-2">
            <div class="col-md-6">
                <span id="videoCountBadge" class="badge bg-info fs-6">0 videos</span>
            </div>
            <div class="col-md-6 text-end">
                <small class="text-muted" id="videoPaginationInfo">
                    Mostrando 0 - 0 de 0 resultados
                </small>
            </div>
        </div>

        <!-- Tabla de videos con paginación -->
        <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5 class="mb-0">
                    <i class="fas fa-video me-2"></i>Biblioteca de Videos
                </h5>
                <div class="d-flex align-items-center">
                    <button class="btn btn-sm btn-outline-secondary me-2" 
                            id="firstVideoPageBtn" 
                            onclick="goToFirstVideoPage()" 
                            title="Primera página">
                        <i class="fas fa-angle-double-left"></i>
                    </button>
                    <button class="btn btn-sm btn-outline-secondary me-2" 
                            id="prevVideoPageBtn" 
                            onclick="goToPrevVideoPage()" 
                            title="Página anterior">
                        <i class="fas fa-angle-left"></i>
                    </button>
                    <span class="me-2">Página</span>
                    <input type="number" 
                           id="videoPageInput" 
                           class="form-control form-control-sm me-2" 
                           style="width: 70px;" 
                           min="1" 
                           value="1"
                           onchange="goToVideoPage(this.value)">
                    <button class="btn btn-sm btn-outline-secondary me-2" 
                            id="nextVideoPageBtn" 
                            onclick="goToNextVideoPage()" 
                            title="Página siguiente">
                        <i class="fas fa-angle-right"></i>
                    </button>
                    <button class="btn btn-sm btn-outline-secondary" 
                            id="lastVideoPageBtn" 
                            onclick="goToLastVideoPage()" 
                            title="Última página">
                        <i class="fas fa-angle-double-right"></i>
                    </button>
                    <small class="text-muted ms-2">de <span id="totalVideoPages">1</span></small>
                </div>
            </div>
            <div class="card-body p-0">
                <div class="table-responsive" style="min-height: 300px;">
                    <table class="table table-striped table-hover mb-0" id="videosTable">
                        <thead class="table-dark">
                            <tr>
                                <th>
                                    <button class="btn btn-link text-white text-decoration-none p-0" 
                                            onclick="sortVideoTable('title')" 
                                            title="Ordenar por título">
                                        Título <i class="fas fa-sort ms-1"></i>
                                    </button>
                                </th>
                                <th>Descripción</th>
                                <th>
                                    <button class="btn btn-link text-white text-decoration-none p-0" 
                                            onclick="sortVideoTable('upload_date')" 
                                            title="Ordenar por fecha de subida">
                                        Subida <i class="fas fa-sort ms-1"></i>
                                    </button>
                                </th>
                                <th>
                                    <button class="btn btn-link text-white text-decoration-none p-0" 
                                            onclick="sortVideoTable('expiration_date')" 
                                            title="Ordenar por fecha de expiración">
                                        Expiración <i class="fas fa-sort ms-1"></i>
                                    </button>
                                </th>
                                <th>Estado</th>
                                <th>Acciones</th>
                            </tr>
                        </thead>
                        <tbody id="videosList">
                            <tr>
                                <td colspan="6" class="text-center py-3" id="videosLoading">
                                    <div class="spinner-border text-primary" role="status">
                                        <span class="visually-hidden">Cargando...</span>
                                    </div>
                                    <p class="mt-2">Cargando videos...</p>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
            <div class="card-footer">
                <div class="d-flex justify-content-between align-items-center">
                    <small class="text-muted" id="videoPaginationFooter">
                        Página 1 de 1 <span class="text-primary">(0-0 de 0)</span>
                    </small>
                    <div>
                        <button class="btn btn-sm btn-outline-secondary me-1" onclick="goToFirstVideoPage()">
                            <i class="fas fa-angle-double-left"></i>
                        </button>
                        <button class="btn btn-sm btn-outline-secondary me-1" onclick="goToPrevVideoPage()">
                            <i class="fas fa-angle-left"></i>
                        </button>
                        <button class="btn btn-sm btn-outline-secondary me-1" onclick="goToNextVideoPage()">
                            <i class="fas fa-angle-right"></i>
                        </button>
                        <button class="btn btn-sm btn-outline-secondary" onclick="goToLastVideoPage()">
                            <i class="fas fa-angle-double-right"></i>
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal para editar video -->
    <div class="modal fade" id="editVideoModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Editar Video</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form id="editVideoForm">
                        <input type="hidden" id="editVideoId">
                        <div class="mb-3">
                            <label for="editVideoTitle" class="form-label">Título</label>
                            <input type="text" class="form-control" id="editVideoTitle" required>
                        </div>
                        <div class="mb-3">
                            <label for="editVideoDescription" class="form-label">Descripción</label>
                            <textarea class="form-control" id="editVideoDescription" rows="3"></textarea>
                        </div>
                        <div class="mb-3">
                            <label for="editVideoExpiration" class="form-label">Fecha de Expiración (opcional)</label>
                            <input type="datetime-local" class="form-control" id="editVideoExpiration">
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary btn-lg" data-bs-dismiss="modal">Cancelar</button>
                    <button type="button" class="btn btn-primary btn-lg" id="saveVideoChangesBtn">Guardar Cambios</button>
                </div>
            </div>
        </div>
    </div>

<!-- Modal para reproducir video (optimizado) -->
<div class="modal fade" id="playVideoModal" tabindex="-1" aria-labelledby="playVideoModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="playVideoModalLabel">Reproduciendo video</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body p-0">
                <div class="ratio ratio-16x9">
                    <video id="videoPlayer" class="w-100" controls autoplay controlsList="nodownload">
                        <source src="" type="video/mp4" id="videoSource">
                        Tu navegador no soporta la reproducción de videos HTML5.
                    </video>
                </div>
                <div class="bg-light p-3">
                    <div class="d-flex justify-content-center align-items-center">
                        <div class="btn-group" role="group" aria-label="Controles de velocidad">
                            <button class="btn btn-sm btn-outline-secondary" onclick="document.getElementById('videoPlayer').playbackRate = 0.5;">
                                <i class="fas fa-backward"></i> 0.5x
                            </button>
                            <button class="btn btn-sm btn-outline-secondary" onclick="document.getElementById('videoPlayer').playbackRate = 1;">
                                <i class="fas fa-sync"></i> 1x
                            </button>
                            <button class="btn btn-sm btn-outline-secondary" onclick="document.getElementById('videoPlayer').playbackRate = 1.5;">
                                <i class="fas fa-forward"></i> 1.5x
                            </button>
                            <button class="btn btn-sm btn-outline-secondary" onclick="document.getElementById('videoPlayer').playbackRate = 2;">
                                <i class="fas fa-fast-forward"></i> 2x
                            </button>
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer d-flex justify-content-between">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                    <i class="fas fa-times me-1"></i>Cerrar
                </button>
                <a id="downloadVideoBtn" href="#" class="btn btn-primary" download>
                    <i class="fas fa-download me-1"></i>Descargar Video
                </a>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_scripts %}
    <style>
        .table th button {
            border: none !important;
            background: none !important;
            font-weight: bold !important;
            color: inherit !important;
        }
        .table th button:hover {
            background-color: rgba(255, 255, 255, 0.1) !important;
            color: inherit !important;
        }
        .table th button:focus {
            box-shadow: none !important;
            color: inherit !important;
        }
        .table-warning {
            --bs-table-bg: #fff3cd;
        }
    </style>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.0/js/bootstrap.bundle.min.js"></script>
    <script src="/static/js/main.js"></script>
    
    <script>
        // Función para reproducir video
// Función optimizada para reproducir video
function playVideo(videoId) {
    // Validar que recibimos un ID válido
    if (!videoId) {
        console.error('Error: No se proporcionó un ID de video válido');
        return;
    }
    
    try {
        // Construir la URL de descarga correcta
        const videoUrl = `/api/videos/${videoId}/download`;
        console.log(`Reproduciendo video ID ${videoId}, URL: ${videoUrl}`);
        
        // Establecer la URL del video
        const videoSource = document.getElementById('videoSource');
        if (videoSource) {
            videoSource.src = videoUrl;
        }
        
        // Establecer la URL de descarga
        const downloadBtn = document.getElementById('downloadVideoBtn');
        if (downloadBtn) {
            downloadBtn.href = videoUrl;
        }
        
        // Recargar el elemento de video para aplicar la nueva fuente
        const videoPlayer = document.getElementById('videoPlayer');
        if (videoPlayer) {
            videoPlayer.load();
        }
        
        // Abrir el modal
        const modal = new bootstrap.Modal(document.getElementById('playVideoModal'));
        modal.show();
    } catch (error) {
        console.error('Error al reproducir video:', error);
        alert('No se pudo reproducir el video. Por favor, inténtelo de nuevo.');
    }
}

// Función optimizada para limpiar el reproductor cuando se cierra el modal
function setupVideoModalEvents() {
    const videoModal = document.getElementById('playVideoModal');
    if (!videoModal) return;
    
    videoModal.addEventListener('hidden.bs.modal', function() {
        const videoPlayer = document.getElementById('videoPlayer');
        if (videoPlayer) {
            videoPlayer.pause();
            videoPlayer.currentTime = 0;
            // Limpiar la fuente para evitar que se siga descargando en segundo plano
            document.getElementById('videoSource').src = '';
            videoPlayer.load();
        }
    });
}
        // Función para obtener información adicional del video
        async function fetchVideoInfo(videoId) {
            try {
                console.log(`Obteniendo información del video ID: ${videoId}`);
                
                // Verificar primero si el video existe y está disponible para descarga
                const headResponse = await fetch(`/api/videos/${videoId}/download`, {
                    method: 'HEAD'
                });
                
                if (!headResponse.ok) {
                    console.warn(`El video ID ${videoId} no está disponible para descarga (${headResponse.status})`);
                } else {
                    console.log(`Video ID ${videoId} disponible para descarga`);
                }
                
                // Obtener información detallada del video
                const infoResponse = await fetch(`/api/videos/${videoId}/info`);
                if (!infoResponse.ok) {
                    throw new Error(`No se pudo obtener información del video (${infoResponse.status})`);
                }
                
                const videoData = await infoResponse.json();
                console.log('Datos del video:', videoData);
                
                // Actualizar duración
                if (videoData.duration || videoData.formatted_duration) {
                    const durationElement = document.getElementById('videoDurationValue');
                    if (durationElement) {
                        durationElement.textContent = videoData.formatted_duration || formatDuration(videoData.duration);
                    }
                }
                
                // Actualizar tamaño
                if (videoData.file_size || videoData.formatted_file_size) {
                    const sizeElement = document.getElementById('videoSizeValue');
                    if (sizeElement) {
                        sizeElement.textContent = videoData.formatted_file_size || formatFileSize(videoData.file_size);
                    }
                }
                
                // Actualizar descripción si no se proporcionó al abrir el modal
                const descElement = document.getElementById('playingVideoDescription');
                if (descElement && descElement.textContent === 'Sin descripción' && videoData.description) {
                    descElement.textContent = videoData.description;
                }
                
                // Actualizar nombre del archivo (obtenido desde la info)
                const fileName = videoData.file_name || 
                                (videoData.file_path ? videoData.file_path.split('/').pop() : 'video.mp4');
                
                // Actualizar botón de descarga con el nombre de archivo correcto
                const downloadBtn = document.getElementById('downloadVideoBtn');
                if (downloadBtn) {
                    // Usar el título si está disponible, o el nombre del archivo como respaldo
                    downloadBtn.download = videoData.title || fileName;
                }
                
                return videoData;
                
            } catch (error) {
                console.error('Error al obtener información del video:', error);
                // Mostrar un mensaje al usuario
                const errorElement = document.createElement('div');
                errorElement.className = 'alert alert-danger mt-3';
                errorElement.innerHTML = `
                    <i class="fas fa-exclamation-triangle me-2"></i>
                    <strong>Error al cargar información del video:</strong> ${error.message}
                `;
                
                // Añadir el mensaje de error al modal si es posible
                const modalBody = document.querySelector('#playVideoModal .modal-body');
                if (modalBody) {
                    modalBody.appendChild(errorElement);
                }
                
                return null;
            }
        }
        // Función para formatear el tamaño del archivo
        function formatFileSize(bytes) {
            if (!bytes) return '-- MB';
            
            const units = ['B', 'KB', 'MB', 'GB'];
            let size = bytes;
            let unitIndex = 0;
            
            while (size >= 1024 && unitIndex < units.length - 1) {
                size /= 1024;
                unitIndex++;
            }
            
            return `${size.toFixed(2)} ${units[unitIndex]}`;
        }

        // SOLUCIÓN CORREGIDA: Función para añadir botones de reproducción
        // Evita duplicaciones verificando si ya existe un botón de reproducción
 function addPlayButtonsToVideoTable() {
    // Evitar procesamiento duplicado
    if (window.isAddingPlayButtons) return;
    window.isAddingPlayButtons = true;
    
    try {
        console.log('Añadiendo botones de reproducción...');
        
        // Seleccionar todas las filas que contienen datos de videos
        const videoRows = document.querySelectorAll('#videosList tr:not(:has(#videosLoading))');
        let buttonsAdded = 0;
        
        videoRows.forEach(row => {
            // Verificar que la fila tiene celdas
            if (!row.cells || row.cells.length < 6) return;
            
            // Buscar la celda de acciones (última celda)
            const actionsCell = row.cells[row.cells.length - 1];
            if (!actionsCell) return;
            
            // Buscar el grupo de botones
            const btnGroup = actionsCell.querySelector('.btn-group');
            if (!btnGroup) return;
            
            // Verificar si ya existe un botón de reproducción para evitar duplicados
            if (btnGroup.querySelector('[data-play-button="true"]')) return;
            
            // Buscar el ID del video usando atributos data-*
            let videoId = row.getAttribute('data-video-id');
            
            // Si no hay data-video-id, intentar extraerlo de otros elementos
            if (!videoId) {
                // Intentar obtener de botones de edición o eliminación
                const actionBtn = btnGroup.querySelector('button[onclick*="Video("]');
                if (actionBtn) {
                    const match = actionBtn.getAttribute('onclick').match(/Video\((\d+)/);
                    if (match && match[1]) videoId = match[1];
                }
                
                // Intentar obtener de enlaces de descarga
                if (!videoId) {
                    const downloadLink = btnGroup.querySelector('a[href*="/videos/"]');
                    if (downloadLink) {
                        const match = downloadLink.href.match(/\/videos\/(\d+)/);
                        if (match && match[1]) videoId = match[1];
                    }
                }
            }
            
            // Si encontramos un ID, crear el botón de reproducción
            if (videoId) {
                // Crear el botón
                const playBtn = document.createElement('button');
                playBtn.className = 'btn btn-outline-primary btn-sm';
                playBtn.innerHTML = '<i class="fas fa-play"></i>';
                playBtn.title = 'Reproducir video';
                playBtn.setAttribute('data-play-button', 'true');
                
                // Usar una función anónima para evitar problemas con el ámbito de las variables
                playBtn.onclick = function() {
                    playVideo(videoId);
                };
                
                // Insertar al principio del grupo de botones
                btnGroup.insertBefore(playBtn, btnGroup.firstChild);
                buttonsAdded++;
            }
        });
        
        console.log(`Proceso completado: ${buttonsAdded} botones de reproducción añadidos`);
    } catch (error) {
        console.error('Error al añadir botones de reproducción:', error);
    } finally {
        window.isAddingPlayButtons = false;
    }
}


        // Observador para detectar cambios en la tabla y añadir botones
        function setupTableObserver() {
            // Evitar inicializar múltiples observadores
            if (window.tableObserverSetup) return;
            window.tableObserverSetup = true;
            
            // Seleccionar el contenedor de la tabla
            const tableContainer = document.getElementById('videosList');
            if (!tableContainer) return;
            
            console.log('Configurando observador de tabla para botones de reproducción...');
            
            // Configurar un observador para detectar cambios en la tabla
            const observer = new MutationObserver(function(mutations) {
                // Solo procesar los cambios si no estamos ya añadiendo botones
                if (!window.isAddingPlayButtons) {
                    // Esperar un poco para asegurarse de que todos los cambios se han aplicado
                    setTimeout(addPlayButtonsToVideoTable, 100);
                }
            });
            
            // Iniciar la observación
            observer.observe(tableContainer, { 
                childList: true, 
                subtree: true,
                attributes: false,
                characterData: false
            });
            
            // También intentar añadir botones inmediatamente por si la tabla ya está cargada
            setTimeout(addPlayButtonsToVideoTable, 500);
        }
        
        // Inicializar cuando el DOM esté listo
        document.addEventListener('DOMContentLoaded', function() {
            console.log('Videos V2 - Inicializando...');
            
            // Configurar el observador de la tabla una sola vez
            setupTableObserver();
            
            // Esperar a que main.js esté completamente cargado
            setTimeout(() => {
                // Verificar que las funciones principales estén disponibles
                if (typeof window.loadVideos === 'function') {
                    console.log('Funciones de main.js disponibles, cargando videos...');
                    window.loadVideos();
                } else {
                    console.warn('main.js no está completamente cargado, reintentando...');
                    setTimeout(() => {
                        if (typeof window.loadVideos === 'function') {
                            window.loadVideos();
                        } else {
                            console.error('main.js no se pudo cargar correctamente');
                        }
                    }, 1000);
                }
            }, 300);
        });
        
        console.log('Videos V2 template cargado - main.js manejará la funcionalidad');
    </script>
{% endblock %}