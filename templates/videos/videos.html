{% extends "base.html" %}

{% block content %}
    <div class="container-fluid px-3 py-4" style="max-width: auto; width: auto;">  
        <!-- Formulario de subida de videos -->
        <div class="row mb-4">
            <div class="col-md-12">
                <div class="card">
                    <div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pb-2 mb-3 border-bottom">
                        <h1 class="h2">
                            <i class="fas fa-film text-primary"></i>
                            Gestión Videos
                        </h1>
                        <button type="button" class="btn btn-primary" data-bs-toggle="collapse" data-bs-target="#uploadForm">
                            <i class="fas fa-plus"></i> Mostrar/Ocultar
                        </button>
                    </div>
                    <div id="uploadForm" class="collapse">
                        <div class="card-body">
                            <form id="videoUploadForm">
                                <div class="mb-3">
                                    <label for="videoTitle" class="form-label">Título</label>
                                    <input type="text" class="form-control" id="videoTitle" name="title" required>
                                </div>
                                <div class="mb-3">
                                    <label for="videoDescription" class="form-label">Descripción</label>
                                    <textarea class="form-control" id="videoDescription" name="description" rows="3"></textarea>
                                </div>
                                <div class="mb-3">
                                    <label for="videoExpiration" class="form-label">Fecha de Expiración (opcional)</label>
                                    <input type="datetime-local" class="form-control" id="videoExpiration" name="expiration_date">
                                </div>
                                <div class="mb-3">
                                    <label for="videoFile" class="form-label">Archivo de Video</label>
                                    <input type="file" class="form-control" id="videoFile" name="file" accept="video/*" required>
                                </div>
                                <div class="mb-3">
                                    <div class="progress d-none" id="uploadProgress" style="height: 25px;">
                                        <div class="progress-bar" role="progressbar" style="width: 0%; font-size: 1rem;" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100">0%</div>
                                    </div>
                                </div>
                                <button type="submit" class="btn btn-primary btn-lg">Subir Video</button>
                            </form>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Controles de búsqueda y filtros -->
        <div class="row mb-3">
            <div class="col-md-6">
                <div class="input-group">
                    <input type="text" id="videoSearchInput" class="form-control" placeholder="Buscar videos por título o descripción...">
                    <button class="btn btn-outline-primary" type="button" id="clearVideoSearch">
                        <i class="fas fa-times"></i> Limpiar
                    </button>
                </div>
            </div>
            <div class="col-md-3">
                <select class="form-select" id="videoFilterExpiration">
                    <option value="all">Todos los videos</option>
                    <option value="active">Videos activos</option>
                    <option value="expired">Videos expirados</option>
                </select>
            </div>
            <div class="col-md-3">
                <select class="form-select" id="videoPageSizeSelect">
                    <option value="25" selected>25 por página</option>
                    <option value="50">50 por página</option>
                    <option value="100">100 por página</option>
                    <option value="200">200 por página</option>
                    <option value="500">Todos los videos</option>
                </select>
            </div>
        </div>

        <!-- Información de resultados y paginación superior -->
        <div class="row mb-2">
            <div class="col-md-6">
                <span id="videoCountBadge" class="badge bg-info fs-6">0 videos</span>
            </div>
            <div class="col-md-6 text-end">
                <small class="text-muted" id="videoPaginationInfo">
                    Mostrando 0 - 0 de 0 resultados
                </small>
            </div>
        </div>

        <!-- Tabla de videos con paginación -->
        <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5 class="mb-0">
                    <i class="fas fa-video me-2"></i>Biblioteca de Videos
                </h5>
                <div class="d-flex align-items-center">
                    <button class="btn btn-sm btn-outline-secondary me-2" 
                            id="firstVideoPageBtn" 
                            onclick="goToFirstVideoPage()" 
                            title="Primera página">
                        <i class="fas fa-angle-double-left"></i>
                    </button>
                    <button class="btn btn-sm btn-outline-secondary me-2" 
                            id="prevVideoPageBtn" 
                            onclick="goToPrevVideoPage()" 
                            title="Página anterior">
                        <i class="fas fa-angle-left"></i>
                    </button>
                    <span class="me-2">Página</span>
                    <input type="number" 
                           id="videoPageInput" 
                           class="form-control form-control-sm me-2" 
                           style="width: 70px;" 
                           min="1" 
                           value="1"
                           onchange="goToVideoPage(this.value)">
                    <button class="btn btn-sm btn-outline-secondary me-2" 
                            id="nextVideoPageBtn" 
                            onclick="goToNextVideoPage()" 
                            title="Página siguiente">
                        <i class="fas fa-angle-right"></i>
                    </button>
                    <button class="btn btn-sm btn-outline-secondary" 
                            id="lastVideoPageBtn" 
                            onclick="goToLastVideoPage()" 
                            title="Última página">
                        <i class="fas fa-angle-double-right"></i>
                    </button>
                    <small class="text-muted ms-2">de <span id="totalVideoPages">1</span></small>
                </div>
            </div>
            <div class="card-body p-0">
                <div class="table-responsive" style="min-height: 300px;">
                    <table class="table table-striped table-hover mb-0" id="videosTable">
                        <thead class="table-dark">
                            <tr>
                                <th>
                                    <button class="btn btn-link text-white text-decoration-none p-0" 
                                            onclick="sortVideoTable('title')" 
                                            title="Ordenar por título">
                                        Título <i class="fas fa-sort ms-1"></i>
                                    </button>
                                </th>
                                <th>Descripción</th>
                                <th>
                                    <button class="btn btn-link text-white text-decoration-none p-0" 
                                            onclick="sortVideoTable('upload_date')" 
                                            title="Ordenar por fecha de subida">
                                        Subida <i class="fas fa-sort ms-1"></i>
                                    </button>
                                </th>
                                <th>
                                    <button class="btn btn-link text-white text-decoration-none p-0" 
                                            onclick="sortVideoTable('expiration_date')" 
                                            title="Ordenar por fecha de expiración">
                                        Expiración <i class="fas fa-sort ms-1"></i>
                                    </button>
                                </th>
                                <th>Estado</th>
                                <th>Acciones</th>
                            </tr>
                        </thead>
                        <tbody id="videosList">
                            <tr>
                                <td colspan="6" class="text-center py-3" id="videosLoading">
                                    <div class="spinner-border text-primary" role="status">
                                        <span class="visually-hidden">Cargando...</span>
                                    </div>
                                    <p class="mt-2">Cargando videos...</p>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
            <div class="card-footer">
                <div class="d-flex justify-content-between align-items-center">
                    <small class="text-muted" id="videoPaginationFooter">
                        Página 1 de 1 <span class="text-primary">(0-0 de 0)</span>
                    </small>
                    <div>
                        <button class="btn btn-sm btn-outline-secondary me-1" onclick="goToFirstVideoPage()">
                            <i class="fas fa-angle-double-left"></i>
                        </button>
                        <button class="btn btn-sm btn-outline-secondary me-1" onclick="goToPrevVideoPage()">
                            <i class="fas fa-angle-left"></i>
                        </button>
                        <button class="btn btn-sm btn-outline-secondary me-1" onclick="goToNextVideoPage()">
                            <i class="fas fa-angle-right"></i>
                        </button>
                        <button class="btn btn-sm btn-outline-secondary" onclick="goToLastVideoPage()">
                            <i class="fas fa-angle-double-right"></i>
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal para editar video -->
    <div class="modal fade" id="editVideoModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Editar Video</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form id="editVideoForm">
                        <input type="hidden" id="editVideoId">
                        <div class="mb-3">
                            <label for="editVideoTitle" class="form-label">Título</label>
                            <input type="text" class="form-control" id="editVideoTitle" required>
                        </div>
                        <div class="mb-3">
                            <label for="editVideoDescription" class="form-label">Descripción</label>
                            <textarea class="form-control" id="editVideoDescription" rows="3"></textarea>
                        </div>
                        <div class="mb-3">
                            <label for="editVideoExpiration" class="form-label">Fecha de Expiración (opcional)</label>
                            <input type="datetime-local" class="form-control" id="editVideoExpiration">
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary btn-lg" data-bs-dismiss="modal">Cancelar</button>
                    <button type="button" class="btn btn-primary btn-lg" id="saveVideoChangesBtn">Guardar Cambios</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal para reproducir video -->
    <div class="modal fade" id="playVideoModal" tabindex="-1" aria-labelledby="playVideoModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-xl">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="playVideoModalLabel">Reproduciendo: <span id="playingVideoTitle"></span></h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body p-0">
                    <div class="ratio ratio-16x9">
                        <video id="videoPlayer" class="w-100" controls autoplay controlsList="nodownload">
                            <source src="" type="video/mp4" id="videoSource">
                            Tu navegador no soporta la reproducción de videos HTML5.
                        </video>
                    </div>
                    <div class="bg-light p-3">
                        <div class="d-flex justify-content-between align-items-center">
                            <div>
                                <button class="btn btn-sm btn-outline-secondary" onclick="document.getElementById('videoPlayer').playbackRate = 0.5;">
                                    <i class="fas fa-backward"></i> 0.5x
                                </button>
                                <button class="btn btn-sm btn-outline-secondary" onclick="document.getElementById('videoPlayer').playbackRate = 1;">
                                    <i class="fas fa-sync"></i> 1x
                                </button>
                                <button class="btn btn-sm btn-outline-secondary" onclick="document.getElementById('videoPlayer').playbackRate = 1.5;">
                                    <i class="fas fa-forward"></i> 1.5x
                                </button>
                                <button class="btn btn-sm btn-outline-secondary" onclick="document.getElementById('videoPlayer').playbackRate = 2;">
                                    <i class="fas fa-fast-forward"></i> 2x
                                </button>
                            </div>
                            <div id="videoInfo">
                                <span class="badge bg-secondary" id="videoDuration">
                                    <i class="fas fa-clock"></i> Duración: <span id="videoDurationValue">--:--</span>
                                </span>
                                <span class="badge bg-info" id="videoSize">
                                    <i class="fas fa-hdd"></i> Tamaño: <span id="videoSizeValue">-- MB</span>
                                </span>
                            </div>
                        </div>
                        <div class="mt-3">
                            <h6>Descripción:</h6>
                            <p id="playingVideoDescription" class="mb-0 text-muted">Sin descripción</p>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cerrar</button>
                    <a id="downloadVideoBtn" href="#" class="btn btn-primary" download>
                        <i class="fas fa-download"></i> Descargar Video
                    </a>
                </div>
            </div>
        </div>
    </div>
{% endblock %}

{% block extra_scripts %}
    <style>
        .table th button {
            border: none !important;
            background: none !important;
            font-weight: bold !important;
            color: inherit !important;
        }
        .table th button:hover {
            background-color: rgba(255, 255, 255, 0.1) !important;
            color: inherit !important;
        }
        .table th button:focus {
            box-shadow: none !important;
            color: inherit !important;
        }
        .table-warning {
            --bs-table-bg: #fff3cd;
        }
    </style>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.0/js/bootstrap.bundle.min.js"></script>
    <script src="/static/js/main.js"></script>
    
    <script>
        // Función para abrir el modal y reproducir el video
        function playVideo(videoId, videoTitle, videoDescription) {
            // Actualizar datos en el modal
            document.getElementById('playingVideoTitle').textContent = videoTitle || 'Sin título';
            document.getElementById('playingVideoDescription').textContent = videoDescription || 'Sin descripción';
            
            // Configurar la fuente del video
            const videoSource = document.getElementById('videoSource');
            videoSource.src = `/api/videos/${videoId}/stream`;
            
            // Configurar el botón de descarga
            const downloadBtn = document.getElementById('downloadVideoBtn');
            downloadBtn.href = `/api/videos/${videoId}/download`;
            downloadBtn.download = videoTitle || `video_${videoId}`;
            
            // Reiniciar el reproductor
            const videoPlayer = document.getElementById('videoPlayer');
            videoPlayer.load();
            
            // Cargar información adicional del video
            fetchVideoInfo(videoId);
            
            // Abrir el modal
            const modal = new bootstrap.Modal(document.getElementById('playVideoModal'));
            modal.show();
            
            // Configurar evento de cierre del modal para detener el video
            document.getElementById('playVideoModal').addEventListener('hidden.bs.modal', function () {
                videoPlayer.pause();
                videoSource.src = '';
            });
        }
        
        // Función para obtener información adicional del video
        async function fetchVideoInfo(videoId) {
            try {
                const response = await fetch(`/api/videos/${videoId}`);
                if (!response.ok) throw new Error('No se pudo obtener información del video');
                
                const videoData = await response.json();
                
                // Actualizar duración
                if (videoData.duration) {
                    const durationElement = document.getElementById('videoDurationValue');
                    durationElement.textContent = formatDuration(videoData.duration);
                }
                
                // Actualizar tamaño
                if (videoData.file_size) {
                    const sizeElement = document.getElementById('videoSizeValue');
                    sizeElement.textContent = formatFileSize(videoData.file_size);
                }
            } catch (error) {
                console.error('Error al obtener información del video:', error);
            }
        }
        
        // Función para formatear la duración
        function formatDuration(seconds) {
            if (!seconds) return '--:--';
            
            const hours = Math.floor(seconds / 3600);
            const minutes = Math.floor((seconds % 3600) / 60);
            const secs = Math.floor(seconds % 60);
            
            if (hours > 0) {
                return `${hours.toString().padStart(2, '0')}:${minutes.toString().padStart(2, '0')}:${secs.toString().padStart(2, '0')}`;
            } else {
                return `${minutes.toString().padStart(2, '0')}:${secs.toString().padStart(2, '0')}`;
            }
        }
        
        // Función para formatear el tamaño del archivo
        function formatFileSize(bytes) {
            if (!bytes) return '-- MB';
            
            const units = ['B', 'KB', 'MB', 'GB'];
            let size = bytes;
            let unitIndex = 0;
            
            while (size >= 1024 && unitIndex < units.length - 1) {
                size /= 1024;
                unitIndex++;
            }
            
            return `${size.toFixed(2)} ${units[unitIndex]}`;
        }
        
        // Modificar la función original displayVideos para incluir el botón de reproducción
        window.originalDisplayVideos = window.displayVideos || function() {
            console.log('Función displayVideos original no encontrada');
        };
        
        // Reemplazar con nuestra función mejorada que AÑADE el botón de reproducción
        // sin quitar los botones existentes
        window.displayVideos = function(videos) {
            const videosList = document.getElementById('videosList');
            if (!videosList) return;
            
            if (!videos || videos.length === 0) {
                videosList.innerHTML = `
                    <tr>
                        <td colspan="6" class="text-center py-4">
                            <i class="fas fa-film fa-3x mb-3 text-muted"></i>
                            <p>No se encontraron videos.</p>
                        </td>
                    </tr>
                `;
                return;
            }
            
            const videosHTML = videos.map(video => {
                const isExpired = video.expiration_date && new Date(video.expiration_date) < new Date();
                
                return `
                    <tr ${isExpired ? 'class="table-warning"' : ''}>
                        <td>${video.title || 'Sin título'}</td>
                        <td>${video.description || '<span class="text-muted">Sin descripción</span>'}</td>
                        <td><small>${formatDate(video.upload_date)}</small></td>
                        <td>
                            ${video.expiration_date ? 
                                `<small class="text-${isExpired ? 'danger' : 'muted'}">${isExpired ? 'Expiró' : 'Expira'}: ${formatDate(video.expiration_date)}</small>` : 
                                '<small class="text-muted">Sin expiración</small>'}
                        </td>
                        <td>
                            <span class="badge ${isExpired ? 'bg-danger' : 'bg-success'}">
                                ${isExpired ? 'Expirado' : 'Activo'}
                            </span>
                        </td>
                        <td>
                            <div class="btn-group btn-group-sm">
                                <!-- NUEVO: Botón de reproducción -->
                                <button class="btn btn-outline-primary" 
                                        onclick="playVideo(${video.id}, '${video.title?.replace(/'/g, "\\'")}', '${video.description?.replace(/'/g, "\\'")}')">
                                    <i class="fas fa-play"></i>
                                </button>
                                <!-- Botones existentes (mantenidos tal cual) -->
                                <a href="/api/videos/${video.id}/download" class="btn btn-outline-primary btn-sm">
                                    <i class="fas fa-download"></i>
                                </a>
                                <button class="btn btn-outline-secondary btn-sm" onclick="editVideo(${video.id})">
                                    <i class="fas fa-edit"></i>
                                </button>
                                <button class="btn btn-outline-danger btn-sm" onclick="deleteVideo(${video.id})">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </div>
                        </td>
                    </tr>
                `;
            }).join('');
            
            videosList.innerHTML = videosHTML;
        };
        
        // Función auxiliar para formatear fechas
        function formatDate(dateStr) {
            if (!dateStr) return '';
            const date = new Date(dateStr);
            return date.toLocaleString('es-ES', {
                year: 'numeric',
                month: '2-digit',
                day: '2-digit',
                hour: '2-digit',
                minute: '2-digit'
            });
        }
        
        // Inicializar funcionalidades de video al cargar la página
        document.addEventListener('DOMContentLoaded', function() {
            console.log('Videos V2 - Inicializando...');
            
            // Esperar a que main.js esté completamente cargado
            setTimeout(() => {
                // Verificar que las funciones principales estén disponibles
                if (typeof window.loadVideos === 'function') {
                    console.log('Funciones de main.js disponibles, cargando videos...');
                    window.loadVideos();
                } else {
                    console.warn('main.js no está completamente cargado, reintentando...');
                    setTimeout(() => {
                        if (typeof window.loadVideos === 'function') {
                            window.loadVideos();
                        } else {
                            console.error('main.js no se pudo cargar correctamente');
                        }
                    }, 1000);
                }
            }, 300);
        });
        
        console.log('Videos V2 template cargado - main.js manejará la funcionalidad');
    </script>
{% endblock %}