{% extends "base.html" %}

{% block title %}{{ title }}{% endblock %}

{% block extra_css %}
<style>
.user-management {
    padding: 2rem 0;
}

.search-filters {
    background: #f8f9fa;
    border-radius: 10px;
    padding: 1.5rem;
    margin-bottom: 2rem;
    border: 1px solid #dee2e6;
}

.user-card {
    transition: all 0.3s ease;
    border: 1px solid #dee2e6;
}

.user-card:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 15px rgba(0,0,0,0.1);
}

.stats-card {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
    border-radius: 15px;
    padding: 1.5rem;
    margin-bottom: 2rem;
}

.filter-button {
    min-width: 100px;
}

.debug-panel {
    background: #f1f3f4;
    border-left: 4px solid #34495e;
    padding: 1rem;
    margin: 1rem 0;
    border-radius: 5px;
    font-family: monospace;
    font-size: 0.9rem;
}

@media (max-width: 768px) {
    .search-filters .row > div {
        margin-bottom: 1rem;
    }
}
</style>
{% endblock %}

{% block content %}
<div class="container-fluid user-management">
    
    <!-- Encabezado -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center">
                <div>
                    <h1 class="h3 mb-2 text-primary">
                        <i class="fas fa-users me-2"></i>{{ title }}
                    </h1>
                    <p class="text-muted mb-0">
                        Gestiona usuarios del sistema 
                        {% if source == "ad" %}(Active Directory){% else %}(Locales){% endif %}
                    </p>
                </div>
                <div class="d-flex gap-2">
                    <button type="button" class="btn btn-outline-secondary" onclick="debugParams()" title="Debug parámetros">
                        <i class="fas fa-bug"></i>
                    </button>
                    <a href="/ui/users/create" class="btn btn-success">
                        <i class="fas fa-plus me-1"></i>Nuevo Usuario
                    </a>
                </div>
            </div>
        </div>
    </div>

    <!-- Estadísticas rápidas -->
    {% if users %}
    <div class="stats-card">
        <div class="row text-center">
            <div class="col-6 col-md-3">
                <div class="h4 mb-1">{{ users|length }}</div>
                <small>Usuarios mostrados</small>
            </div>
            <div class="col-6 col-md-3">
                <div class="h4 mb-1">{{ users|selectattr("is_active")|list|length }}</div>
                <small>Activos</small>
            </div>
            <div class="col-6 col-md-3">
                <div class="h4 mb-1">{{ users|selectattr("is_admin")|list|length }}</div>
                <small>Administradores</small>
            </div>
            <div class="col-6 col-md-3">
                <div class="h4 mb-1">{{ (users|length) - (users|selectattr("is_active")|list|length) }}</div>
                <small>Inactivos</small>
            </div>
        </div>
    </div>
    {% endif %}

    <!-- Filtros de búsqueda -->
    <div class="search-filters">
        <form id="searchForm" method="get">
            <div class="row g-3 align-items-end">
                <div class="col-md-4">
                    <label for="search" class="form-label">
                        <i class="fas fa-search me-1"></i>Buscar Usuario
                    </label>
                    <input type="text" class="form-control" id="search" name="search" 
                           value="{{ search or '' }}" 
                           placeholder="Nombre, email o usuario..."
                           autocomplete="off">
                </div>
                
                <div class="col-md-3">
                    <label for="is_active" class="form-label">
                        <i class="fas fa-filter me-1"></i>Estado
                    </label>
                    <select class="form-select" id="is_active" name="is_active">
                        <option value="">Todos los estados</option>
                        <option value="true" {{ 'selected' if is_active == True else '' }}>
                            Activos únicamente
                        </option>
                        <option value="false" {{ 'selected' if is_active == False else '' }}>
                            Inactivos únicamente
                        </option>
                    </select>
                </div>
                
                <div class="col-md-3">
                    <label for="auth_provider" class="form-label">
                        <i class="fas fa-key me-1"></i>Tipo de Usuario
                    </label>
                    <select class="form-select" id="auth_provider" name="auth_provider">
                        <option value="">Todos los tipos</option>
                        <option value="local" {{ 'selected' if auth_provider == "local" else '' }}>
                            Usuarios Locales
                        </option>
                        {% if ad_available %}
                        <option value="ad" {{ 'selected' if auth_provider == "ad" else '' }}>
                            Active Directory
                        </option>
                        {% endif %}
                    </select>
                </div>
                
                <div class="col-md-2">
                    <div class="d-flex gap-1">
                        <button type="submit" class="btn btn-primary filter-button" id="filterButton">
                            <i class="fas fa-search"></i> Filtrar
                        </button>
                        <button type="button" class="btn btn-outline-secondary" onclick="clearFilters()" title="Limpiar filtros">
                            <i class="fas fa-times"></i>
                        </button>
                    </div>
                </div>
            </div>
            
            <!-- Información de filtros activos -->
            {% set active_filters = [] %}
            {% if search %}{% set _ = active_filters.append("Búsqueda: " + search) %}{% endif %}
            {% if is_active == True %}{% set _ = active_filters.append("Estado: Activos") %}{% endif %}
            {% if is_active == False %}{% set _ = active_filters.append("Estado: Inactivos") %}{% endif %}
            {% if auth_provider %}{% set _ = active_filters.append("Tipo: " + auth_provider) %}{% endif %}
            
            {% if active_filters %}
            <div class="mt-2">
                <small class="text-muted">
                    <i class="fas fa-filter me-1"></i>Filtros activos: {{ active_filters|join(", ") }}
                </small>
            </div>
            {% endif %}
        </form>
    </div>

    <!-- Mensajes de error -->
    {% if error %}
    <div class="alert alert-danger">
        <i class="fas fa-exclamation-triangle me-2"></i>
        <strong>Error:</strong> {{ error }}
    </div>
    {% endif %}

    <!-- Acciones en lote (oculto por defecto) -->
    <div id="bulkActions" class="alert alert-info" style="display: none;">
        <div class="d-flex justify-content-between align-items-center">
            <span>
                <i class="fas fa-check-square me-2"></i>
                <span id="selectedCount">0</span> usuario(s) seleccionado(s)
            </span>
            <div class="btn-group btn-group-sm">
                <button class="btn btn-outline-primary" onclick="exportUsers('csv')">
                    <i class="fas fa-download me-1"></i>Exportar CSV
                </button>
                <button class="btn btn-outline-success" onclick="exportUsers('json')">
                    <i class="fas fa-download me-1"></i>Exportar JSON
                </button>
                <button class="btn btn-outline-secondary" onclick="deselectAllUsers()">
                    <i class="fas fa-times me-1"></i>Deseleccionar
                </button>
            </div>
        </div>
    </div>

    <!-- Lista de usuarios -->
    {% if users %}
    <div class="card">
        <div class="card-header d-flex justify-content-between align-items-center">
            <h5 class="mb-0">
                <i class="fas fa-list me-2"></i>Lista de Usuarios ({{ users|length }})
            </h5>
            <div class="btn-group btn-group-sm">
                <button class="btn btn-outline-secondary" onclick="selectAllUsers()">
                    <i class="fas fa-check-double me-1"></i>Seleccionar Todos
                </button>
                <button class="btn btn-outline-primary" onclick="exportUsers('csv')">
                    <i class="fas fa-file-csv me-1"></i>CSV
                </button>
                <button class="btn btn-outline-success" onclick="exportUsers('json')">
                    <i class="fas fa-file-code me-1"></i>JSON
                </button>
            </div>
        </div>
        
        <div class="table-responsive">
            <table class="table table-hover align-middle mb-0">
                <thead class="table-light">
                    <tr>
                        <th style="width: 40px;">
                            <input type="checkbox" class="form-check-input" onchange="toggleAllUsers(this)">
                        </th>
                        <th>Usuario</th>
                        <th>Email</th>
                        <th>Nombre Completo</th>
                        <th>Estado</th>
                        <th>Tipo</th>
                        <th>Último Login</th>
                        <th>Acciones</th>
                    </tr>
                </thead>
                <tbody>
                    {% for user in users %}
                    <tr>
                        <td>
                            <input type="checkbox" class="form-check-input user-checkbox" value="{{ user.id }}">
                        </td>
                        <td>
                            <div class="d-flex align-items-center">
                                <div class="avatar bg-primary text-white rounded-circle me-2 d-flex align-items-center justify-content-center" style="width: 32px; height: 32px; font-size: 14px;">
                                    {{ user.username[0].upper() }}
                                </div>
                                <div>
                                    <strong>{{ user.username }}</strong>
                                    {% if user.is_admin %}
                                        <span class="badge bg-warning text-dark ms-1" title="Administrador">
                                            <i class="fas fa-crown"></i>
                                        </span>
                                    {% endif %}
                                </div>
                            </div>
                        </td>
                        <td>{{ user.email or '-' }}</td>
                        <td>{{ user.fullname or '-' }}</td>
                        <td>
                            {% if user.is_active %}
                                <span class="badge bg-success">
                                    <i class="fas fa-check me-1"></i>Activo
                                </span>
                            {% else %}
                                <span class="badge bg-secondary">
                                    <i class="fas fa-times me-1"></i>Inactivo
                                </span>
                            {% endif %}
                        </td>
                        <td>
                            {% if user.auth_provider == 'ad' %}
                                <span class="badge bg-info">
                                    <i class="fas fa-building me-1"></i>AD
                                </span>
                            {% else %}
                                <span class="badge bg-primary">
                                    <i class="fas fa-user me-1"></i>Local
                                </span>
                            {% endif %}
                        </td>
                        <td>
                            <small class="text-muted">
                                {{ user.last_login.strftime('%d/%m/%Y %H:%M') if user.last_login else 'Nunca' }}
                            </small>
                        </td>
                        <td>
                            <div class="btn-group btn-group-sm">
                                <a href="/ui/users/{{ user.id }}/edit" class="btn btn-outline-primary" title="Editar">
                                    <i class="fas fa-edit"></i>
                                </a>
                                <button class="btn btn-outline-info" onclick="viewUserDetails({{ user.id }})" title="Ver detalles">
                                    <i class="fas fa-eye"></i>
                                </button>
                                {% if not user.is_admin or current_user.id != user.id %}
                                <button class="btn btn-outline-danger" onclick="confirmDeleteUser({{ user.id }}, '{{ user.username }}')" title="Eliminar">
                                    <i class="fas fa-trash"></i>
                                </button>
                                {% endif %}
                            </div>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
    {% else %}
    <!-- Sin usuarios -->
    <div class="card">
        <div class="card-body text-center py-5">
            <i class="fas fa-users fa-3x text-muted mb-3"></i>
            <h4 class="text-muted">No se encontraron usuarios</h4>
            <p class="text-muted">
                {% if search or is_active is not none or auth_provider %}
                    No hay usuarios que coincidan con los filtros aplicados.
                    <br><small>Prueba ajustar los criterios de búsqueda.</small>
                {% else %}
                    No hay usuarios registrados en el sistema.
                {% endif %}
            </p>
            <div class="mt-3">
                {% if search or is_active is not none or auth_provider %}
                <button class="btn btn-outline-primary" onclick="clearFilters()">
                    <i class="fas fa-times me-1"></i>Limpiar Filtros
                </button>
                {% endif %}
                <a href="/ui/users/create" class="btn btn-success ms-2">
                    <i class="fas fa-plus me-1"></i>Crear Primer Usuario
                </a>
            </div>
        </div>
    </div>
    {% endif %}

    <!-- Panel de debug (solo visible en desarrollo) -->
    {% if request.app.debug %}
    <div class="debug-panel mt-4">
        <strong>🐛 Debug Info:</strong>
        <br>Search: "{{ search or 'None' }}"
        <br>Is Active: {{ is_active if is_active is not none else 'None' }}
        <br>Auth Provider: "{{ auth_provider or 'None' }}"
        <br>Source: "{{ source or 'local' }}"
        <br>Users Found: {{ users|length if users else 0 }}
        <br>Query String: "{{ request.url.query }}"
    </div>
    {% endif %}

</div>

<!-- Modal para detalles de usuario -->
<div class="modal fade" id="userDetailsModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="fas fa-user me-2"></i>Detalles del Usuario
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body" id="userDetailsContent">
                <div class="text-center">
                    <i class="fas fa-spinner fa-spin fa-2x"></i>
                    <p class="mt-2">Cargando información...</p>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Toast container para notificaciones -->
<div id="toast-container"></div>

{% endblock %}

{% block extra_scripts %}
<!-- Aquí va el JavaScript corregido que proporcioné anteriormente -->
<script>
// Colocar aquí todo el JavaScript del artifact anterior "users_html_fix"
// Por brevedad no lo repito, pero debe incluirse completo
</script>

<!-- Funciones adicionales específicas del template -->
<script>
// Función para toggle de todos los checkboxes
function toggleAllUsers(masterCheckbox) {
    const userCheckboxes = document.querySelectorAll('.user-checkbox');
    userCheckboxes.forEach(cb => cb.checked = masterCheckbox.checked);
    updateBulkActions();
}

// Función para ver detalles de usuario
async function viewUserDetails(userId) {
    const modal = new bootstrap.Modal(document.getElementById('userDetailsModal'));
    const content = document.getElementById('userDetailsContent');
    
    modal.show();
    
    try {
        const response = await fetch(`/ui/users/api/${userId}`);
        const user = await response.json();
        
        content.innerHTML = `
            <div class="row">
                <div class="col-md-6">
                    <h6>Información Básica</h6>
                    <table class="table table-sm">
                        <tr><td><strong>ID:</strong></td><td>${user.id}</td></tr>
                        <tr><td><strong>Usuario:</strong></td><td>${user.username}</td></tr>
                        <tr><td><strong>Email:</strong></td><td>${user.email || '-'}</td></tr>
                        <tr><td><strong>Nombre:</strong></td><td>${user.fullname || '-'}</td></tr>
                    </table>
                </div>
                <div class="col-md-6">
                    <h6>Estado y Permisos</h6>
                    <table class="table table-sm">
                        <tr><td><strong>Activo:</strong></td><td>${user.is_active ? 'Sí' : 'No'}</td></tr>
                        <tr><td><strong>Admin:</strong></td><td>${user.is_admin ? 'Sí' : 'No'}</td></tr>
                        <tr><td><strong>Tipo:</strong></td><td>${user.auth_provider || 'Local'}</td></tr>
                        <tr><td><strong>Creado:</strong></td><td>${user.created_at ? new Date(user.created_at).toLocaleString() : '-'}</td></tr>
                    </table>
                </div>
            </div>
        `;
    } catch (error) {
        content.innerHTML = `
            <div class="alert alert-danger">
                <i class="fas fa-exclamation-triangle me-2"></i>
                Error cargando información del usuario: ${error.message}
            </div>
        `;
    }
}

// Función para confirmar eliminación
function confirmDeleteUser(userId, username) {
    if (confirm(`¿Estás seguro de que quieres eliminar al usuario "${username}"?\n\nEsta acción no se puede deshacer.`)) {
        deleteUser(userId);
    }
}

// Función para eliminar usuario
async function deleteUser(userId) {
    try {
        setButtonLoading('filterButton', true);
        
        const response = await fetch(`/ui/users/api/${userId}`, {
            method: 'DELETE',
            headers: {
                'Content-Type': 'application/json',
            }
        });
        
        if (response.ok) {
            showToast('Usuario eliminado correctamente', 'success');
            // Recargar la página después de un breve delay
            setTimeout(() => window.location.reload(), 1000);
        } else {
            const error = await response.json();
            showToast(`Error eliminando usuario: ${error.detail}`, 'danger');
        }
    } catch (error) {
        showToast(`Error: ${error.message}`, 'danger');
    } finally {
        setButtonLoading('filterButton', false);
    }
}
</script>
{% endblock %}